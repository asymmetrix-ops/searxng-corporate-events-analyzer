<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SearXNG ‚Äì Events UI (No Streamlit)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #050816;
        --bg-card: #0b1020;
        --bg-pill: #111827;
        --accent: #6366f1;
        --accent-soft: #4f46e5;
        --accent-danger: #ef4444;
        --accent-success: #10b981;
        --border-subtle: #1f2937;
        --text: #e5e7eb;
        --muted: #9ca3af;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
        color: var(--text);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          sans-serif;
      }

      .shell {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
      }

      .title-block h1 {
        font-size: 24px;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .title-block p {
        margin: 4px 0 0;
        font-size: 13px;
        color: var(--muted);
      }

      .badge {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 118, 110, 0.15);
        color: #5eead4;
        border: 1px solid rgba(45, 212, 191, 0.35);
      }

      .panel {
        background: rgba(15, 23, 42, 0.95);
        border-radius: 18px;
        padding: 16px 18px 14px;
        box-shadow: 0 10px 40px rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(55, 65, 81, 0.85);
        backdrop-filter: blur(16px);
      }

      .input-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 4px;
      }

      .chip {
        font-size: 11px;
        padding: 2px 9px;
        border-radius: 999px;
        background: var(--bg-pill);
        color: var(--muted);
        border: 1px solid #1f2937;
      }

      input[type="text"] {
        flex: 1;
        padding: 9px 11px;
        border-radius: 999px;
        border: 1px solid #1e293b;
        background: radial-gradient(circle at top left, #020617, #020617 55%, #020617);
        color: var(--text);
        font-size: 13px;
        outline: none;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      }

      input[type="text"]::placeholder {
        color: #4b5563;
      }

      button.primary {
        padding: 8px 18px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.55);
        transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
      }

      button.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 34px rgba(79, 70, 229, 0.7);
      }

      button.primary:disabled {
        opacity: 0.5;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      .hint-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-top: 4px;
      }

      .hint-row small {
        color: var(--muted);
        font-size: 11px;
      }

      .hint-row code {
        background: rgba(15, 23, 42, 0.85);
        border-radius: 999px;
        padding: 2px 8px;
        border: 1px solid #1f2937;
      }

      .split {
        display: grid;
        grid-template-columns: 1.15fr 1fr;
        gap: 18px;
        margin-top: 20px;
      }

      .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .pill {
        font-size: 11px;
        padding: 3px 9px;
        border-radius: 999px;
        background: #020617;
        border: 1px solid #111827;
        color: #9ca3af;
      }

      .events-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .event-card {
        border-radius: 14px;
        padding: 10px 11px;
        background: radial-gradient(circle at top left, #020617 0, #020617 47%, #020617 100%);
        border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .event-title-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: flex-start;
      }

      .event-title {
        font-size: 13px;
        font-weight: 600;
      }

      .event-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
        font-size: 11px;
        color: var(--muted);
      }

      .tag {
        padding: 2px 7px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid #1f2937;
      }

      .log-panel {
        margin-top: 16px;
        border-radius: 12px;
        background: #020617;
        border: 1px solid #1f2937;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        max-height: 180px;
        overflow-y: auto;
        padding: 8px 9px;
      }

      .log-line {
        margin: 1px 0;
      }

      .log-line.info {
        color: #93c5fd;
      }

      .log-line.warn {
        color: #fbbf24;
      }

      .log-line.ok {
        color: #6ee7b7;
      }

      .log-line.err {
        color: #fca5a5;
      }

      .empty-state {
        font-size: 12px;
        color: var(--muted);
        padding: 10px 8px;
      }

      .source-link {
        font-size: 11px;
        color: #93c5fd;
        text-decoration: none;
      }

      .source-link:hover {
        text-decoration: underline;
      }

      @media (max-width: 900px) {
        .split {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="header">
        <div class="title-block">
          <h1>
            üß≠ SearXNG
            <span style="font-weight: 500; opacity: 0.8"
              >‚Äì Corporate Events Console</span
            >
          </h1>
          <p>
            Side‚Äëby‚Äëside AI vs Database comparison with
            <strong>non‚Äërefreshing</strong> ‚ÄúAdd to DB‚Äù buttons.
          </p>
        </div>
        <div class="badge">beta ‚Äì fastapi ui (no streamlit)</div>
      </header>

      <section class="panel">
        <div class="input-row">
          <span class="chip">1</span>
          <input
            id="queryInput"
            type="text"
            placeholder="Enter company URL or name, e.g. https://heliointelligence.com/"
          />
          <button id="analyzeBtn" class="primary">
            <span>üöÄ Analyze</span>
          </button>
        </div>
        <div class="hint-row">
          <small
            >If the URL exists in Xano, we‚Äôll fetch DB events and compare to AI
            events.</small
          >
          <small>AI limited to <code>1</code> corporate event for testing.</small>
        </div>
      </section>

      <!-- Company Overview -->
      <section class="split" style="margin-top: 18px; margin-bottom: 8px">
        <div>
          <div class="column-header">
            <div>
              <strong>ü§ñ AI Company Overview</strong>
              <span id="aiOverviewMeta" class="pill">Waiting for query‚Ä¶</span>
            </div>
          </div>
          <div id="aiOverview" class="events-list">
            <div class="empty-state">
              Run an analysis to populate AI‚Äëgenerated company overview here.
            </div>
          </div>
        </div>
        <div>
          <div class="column-header">
            <div>
              <strong>üóÑÔ∏è Database Company Overview</strong>
              <span id="dbOverviewMeta" class="pill">No company loaded</span>
            </div>
          </div>
          <div id="dbOverview" class="events-list">
            <div class="empty-state">
              If the company exists in Xano, its overview will appear here.
            </div>
          </div>
        </div>
      </section>

      <!-- Events -->
      <section class="split">
        <!-- AI Column -->
        <div>
          <div class="column-header">
            <div>
              <strong>ü§ñ AI Events</strong>
              <span id="aiMeta" class="pill">Waiting for query‚Ä¶</span>
            </div>
          </div>
          <div id="aiEvents" class="events-list">
            <div class="empty-state">
              Run an analysis to see AI‚Äëdiscovered corporate events here.
            </div>
          </div>
        </div>

        <!-- DB Column -->
        <div>
          <div class="column-header">
            <div>
              <strong>üóÑÔ∏è Database (Xano)</strong>
              <span id="dbMeta" class="pill">No company loaded</span>
            </div>
          </div>
          <div id="dbEvents" class="events-list">
            <div class="empty-state">
              If the company exists in Xano, its events will appear here.
            </div>
          </div>
        </div>
      </section>

      <section style="margin-top: 18px">
        <div class="column-header">
          <div>
            <strong>üì° API Log</strong>
          </div>
          <span class="pill" id="statusPill">Idle</span>
        </div>
        <div id="log" class="log-panel"></div>
      </section>
    </div>

    <script>
      const analyzeBtn = document.getElementById("analyzeBtn");
      const queryInput = document.getElementById("queryInput");
      const aiEventsEl = document.getElementById("aiEvents");
      const dbEventsEl = document.getElementById("dbEvents");
      const aiMetaEl = document.getElementById("aiMeta");
      const dbMetaEl = document.getElementById("dbMeta");
      const aiOverviewEl = document.getElementById("aiOverview");
      const dbOverviewEl = document.getElementById("dbOverview");
      const aiOverviewMeta = document.getElementById("aiOverviewMeta");
      const dbOverviewMeta = document.getElementById("dbOverviewMeta");
      const logEl = document.getElementById("log");
      const statusPill = document.getElementById("statusPill");

      const XANO_BASE = "{{ xano_base_url }}";

      // Deal / status options (mirrors Streamlit version)
      const DEAL_TYPES = [
        "",
        "Acquisition",
        "Sale",
        "IPO",
        "MBO",
        "Investment",
        "Strategic Review",
        "Divestment",
        "Restructuring",
        "Dual track",
        "Closing",
        "Grant",
        "Debt financing",
        "Bankruptcy",
        "Reorganisation",
        "Employee tender offer",
        "Rebrand",
        "Partnership",
      ];

      const DEAL_STATUSES = [
        "",
        "Completed",
        "In Market",
        "Not yet launched",
        "Strategic Review",
        "Deal Prep",
        "In Exclusivity",
        "Pending",
      ];

      function log(msg, level = "info") {
        const time = new Date().toLocaleTimeString();
        const div = document.createElement("div");
        div.className = `log-line ${level}`;
        div.textContent = `[${time}] ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function setStatus(text, tone = "info") {
        statusPill.textContent = text;
        if (tone === "ok") {
          statusPill.style.background = "rgba(5, 46, 22, 0.9)";
          statusPill.style.color = "#6ee7b7";
        } else if (tone === "err") {
          statusPill.style.background = "rgba(127, 29, 29, 0.9)";
          statusPill.style.color = "#fecaca";
        } else {
          statusPill.style.background = "#020617";
          statusPill.style.color = "#9ca3af";
        }
      }

      function clearEvents() {
        aiEventsEl.innerHTML = "";
        dbEventsEl.innerHTML = "";
        aiOverviewEl.innerHTML = "";
        dbOverviewEl.innerHTML = "";
      }

      function renderAIOverview(data) {
        aiOverviewEl.innerHTML = "";
        if (!data) {
          aiOverviewEl.innerHTML =
            '<div class="empty-state">No AI overview available.</div>';
          aiOverviewMeta.textContent = "No data";
          return;
        }
        aiOverviewMeta.textContent = "Editable";

        const card = document.createElement("div");
        card.className = "event-card";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.id = "ai_name";
        nameInput.value = data.name || "";
        nameInput.placeholder = "Company name";
        nameInput.style.width = "100%";
        nameInput.style.padding = "5px 8px";
        nameInput.style.borderRadius = "8px";
        nameInput.style.border = "1px solid #1f2937";
        nameInput.style.background = "#020617";
        nameInput.style.color = "#e5e7eb";
        nameInput.style.fontSize = "13px";

        const rowLoc = document.createElement("div");
        rowLoc.style.display = "flex";
        rowLoc.style.gap = "6px";
        rowLoc.style.marginTop = "6px";

        const cityInput = document.createElement("input");
        cityInput.type = "text";
        cityInput.id = "ai_city";
        cityInput.placeholder = "City";
        cityInput.value = data.city || "";
        cityInput.style.flex = "1";
        cityInput.style.padding = "3px 7px";
        cityInput.style.borderRadius = "999px";
        cityInput.style.border = "1px solid #1f2937";
        cityInput.style.background = "#020617";
        cityInput.style.color = "#e5e7eb";
        cityInput.style.fontSize = "11px";

        const countryInput = document.createElement("input");
        countryInput.type = "text";
        countryInput.id = "ai_country";
        countryInput.placeholder = "Country";
        countryInput.value = data.country || "";
        countryInput.style.flex = "1";
        countryInput.style.padding = "3px 7px";
        countryInput.style.borderRadius = "999px";
        countryInput.style.border = "1px solid #1f2937";
        countryInput.style.background = "#020617";
        countryInput.style.color = "#e5e7eb";
        countryInput.style.fontSize = "11px";

        rowLoc.appendChild(cityInput);
        rowLoc.appendChild(countryInput);

        const rowLinks = document.createElement("div");
        rowLinks.style.display = "flex";
        rowLinks.style.gap = "6px";
        rowLinks.style.marginTop = "6px";

        const websiteInput = document.createElement("input");
        websiteInput.type = "text";
        websiteInput.id = "ai_website";
        websiteInput.placeholder = "Website URL";
        websiteInput.value = data.website || "";
        websiteInput.style.flex = "1";
        websiteInput.style.padding = "3px 7px";
        websiteInput.style.borderRadius = "999px";
        websiteInput.style.border = "1px solid #1f2937";
        websiteInput.style.background = "#020617";
        websiteInput.style.color = "#e5e7eb";
        websiteInput.style.fontSize = "11px";

        const linkedinInput = document.createElement("input");
        linkedinInput.type = "text";
        linkedinInput.id = "ai_linkedin";
        linkedinInput.placeholder = "LinkedIn URL";
        linkedinInput.value = data.linkedin || "";
        linkedinInput.style.flex = "1";
        linkedinInput.style.padding = "3px 7px";
        linkedinInput.style.borderRadius = "999px";
        linkedinInput.style.border = "1px solid #1f2937";
        linkedinInput.style.background = "#020617";
        linkedinInput.style.color = "#e5e7eb";
        linkedinInput.style.fontSize = "11px";

        rowLinks.appendChild(websiteInput);
        rowLinks.appendChild(linkedinInput);

        const desc = document.createElement("textarea");
        desc.id = "ai_description";
        desc.value = data.description || "";
        desc.placeholder = "AI‚Äëgenerated description (editable)";
        desc.style.width = "100%";
        desc.style.marginTop = "6px";
        desc.style.minHeight = "70px";
        desc.style.padding = "5px 8px";
        desc.style.borderRadius = "8px";
        desc.style.border = "1px solid #1f2937";
        desc.style.background = "#020617";
        desc.style.color = "#e5e7eb";
        desc.style.fontSize = "12px";

        card.appendChild(nameInput);
        card.appendChild(rowLoc);
        card.appendChild(rowLinks);
        card.appendChild(desc);

        aiOverviewEl.appendChild(card);
      }

      function renderDBOverview(data) {
        dbOverviewEl.innerHTML = "";
        if (!data) {
          dbOverviewEl.innerHTML =
            '<div class="empty-state">No DB overview available.</div>';
          dbOverviewMeta.textContent = "No company";
          return;
        }
        dbOverviewMeta.textContent = "Loaded from Xano";

        const card = document.createElement("div");
        card.className = "event-card";

        const title = document.createElement("div");
        title.className = "event-title";
        title.textContent = data.name || "Unknown company";
        card.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "event-meta";
        const locPieces = [];
        if (data.city) locPieces.push(data.city);
        if (data.country) locPieces.push(data.country);
        if (locPieces.length) {
          const span = document.createElement("span");
          span.textContent = "üìç " + locPieces.join(", ");
          meta.appendChild(span);
        }
        if (data.ownership) {
          const span = document.createElement("span");
          span.textContent = data.ownership;
          meta.appendChild(span);
        }
        card.appendChild(meta);

        const links = document.createElement("div");
        links.className = "event-meta";
        if (data.website) {
          const a = document.createElement("a");
          a.href = data.website;
          a.target = "_blank";
          a.textContent = "üåê Website";
          a.className = "source-link";
          links.appendChild(a);
        }
        if (data.linkedin) {
          const a = document.createElement("a");
          a.href = data.linkedin;
          a.target = "_blank";
          a.textContent = "üîó LinkedIn";
          a.className = "source-link";
          if (links.childNodes.length) {
            const sep = document.createElement("span");
            sep.textContent = " ‚Ä¢ ";
            links.appendChild(sep);
          }
          links.appendChild(a);
        }
        if (links.childNodes.length) {
          links.style.marginTop = "4px";
          card.appendChild(links);
        }

        if (data.description) {
          const p = document.createElement("div");
          p.style.marginTop = "6px";
          p.style.fontSize = "11px";
          p.style.color = "#d1d5db";
          p.textContent = data.description;
          card.appendChild(p);
        }

        dbOverviewEl.appendChild(card);
      }

      function renderAIEvents(events, missing) {
        aiEventsEl.innerHTML = "";
        if (!events || !events.length) {
          aiEventsEl.innerHTML =
            '<div class="empty-state">No AI events found.</div>';
          aiMetaEl.textContent = "0 events";
          return;
        }

        aiMetaEl.textContent = `${events.length} event${
          events.length > 1 ? "s" : ""
        } (${missing.length} missing in DB)`;

        events.forEach((ev, idx) => {
          const container = document.createElement("div");
          container.className = "event-card";

          const isMissing = missing.some((m) => {
            return (
              (m["Event (short)"] || m.event_short || "") ===
              (ev["Event (short)"] || ev.event_short || "")
            );
          });

          const shortTitle = ev["Event (short)"] || ev.event_short || "Untitled";
          const annDate =
            ev["Announcement Date"] || ev.announcement_date || "Unknown";
          const closed =
            ev["Closed Date"] || ev.closed_date || "" || "Not available";
          const type =
            ev["Deal Type"] ||
            ev.deal_type ||
            ev["Event type"] ||
            ev.event_type ||
            "Unknown";
          const status = ev["Deal Status"] || ev.deal_status || "";
          const source = ev["Source URL"] || ev.source_url || "";

          const titleRow = document.createElement("div");
          titleRow.className = "event-title-row";

          // LEFT: editable fields
          const left = document.createElement("div");
          left.style.flex = "1";

          // Title
          const titleLabel = document.createElement("div");
          titleLabel.className = "event-title";
          const matchLabel = isMissing ? "MISSING in DB" : "Matched in DB";
          titleLabel.innerHTML = `${
            isMissing ? "‚ö†Ô∏è" : "‚úÖ"
          } AI Event #${idx + 1} <span style="font-size:11px;color:${
            isMissing ? "#facc15" : "#6ee7b7"
          };">(${matchLabel})</span>`;

          const titleInput = document.createElement("input");
          titleInput.type = "text";
          titleInput.id = `ev_${idx}_title`;
          titleInput.value = shortTitle;
          titleInput.style.width = "100%";
          titleInput.style.marginTop = "4px";
          titleInput.style.padding = "4px 7px";
          titleInput.style.borderRadius = "8px";
          titleInput.style.border = "1px solid #1f2937";
          titleInput.style.background = "#020617";
          titleInput.style.color = "#e5e7eb";
          titleInput.style.fontSize = "12px";

          // Dates row
          const datesRow = document.createElement("div");
          datesRow.style.display = "flex";
          datesRow.style.gap = "6px";
          datesRow.style.marginTop = "6px";

          const annInput = document.createElement("input");
          annInput.type = "text";
          annInput.placeholder = "Announcement (YYYY-MM-DD)";
          annInput.id = `ev_${idx}_ann`;
          annInput.value = annDate !== "Unknown" ? annDate : "";
          annInput.style.flex = "1";
          annInput.style.padding = "3px 7px";
          annInput.style.borderRadius = "999px";
          annInput.style.border = "1px solid #1f2937";
          annInput.style.background = "#020617";
          annInput.style.color = "#e5e7eb";
          annInput.style.fontSize = "11px";

          const closedInput = document.createElement("input");
          closedInput.type = "text";
          closedInput.placeholder = "Closed (YYYY-MM-DD)";
          closedInput.id = `ev_${idx}_closed`;
          closedInput.value =
            closed && closed !== "Not available" ? closed : "";
          closedInput.style.flex = "1";
          closedInput.style.padding = "3px 7px";
          closedInput.style.borderRadius = "999px";
          closedInput.style.border = "1px solid #1f2937";
          closedInput.style.background = "#020617";
          closedInput.style.color = "#e5e7eb";
          closedInput.style.fontSize = "11px";

          datesRow.appendChild(annInput);
          datesRow.appendChild(closedInput);

          // Type / status row
          const typeRow = document.createElement("div");
          typeRow.style.display = "flex";
          typeRow.style.gap = "6px";
          typeRow.style.marginTop = "6px";

          const typeSelect = document.createElement("select");
          typeSelect.id = `ev_${idx}_type`;
          typeSelect.style.flex = "1";
          typeSelect.style.padding = "3px 7px";
          typeSelect.style.borderRadius = "999px";
          typeSelect.style.border = "1px solid #1f2937";
          typeSelect.style.background = "#020617";
          typeSelect.style.color = "#e5e7eb";
          typeSelect.style.fontSize = "11px";
          DEAL_TYPES.forEach((opt) => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt || "Deal type";
            if (opt && opt.toLowerCase() === type.toLowerCase()) {
              o.selected = true;
            }
            typeSelect.appendChild(o);
          });

          const statusSelect = document.createElement("select");
          statusSelect.id = `ev_${idx}_status`;
          statusSelect.style.flex = "1";
          statusSelect.style.padding = "3px 7px";
          statusSelect.style.borderRadius = "999px";
          statusSelect.style.border = "1px solid #1f2937";
          statusSelect.style.background = "#020617";
          statusSelect.style.color = "#e5e7eb";
          statusSelect.style.fontSize = "11px";
          DEAL_STATUSES.forEach((opt) => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt || "Deal status";
            if (opt && opt.toLowerCase() === status.toLowerCase()) {
              o.selected = true;
            }
            statusSelect.appendChild(o);
          });

          typeRow.appendChild(typeSelect);
          typeRow.appendChild(statusSelect);

          // Source URL
          const sourceInput = document.createElement("input");
          sourceInput.type = "text";
          sourceInput.placeholder = "Source URL (press release / announcement)";
          sourceInput.id = `ev_${idx}_source`;
          sourceInput.value = source;
          sourceInput.style.width = "100%";
          sourceInput.style.marginTop = "6px";
          sourceInput.style.padding = "3px 7px";
          sourceInput.style.borderRadius = "999px";
          sourceInput.style.border = "1px solid #1f2937";
          sourceInput.style.background = "#020617";
          sourceInput.style.color = "#e5e7eb";
          sourceInput.style.fontSize = "11px";

          left.appendChild(titleLabel);
          left.appendChild(titleInput);
          left.appendChild(datesRow);
          left.appendChild(typeRow);
          left.appendChild(sourceInput);

          // RIGHT: Add to DB button
          const btn = document.createElement("button");
          btn.className = "primary";
          btn.style.padding = "5px 10px";
          btn.style.fontSize = "11px";
          btn.innerHTML = "üöÄ Add to DB";

          btn.addEventListener("click", () => {
            addEventToDb(ev, idx, btn);
          });

          titleRow.appendChild(left);
          titleRow.appendChild(btn);

          container.appendChild(titleRow);

          // Show original, non-editable summary line under fields
          const meta = document.createElement("div");
          meta.className = "event-meta";
          meta.style.marginTop = "4px";
          meta.innerHTML = `
            <span>üì¢ ${annDate}</span>
            ${
              closed && closed !== "Not available"
                ? `<span>‚Ä¢ ‚úÖ ${closed}</span>`
                : ""
            }
            <span>‚Ä¢ ${type}</span>
            ${status ? `<span>‚Ä¢ ${status}</span>` : ""}
          `;
          container.appendChild(meta);

          // Counterparties (read‚Äëonly display)
          const cps = ev.counterparties || [];
          if (cps.length) {
            const cpBlock = document.createElement("div");
            cpBlock.style.marginTop = "6px";
            cpBlock.style.fontSize = "11px";

            const cpTitle = document.createElement("div");
            cpTitle.style.marginBottom = "2px";
            cpTitle.style.color = "#9ca3af";
            cpTitle.textContent = `Counterparties (${cps.length})`;
            cpBlock.appendChild(cpTitle);

            cps.forEach((cp) => {
              const name = cp.company_name || "Unknown";
              const role =
                cp.role || cp.role_description || cp.type || "Counterparty";
              const link = cp.company_linkedin_url || "";
              const press = cp.press_release_url || "";
              const indiv = cp.individuals || [];

              const line = document.createElement("div");
              line.style.marginBottom = "2px";

              let html = `‚Ä¢ <strong>${name}</strong> <span style="opacity:0.75;">(${role})</span>`;
              if (press) {
                html += ` <a href="${press}" target="_blank" class="source-link">[Announcement]</a>`;
              }
              if (link) {
                html += ` <a href="${link}" target="_blank" class="source-link">[LinkedIn]</a>`;
              }
              line.innerHTML = html;
              cpBlock.appendChild(line);

              if (indiv.length) {
                const ppl = document.createElement("div");
                ppl.style.marginLeft = "10px";
                ppl.style.color = "#9ca3af";
                ppl.textContent =
                  "Key people: " +
                  indiv
                    .slice(0, 4)
                    .map((i) =>
                      [i.name || "Unknown", i.title || i.job_title || ""]
                        .filter(Boolean)
                        .join(" ‚Äì ")
                    )
                    .join(", ");
                cpBlock.appendChild(ppl);
              }
            });

            container.appendChild(cpBlock);
          }

          aiEventsEl.appendChild(container);
        });
      }

      function renderDBEvents(events) {
        dbEventsEl.innerHTML = "";
        if (!events || !events.length) {
          dbEventsEl.innerHTML =
            '<div class="empty-state">No events in database.</div>';
          dbMetaEl.textContent = "0 events";
          return;
        }
        dbMetaEl.textContent = `${events.length} event${
          events.length > 1 ? "s" : ""
        }`;

        events.forEach((ev) => {
          const card = document.createElement("div");
          card.className = "event-card";
          const desc = ev.description || "Unknown event";
          const ann = ev.announcement_date || "Unknown";
          const closed = ev.closed_date || "";
          const type = ev.deal_type || "Unknown";
          const status = ev.deal_status || "";
          const evDisplay = ev.ev_display || "";

          const metaPieces = [`üì¢ ${ann}`];
          if (closed) metaPieces.push(`‚úÖ ${closed}`);
          metaPieces.push(type);
          if (status) metaPieces.push(status);
          if (evDisplay) metaPieces.push(`üí∞ ${evDisplay}`);

          card.innerHTML = `
            <div class="event-title">${desc}</div>
            <div class="event-meta">
              ${metaPieces.map((m) => `<span>${m}</span>`).join("")}
            </div>
          `;

          // Counterparties from DB: target + other buckets if present
          const cpContainer = document.createElement("div");
          cpContainer.style.marginTop = "6px";
          cpContainer.style.fontSize = "11px";

          const target = ev.target_company;
          const cpLines = [];

          if (target && target.name) {
            const tUrl = target.counterparty_announcement_url || "";
            let tHtml = `‚Ä¢ <strong>${target.name}</strong> <span style="opacity:0.75;">(Target)</span>`;
            if (tUrl) {
              tHtml += ` <a href="${tUrl}" target="_blank" class="source-link">[Announcement]</a>`;
            }
            cpLines.push(tHtml);
          }

          const buckets = [
            "other_counterparties",
            "investors",
            "sellers",
            "buyers",
          ];
          buckets.forEach((key) => {
            const arr = ev[key] || [];
            arr.forEach((cp) => {
              const name = cp.name || "Unknown";
              const status = cp.counterparty_status || cp.role || "";
              const url = cp.counterparty_announcement_url || "";
              let html = `‚Ä¢ <strong>${name}</strong>`;
              if (status) {
                html += ` <span style="opacity:0.75;">(${status})</span>`;
              }
              if (url) {
                html += ` <a href="${url}" target="_blank" class="source-link">[Announcement]</a>`;
              }
              cpLines.push(html);
            });
          });

          if (cpLines.length) {
            const heading = document.createElement("div");
            heading.style.color = "#9ca3af";
            heading.style.marginBottom = "2px";
            heading.textContent = `Counterparties (${cpLines.length})`;
            cpContainer.appendChild(heading);

            cpLines.forEach((html) => {
              const line = document.createElement("div");
              line.innerHTML = html;
              cpContainer.appendChild(line);
            });

            card.appendChild(cpContainer);
          }

          dbEventsEl.appendChild(card);
        });
      }

      async function addEventToDb(eventObj, idx, button) {
        button.disabled = true;
        button.textContent = "‚è≥ Sending‚Ä¶";
        log(
          `Sending AI event #${idx + 1} to Xano /create_corporate_event‚Ä¶`,
          "warn"
        );

        // Prefer edited values from inputs; fall back to original AI object
        const titleInput = document.getElementById(`ev_${idx}_title`);
        const annInput = document.getElementById(`ev_${idx}_ann`);
        const closedInput = document.getElementById(`ev_${idx}_closed`);
        const typeSelect = document.getElementById(`ev_${idx}_type`);
        const statusSelect = document.getElementById(`ev_${idx}_status`);
        const sourceInput = document.getElementById(`ev_${idx}_source`);

        const title =
          (titleInput && titleInput.value.trim()) ||
          eventObj["Event (short)"] ||
          eventObj.event_short ||
          "";
        const annDate =
          (annInput && annInput.value.trim()) ||
          eventObj["Announcement Date"] ||
          eventObj.announcement_date ||
          "";
        const closedRaw =
          (closedInput && closedInput.value.trim()) ||
          eventObj["Closed Date"] ||
          eventObj.closed_date ||
          "";
        const dealType =
          (typeSelect && typeSelect.value) ||
          eventObj["Deal Type"] ||
          eventObj.deal_type ||
          eventObj["Event type"] ||
          eventObj.event_type ||
          "Acquisition";
        const dealStatus =
          (statusSelect && statusSelect.value) ||
          eventObj["Deal Status"] ||
          eventObj.deal_status ||
          "Completed";
        const sourceUrl =
          (sourceInput && sourceInput.value.trim()) ||
          eventObj["Source URL"] ||
          eventObj.source_url ||
          "";
        const counterparties = eventObj.counterparties || [];

        const payload = {
          title: title || "Untitled Event",
          // Xano expects a human‚Äëreadable description ‚Äì use the same string
          description: title || "Untitled Event",
          announcement_date: annDate || "2024-01-01",
          closed_date: closedRaw || null,
          deal_type: dealType,
          deal_status: dealStatus,
          investment_amount: "",
          currency_id: 15,
          counterparties: (counterparties || []).map((cp) => {
            const individuals =
              (cp.individuals || []).map((ind) => ({
                name: ind.name || "",
                job_title: ind.title || "",
              })) || [];
            return {
              name: cp.company_name || "",
              role:
                cp.role ||
                cp.role_description ||
                "Target",
              announcement_url: sourceUrl || cp.press_release_url || "",
              linkedin_url: cp.company_linkedin_url || "",
              individuals,
            };
          }),
        };

        const endpoint = `${XANO_BASE}/api:617tZc8l/create_corporate_event`;
        log(`POST ${endpoint}`, "info");

        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const text = await res.text();
          log(`HTTP ${res.status}: ${text.slice(0, 200)}`, "info");
          let parsed;
          try {
            parsed = JSON.parse(text);
          } catch (e) {}

          if (parsed && parsed.success) {
            button.textContent = "‚úÖ Added";
            button.style.background = "linear-gradient(135deg,#22c55e,#16a34a)";
            log(
              `Success: event_id=${parsed.event_id}, counterparties=${parsed.total_counterparties}`,
              "ok"
            );
          } else {
            button.textContent = "‚ùå Failed";
            button.style.background =
              "linear-gradient(135deg,#ef4444,#b91c1c)";
            log(
              `Xano error: ${
                parsed ? JSON.stringify(parsed) : text || "Unknown error"
              }`,
              "err"
            );
            setTimeout(() => {
              button.disabled = false;
              button.textContent = "üöÄ Retry";
              button.style.background =
                "linear-gradient(135deg,#6366f1,#8b5cf6)";
            }, 3500);
          }
        } catch (err) {
          log(`Fetch error: ${err.message}`, "err");
          button.textContent = "‚ùå Error";
          button.style.background =
            "linear-gradient(135deg,#ef4444,#b91c1c)";
          setTimeout(() => {
            button.disabled = false;
            button.textContent = "üöÄ Retry";
            button.style.background =
              "linear-gradient(135deg,#6366f1,#8b5cf6)";
          }, 3500);
        }
      }

      async function runAnalyze() {
        const query = queryInput.value.trim();
        if (!query) {
          alert("Please enter a company URL or name.");
          return;
        }

        clearEvents();
        aiMetaEl.textContent = "Loading‚Ä¶";
        dbMetaEl.textContent = "Loading‚Ä¶";
        logEl.innerHTML = "";
        setStatus("Analyzing‚Ä¶", "info");
        log(`Starting analysis for: "${query}"`, "info");

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = "‚è≥ Analyzing‚Ä¶";

        try {
          const res = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
          });

          const json = await res.json();
          if (!res.ok) {
            log(`Backend error: ${JSON.stringify(json)}`, "err");
            setStatus("Error", "err");
            aiEventsEl.innerHTML =
              '<div class="empty-state">Backend error ‚Äì check logs.</div>';
            dbEventsEl.innerHTML =
              '<div class="empty-state">No DB data.</div>';
            return;
          }

          const {
            existing_company,
            db_company,
            db_overview,
            ai_overview,
            db_events,
            ai_events,
            missing_events,
            matched_events,
          } = json;

          if (existing_company && existing_company.id) {
            dbMetaEl.textContent = `Company ID ${existing_company.id}`;
            log(
              `Company exists in DB (id=${existing_company.id}). Events: ${
                (db_events || []).length
              }`,
              "ok"
            );
          } else {
            dbMetaEl.textContent = "Company not found in DB";
            log("Company not found in DB ‚Äì AI-only mode.", "warn");
          }

          renderAIOverview(ai_overview || null);
          renderDBOverview(db_overview || null);
          renderAIEvents(ai_events || [], missing_events || []);
          renderDBEvents(db_events || []);

          const aiCount = (ai_events || []).length;
          const dbCount = (db_events || []).length;
          log(
            `AI events: ${aiCount}, DB events: ${dbCount}, matched: ${
              (matched_events || []).length
            }, missing: ${(missing_events || []).length}`,
            "ok"
          );
          setStatus("Done", "ok");
        } catch (err) {
          log(`Fetch /analyze error: ${err.message}`, "err");
          setStatus("Error", "err");
        } finally {
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = "üöÄ Analyze";
        }
      }

      analyzeBtn.addEventListener("click", runAnalyze);
      queryInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          runAnalyze();
        }
      });
    </script>
  </body>
</html>


