<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SearXNG ‚Äì Events UI (No Streamlit)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #050816;
        --bg-card: #0b1020;
        --bg-pill: #111827;
        --accent: #6366f1;
        --accent-soft: #4f46e5;
        --accent-danger: #ef4444;
        --accent-success: #10b981;
        --border-subtle: #1f2937;
        --text: #e5e7eb;
        --muted: #9ca3af;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
        color: var(--text);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          sans-serif;
      }

      .shell {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
      }

      .title-block h1 {
        font-size: 24px;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .title-block p {
        margin: 4px 0 0;
        font-size: 13px;
        color: var(--muted);
      }

      .badge {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 118, 110, 0.15);
        color: #5eead4;
        border: 1px solid rgba(45, 212, 191, 0.35);
      }

      .panel {
        background: rgba(15, 23, 42, 0.95);
        border-radius: 18px;
        padding: 16px 18px 14px;
        box-shadow: 0 10px 40px rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(55, 65, 81, 0.85);
        backdrop-filter: blur(16px);
      }

      .input-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 4px;
      }

      .chip {
        font-size: 11px;
        padding: 2px 9px;
        border-radius: 999px;
        background: var(--bg-pill);
        color: var(--muted);
        border: 1px solid #1f2937;
      }

      input[type="text"] {
        flex: 1;
        padding: 9px 11px;
        border-radius: 999px;
        border: 1px solid #1e293b;
        background: radial-gradient(circle at top left, #020617, #020617 55%, #020617);
        color: var(--text);
        font-size: 13px;
        outline: none;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      }

      input[type="text"]::placeholder {
        color: #4b5563;
      }

      button.primary {
        padding: 8px 18px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.55);
        transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
      }

      button.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 34px rgba(79, 70, 229, 0.7);
      }

      button.primary:disabled {
        opacity: 0.5;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      .hint-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-top: 4px;
      }

      .hint-row small {
        color: var(--muted);
        font-size: 11px;
      }

      .hint-row code {
        background: rgba(15, 23, 42, 0.85);
        border-radius: 999px;
        padding: 2px 8px;
        border: 1px solid #1f2937;
      }

      .split {
        display: grid;
        grid-template-columns: 1.15fr 1fr;
        gap: 18px;
        margin-top: 20px;
      }

      .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .pill {
        font-size: 11px;
        padding: 3px 9px;
        border-radius: 999px;
        background: #020617;
        border: 1px solid #111827;
        color: #9ca3af;
      }

      .events-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .event-card {
        border-radius: 14px;
        padding: 10px 11px;
        background: radial-gradient(circle at top left, #020617 0, #020617 47%, #020617 100%);
        border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .event-title-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: flex-start;
      }

      .event-title {
        font-size: 13px;
        font-weight: 600;
      }

      .event-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
        font-size: 11px;
        color: var(--muted);
      }

      .tag {
        padding: 2px 7px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid #1f2937;
      }

      .log-panel {
        margin-top: 16px;
        border-radius: 12px;
        background: #020617;
        border: 1px solid #1f2937;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        max-height: 180px;
        overflow-y: auto;
        padding: 8px 9px;
      }

      .log-line {
        margin: 1px 0;
      }

      .log-line.info {
        color: #93c5fd;
      }

      .log-line.warn {
        color: #fbbf24;
      }

      .log-line.ok {
        color: #6ee7b7;
      }

      .log-line.err {
        color: #fca5a5;
      }

      .empty-state {
        font-size: 12px;
        color: var(--muted);
        padding: 10px 8px;
      }

      .source-link {
        font-size: 11px;
        color: #93c5fd;
        text-decoration: none;
      }

      .source-link:hover {
        text-decoration: underline;
      }

      /* Date input styling for dark mode */
      input[type="date"] {
        color-scheme: dark;
      }
      
      input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(0.8);
        cursor: pointer;
      }

      @media (max-width: 900px) {
        .split {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="header">
        <div class="title-block">
          <h1>
            üß≠ SearXNG
            <span style="font-weight: 500; opacity: 0.8"
              >‚Äì Corporate Events Console</span
            >
          </h1>
          <p>
            Side‚Äëby‚Äëside AI vs Database comparison with
            <strong>non‚Äërefreshing</strong> ‚ÄúAdd to DB‚Äù buttons.
          </p>
        </div>
        <div class="badge">beta ‚Äì fastapi ui (no streamlit)</div>
      </header>

      <section class="panel">
        <div class="input-row">
          <span class="chip">1</span>
          <input
            id="queryInput"
            type="text"
            placeholder="Enter company URL or name, e.g. https://heliointelligence.com/"
          />
          <button id="analyzeBtn" class="primary">
            <span>üöÄ Analyze</span>
          </button>
        </div>
        <div class="hint-row">
          <small
            >If the URL exists in Xano, we'll fetch DB events and compare to AI
            events.</small
          >
          <small id="dbStatusBadge" style="display: none;"></small>
        </div>
        <!-- Database Status Badge -->
        <div id="xanoStatusContainer" style="margin-top: 12px; display: none;">
          <div id="xanoStatusBadge" style="
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
          ">
            <span id="xanoStatusIcon"></span>
            <span id="xanoStatusText"></span>
          </div>
        </div>
      </section>

      <!-- Company Overview -->
      <section class="split" style="margin-top: 18px; margin-bottom: 8px">
        <div>
          <div class="column-header">
            <div>
              <strong>ü§ñ AI Company Overview</strong>
              <span id="aiOverviewMeta" class="pill">Waiting for query‚Ä¶</span>
            </div>
          </div>
          <div id="aiOverview" class="events-list">
            <div class="empty-state">
              Run an analysis to populate AI‚Äëgenerated company overview here.
            </div>
          </div>
        </div>
        <div>
          <div class="column-header">
            <div>
              <strong>üóÑÔ∏è Database Company Overview</strong>
              <span id="dbOverviewMeta" class="pill">No company loaded</span>
            </div>
          </div>
          <div id="dbOverview" class="events-list">
            <div class="empty-state">
              If the company exists in Xano, its overview will appear here.
            </div>
          </div>
        </div>
      </section>

      <!-- Events -->
      <section class="split">
        <!-- AI Column -->
        <div>
          <div class="column-header">
            <div>
              <strong>ü§ñ AI Events</strong>
              <span id="aiMeta" class="pill">Waiting for query‚Ä¶</span>
            </div>
          </div>
          <div id="aiEvents" class="events-list">
            <div class="empty-state">
              Run an analysis to see AI‚Äëdiscovered corporate events here.
            </div>
          </div>
        </div>

        <!-- DB Column -->
        <div>
          <div class="column-header">
            <div>
              <strong>üóÑÔ∏è Database (Xano)</strong>
              <span id="dbMeta" class="pill">No company loaded</span>
            </div>
          </div>
          <div id="dbEvents" class="events-list">
            <div class="empty-state">
              If the company exists in Xano, its events will appear here.
            </div>
          </div>
        </div>
      </section>

      <!-- Top Management Section -->
      <section class="panel" style="margin-top: 18px;">
        <div class="column-header">
          <div>
            <strong>üëî Top Management</strong>
            <span id="mgmtMeta" class="pill">Waiting for query‚Ä¶</span>
          </div>
        </div>
        <div id="topManagement" class="events-list">
          <div class="empty-state">
            Run an analysis to see company leadership here.
          </div>
        </div>
      </section>

      <section style="margin-top: 18px">
        <div class="column-header">
          <div>
            <strong>üì° API Log</strong>
          </div>
          <span class="pill" id="statusPill">Idle</span>
        </div>
        <div id="log" class="log-panel"></div>
      </section>
    </div>

    <script>
      const analyzeBtn = document.getElementById("analyzeBtn");
      const queryInput = document.getElementById("queryInput");
      const aiEventsEl = document.getElementById("aiEvents");
      const dbEventsEl = document.getElementById("dbEvents");
      const aiMetaEl = document.getElementById("aiMeta");
      const dbMetaEl = document.getElementById("dbMeta");
      const aiOverviewEl = document.getElementById("aiOverview");
      const dbOverviewEl = document.getElementById("dbOverview");
      const aiOverviewMeta = document.getElementById("aiOverviewMeta");
      const dbOverviewMeta = document.getElementById("dbOverviewMeta");
      const logEl = document.getElementById("log");
      const statusPill = document.getElementById("statusPill");
      const xanoStatusContainer = document.getElementById("xanoStatusContainer");
      const xanoStatusBadge = document.getElementById("xanoStatusBadge");
      const xanoStatusIcon = document.getElementById("xanoStatusIcon");
      const xanoStatusText = document.getElementById("xanoStatusText");
      const topManagementEl = document.getElementById("topManagement");
      const mgmtMetaEl = document.getElementById("mgmtMeta");

      const XANO_BASE = "{{ xano_base_url }}";
      
      // Global state flags (initialize early)
      window._companyExistsInDb = false;
      window._dbDescription = null;
      
      // Function to update Xano status badge
      function updateXanoStatus(existingCompany, dbCompany) {
        xanoStatusContainer.style.display = "block";
        
        if (existingCompany && existingCompany.id) {
          // Company found in database
          window._companyExistsInDb = true;
          xanoStatusBadge.style.background = "rgba(5, 150, 105, 0.15)";
          xanoStatusBadge.style.border = "1px solid rgba(16, 185, 129, 0.4)";
          xanoStatusBadge.style.color = "#6ee7b7";
          xanoStatusIcon.textContent = "‚úÖ";
          const companyName = dbCompany?.name || `ID: ${existingCompany.id}`;
          xanoStatusText.innerHTML = `<strong>Found in Database</strong> ‚Äî ${companyName} (ID: ${existingCompany.id})`;
          
          // Hide "Create in DB" button, show "Copy from DB" if description exists
          const createContainer = document.getElementById("createInDbContainer");
          if (createContainer) createContainer.style.display = "none";
        } else {
          // Company NOT found in database
          window._companyExistsInDb = false;
          xanoStatusBadge.style.background = "rgba(239, 68, 68, 0.1)";
          xanoStatusBadge.style.border = "1px solid rgba(239, 68, 68, 0.3)";
          xanoStatusBadge.style.color = "#fca5a5";
          xanoStatusIcon.textContent = "‚ö†Ô∏è";
          xanoStatusText.innerHTML = `<strong>Not in Database</strong> ‚Äî Company will be analyzed using AI only`;
          
          // Show "Create in DB" button, hide "Copy from DB"
          const createContainer = document.getElementById("createInDbContainer");
          if (createContainer) createContainer.style.display = "block";
          const copyContainer = document.getElementById("copyFromDbContainer");
          if (copyContainer) copyContainer.style.display = "none";
        }
      }
      
      // Function to reset/hide the status badge
      function resetXanoStatus() {
        xanoStatusContainer.style.display = "none";
      }

      // Deal / status options (mirrors Streamlit version)
      const DEAL_TYPES = [
        "",
        "Acquisition",
        "Sale",
        "IPO",
        "MBO",
        "Investment",
        "Strategic Review",
        "Divestment",
        "Restructuring",
        "Dual track",
        "Closing",
        "Grant",
        "Debt financing",
        "Bankruptcy",
        "Reorganisation",
        "Employee tender offer",
        "Rebrand",
        "Partnership",
      ];

      const DEAL_STATUSES = [
        "",
        "Completed",
        "In Market",
        "Not yet launched",
        "Strategic Review",
        "Deal Prep",
        "In Exclusivity",
        "Pending",
      ];

      function log(msg, level = "info") {
        const time = new Date().toLocaleTimeString();
        const div = document.createElement("div");
        div.className = `log-line ${level}`;
        div.textContent = `[${time}] ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function setStatus(text, tone = "info") {
        statusPill.textContent = text;
        if (tone === "ok") {
          statusPill.style.background = "rgba(5, 46, 22, 0.9)";
          statusPill.style.color = "#6ee7b7";
        } else if (tone === "err") {
          statusPill.style.background = "rgba(127, 29, 29, 0.9)";
          statusPill.style.color = "#fecaca";
        } else {
          statusPill.style.background = "#020617";
          statusPill.style.color = "#9ca3af";
        }
      }

      function clearEvents() {
        aiEventsEl.innerHTML = "";
        dbEventsEl.innerHTML = "";
        aiOverviewEl.innerHTML = "";
        dbOverviewEl.innerHTML = "";
        topManagementEl.innerHTML = "";
      }

      function renderAIOverview(data) {
        aiOverviewEl.innerHTML = "";
        if (!data) {
          aiOverviewEl.innerHTML =
            '<div class="empty-state">No AI overview available.</div>';
          aiOverviewMeta.textContent = "No data";
          return;
        }
        aiOverviewMeta.textContent = "Editable";

        const card = document.createElement("div");
        card.className = "event-card";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.id = "ai_name";
        nameInput.value = data.name || "";
        nameInput.placeholder = "Company name";
        nameInput.style.width = "100%";
        nameInput.style.padding = "5px 8px";
        nameInput.style.borderRadius = "8px";
        nameInput.style.border = "1px solid #1f2937";
        nameInput.style.background = "#020617";
        nameInput.style.color = "#e5e7eb";
        nameInput.style.fontSize = "13px";

        const rowLoc = document.createElement("div");
        rowLoc.style.display = "flex";
        rowLoc.style.gap = "6px";
        rowLoc.style.marginTop = "6px";

        const cityInput = document.createElement("input");
        cityInput.type = "text";
        cityInput.id = "ai_city";
        cityInput.placeholder = "City";
        cityInput.value = data.city || "";
        cityInput.style.flex = "1";
        cityInput.style.padding = "3px 7px";
        cityInput.style.borderRadius = "999px";
        cityInput.style.border = "1px solid #1f2937";
        cityInput.style.background = "#020617";
        cityInput.style.color = "#e5e7eb";
        cityInput.style.fontSize = "11px";

        const countryInput = document.createElement("input");
        countryInput.type = "text";
        countryInput.id = "ai_country";
        countryInput.placeholder = "Country";
        countryInput.value = data.country || "";
        countryInput.style.flex = "1";
        countryInput.style.padding = "3px 7px";
        countryInput.style.borderRadius = "999px";
        countryInput.style.border = "1px solid #1f2937";
        countryInput.style.background = "#020617";
        countryInput.style.color = "#e5e7eb";
        countryInput.style.fontSize = "11px";

        rowLoc.appendChild(cityInput);
        rowLoc.appendChild(countryInput);

        const rowLinks = document.createElement("div");
        rowLinks.style.display = "flex";
        rowLinks.style.gap = "6px";
        rowLinks.style.marginTop = "6px";

        const websiteInput = document.createElement("input");
        websiteInput.type = "text";
        websiteInput.id = "ai_website";
        websiteInput.placeholder = "Website URL";
        websiteInput.value = data.website || "";
        websiteInput.style.flex = "1";
        websiteInput.style.padding = "3px 7px";
        websiteInput.style.borderRadius = "999px";
        websiteInput.style.border = "1px solid #1f2937";
        websiteInput.style.background = "#020617";
        websiteInput.style.color = "#e5e7eb";
        websiteInput.style.fontSize = "11px";

        const linkedinInput = document.createElement("input");
        linkedinInput.type = "text";
        linkedinInput.id = "ai_linkedin";
        linkedinInput.placeholder = "LinkedIn URL";
        linkedinInput.value = data.linkedin || "";
        linkedinInput.style.flex = "1";
        linkedinInput.style.padding = "3px 7px";
        linkedinInput.style.borderRadius = "999px";
        linkedinInput.style.border = "1px solid #1f2937";
        linkedinInput.style.background = "#020617";
        linkedinInput.style.color = "#e5e7eb";
        linkedinInput.style.fontSize = "11px";

        rowLinks.appendChild(websiteInput);
        rowLinks.appendChild(linkedinInput);

        const desc = document.createElement("textarea");
        desc.id = "ai_description";
        desc.value = data.description || "";
        desc.placeholder = "AI‚Äëgenerated description (editable)";
        desc.style.width = "100%";
        desc.style.marginTop = "6px";
        desc.style.minHeight = "70px";
        desc.style.padding = "5px 8px";
        desc.style.borderRadius = "8px";
        desc.style.border = "1px solid #1f2937";
        desc.style.background = "#020617";
        desc.style.color = "#e5e7eb";
        desc.style.fontSize = "12px";

        // "Copy from DB" button container
        const copyFromDbContainer = document.createElement("div");
        copyFromDbContainer.id = "copyFromDbContainer";
        copyFromDbContainer.style.marginTop = "8px";
        copyFromDbContainer.style.display = "none"; // Hidden by default, shown if DB has description

        const copyFromDbBtn = document.createElement("button");
        copyFromDbBtn.id = "copyFromDbBtn";
        copyFromDbBtn.innerHTML = "üìã Copy Description from Database";
        copyFromDbBtn.style.padding = "6px 12px";
        copyFromDbBtn.style.borderRadius = "8px";
        copyFromDbBtn.style.border = "1px solid rgba(99, 102, 241, 0.4)";
        copyFromDbBtn.style.background = "rgba(99, 102, 241, 0.15)";
        copyFromDbBtn.style.color = "#a5b4fc";
        copyFromDbBtn.style.fontSize = "11px";
        copyFromDbBtn.style.cursor = "pointer";
        copyFromDbBtn.style.transition = "all 0.15s ease";
        copyFromDbBtn.onmouseover = () => {
          copyFromDbBtn.style.background = "rgba(99, 102, 241, 0.25)";
          copyFromDbBtn.style.borderColor = "rgba(99, 102, 241, 0.6)";
        };
        copyFromDbBtn.onmouseout = () => {
          copyFromDbBtn.style.background = "rgba(99, 102, 241, 0.15)";
          copyFromDbBtn.style.borderColor = "rgba(99, 102, 241, 0.4)";
        };
        copyFromDbBtn.onclick = () => {
          if (window._dbDescription) {
            desc.value = window._dbDescription;
            log("Copied description from database", "ok");
            // Visual feedback
            copyFromDbBtn.innerHTML = "‚úÖ Copied!";
            copyFromDbBtn.style.background = "rgba(16, 185, 129, 0.2)";
            copyFromDbBtn.style.borderColor = "rgba(16, 185, 129, 0.5)";
            copyFromDbBtn.style.color = "#6ee7b7";
            setTimeout(() => {
              copyFromDbBtn.innerHTML = "üìã Copy Description from Database";
              copyFromDbBtn.style.background = "rgba(99, 102, 241, 0.15)";
              copyFromDbBtn.style.borderColor = "rgba(99, 102, 241, 0.4)";
              copyFromDbBtn.style.color = "#a5b4fc";
            }, 2000);
          }
        };
        copyFromDbContainer.appendChild(copyFromDbBtn);

        // "Create in DB" button container (shown when company NOT in database)
        const createInDbContainer = document.createElement("div");
        createInDbContainer.id = "createInDbContainer";
        createInDbContainer.style.marginTop = "10px";
        // Show by default if company is NOT in DB (checked via global flag)
        createInDbContainer.style.display = window._companyExistsInDb ? "none" : "block";

        const createInDbBtn = document.createElement("button");
        createInDbBtn.id = "createInDbBtn";
        createInDbBtn.innerHTML = "‚ûï Create Company in Database";
        createInDbBtn.style.padding = "8px 16px";
        createInDbBtn.style.borderRadius = "8px";
        createInDbBtn.style.border = "1px solid rgba(16, 185, 129, 0.4)";
        createInDbBtn.style.background = "rgba(16, 185, 129, 0.15)";
        createInDbBtn.style.color = "#6ee7b7";
        createInDbBtn.style.fontSize = "12px";
        createInDbBtn.style.fontWeight = "600";
        createInDbBtn.style.cursor = "pointer";
        createInDbBtn.style.transition = "all 0.15s ease";
        createInDbBtn.onmouseover = () => {
          createInDbBtn.style.background = "rgba(16, 185, 129, 0.25)";
          createInDbBtn.style.borderColor = "rgba(16, 185, 129, 0.6)";
        };
        createInDbBtn.onmouseout = () => {
          createInDbBtn.style.background = "rgba(16, 185, 129, 0.15)";
          createInDbBtn.style.borderColor = "rgba(16, 185, 129, 0.4)";
        };
        createInDbBtn.onclick = async () => {
          await createCompanyInDb(createInDbBtn);
        };
        createInDbContainer.appendChild(createInDbBtn);

        card.appendChild(nameInput);
        card.appendChild(rowLoc);
        card.appendChild(rowLinks);
        card.appendChild(desc);
        card.appendChild(copyFromDbContainer);
        card.appendChild(createInDbContainer);

        aiOverviewEl.appendChild(card);
      }

      function renderDBOverview(data) {
        dbOverviewEl.innerHTML = "";
        // Reset the DB description
        window._dbDescription = null;
        
        if (!data) {
          dbOverviewEl.innerHTML =
            '<div class="empty-state">No DB overview available.</div>';
          dbOverviewMeta.textContent = "No company";
          // Hide the "Copy from DB" button
          const copyContainer = document.getElementById("copyFromDbContainer");
          if (copyContainer) copyContainer.style.display = "none";
          return;
        }
        dbOverviewMeta.textContent = "Loaded from Xano";

        const card = document.createElement("div");
        card.className = "event-card";

        const title = document.createElement("div");
        title.className = "event-title";
        title.textContent = data.name || "Unknown company";
        card.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "event-meta";
        const locPieces = [];
        if (data.city) locPieces.push(data.city);
        if (data.country) locPieces.push(data.country);
        if (locPieces.length) {
          const span = document.createElement("span");
          span.textContent = "üìç " + locPieces.join(", ");
          meta.appendChild(span);
        }
        if (data.ownership) {
          const span = document.createElement("span");
          span.textContent = data.ownership;
          meta.appendChild(span);
        }
        card.appendChild(meta);

        const links = document.createElement("div");
        links.className = "event-meta";
        if (data.website) {
          const a = document.createElement("a");
          a.href = data.website;
          a.target = "_blank";
          a.textContent = "üåê Website";
          a.className = "source-link";
          links.appendChild(a);
        }
        if (data.linkedin) {
          const a = document.createElement("a");
          a.href = data.linkedin;
          a.target = "_blank";
          a.textContent = "üîó LinkedIn";
          a.className = "source-link";
          if (links.childNodes.length) {
            const sep = document.createElement("span");
            sep.textContent = " ‚Ä¢ ";
            links.appendChild(sep);
          }
          links.appendChild(a);
        }
        if (links.childNodes.length) {
          links.style.marginTop = "4px";
          card.appendChild(links);
        }

        if (data.description) {
          const p = document.createElement("div");
          p.style.marginTop = "6px";
          p.style.fontSize = "11px";
          p.style.color = "#d1d5db";
          p.textContent = data.description;
          card.appendChild(p);
          
          // Store the DB description and show the "Copy from DB" button
          window._dbDescription = data.description;
          const copyContainer = document.getElementById("copyFromDbContainer");
          if (copyContainer) {
            copyContainer.style.display = "block";
          }
        } else {
          // Hide the "Copy from DB" button if no description
          const copyContainer = document.getElementById("copyFromDbContainer");
          if (copyContainer) copyContainer.style.display = "none";
        }

        dbOverviewEl.appendChild(card);
      }

      function renderTopManagement(executives) {
        topManagementEl.innerHTML = "";
        if (!executives || !executives.length) {
          topManagementEl.innerHTML =
            '<div class="empty-state">No top management data found.</div>';
          mgmtMetaEl.textContent = "0 executives";
          return;
        }

        mgmtMetaEl.textContent = `${executives.length} executive${executives.length > 1 ? "s" : ""}`;

        // Create a grid for executives
        const grid = document.createElement("div");
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(280px, 1fr))";
        grid.style.gap = "12px";

        executives.forEach((exec, idx) => {
          const card = document.createElement("div");
          card.className = "event-card";
          card.style.padding = "12px";

          // Name and position
          const nameRow = document.createElement("div");
          nameRow.style.display = "flex";
          nameRow.style.justifyContent = "space-between";
          nameRow.style.alignItems = "flex-start";
          nameRow.style.marginBottom = "6px";

          const nameDiv = document.createElement("div");
          const name = document.createElement("div");
          name.className = "event-title";
          name.textContent = exec.name || "Unknown";
          name.style.fontSize = "14px";
          nameDiv.appendChild(name);

          const position = document.createElement("div");
          position.style.fontSize = "12px";
          position.style.color = "#a5b4fc";
          position.style.marginTop = "2px";
          position.textContent = exec.position || "";
          nameDiv.appendChild(position);

          nameRow.appendChild(nameDiv);

          // Status badge
          const status = exec.status || "Current";
          const statusBadge = document.createElement("span");
          statusBadge.style.fontSize = "10px";
          statusBadge.style.padding = "2px 8px";
          statusBadge.style.borderRadius = "999px";
          statusBadge.style.whiteSpace = "nowrap";
          if (status.toLowerCase() === "current") {
            statusBadge.style.background = "rgba(16, 185, 129, 0.15)";
            statusBadge.style.color = "#6ee7b7";
            statusBadge.style.border = "1px solid rgba(16, 185, 129, 0.3)";
          } else {
            statusBadge.style.background = "rgba(156, 163, 175, 0.15)";
            statusBadge.style.color = "#9ca3af";
            statusBadge.style.border = "1px solid rgba(156, 163, 175, 0.3)";
          }
          statusBadge.textContent = status;
          nameRow.appendChild(statusBadge);

          card.appendChild(nameRow);

          // Location
          if (exec.location) {
            const loc = document.createElement("div");
            loc.style.fontSize = "11px";
            loc.style.color = "#9ca3af";
            loc.style.marginBottom = "6px";
            loc.textContent = "üìç " + exec.location;
            card.appendChild(loc);
          }

          // Bio
          if (exec.bio) {
            const bio = document.createElement("div");
            bio.style.fontSize = "11px";
            bio.style.color = "#d1d5db";
            bio.style.lineHeight = "1.5";
            bio.style.marginTop = "8px";
            bio.textContent = exec.bio;
            card.appendChild(bio);
          }

          // LinkedIn link if available
          if (exec.linkedin_url) {
            const link = document.createElement("a");
            link.href = exec.linkedin_url;
            link.target = "_blank";
            link.className = "source-link";
            link.style.display = "inline-block";
            link.style.marginTop = "8px";
            link.textContent = "üîó LinkedIn Profile";
            card.appendChild(link);
          }

          // Add to DB button
          const addBtnContainer = document.createElement("div");
          addBtnContainer.style.marginTop = "10px";
          addBtnContainer.style.borderTop = "1px solid rgba(255,255,255,0.1)";
          addBtnContainer.style.paddingTop = "10px";

          const addBtn = document.createElement("button");
          addBtn.textContent = "‚ûï Add to Database";
          addBtn.style.padding = "6px 12px";
          addBtn.style.fontSize = "11px";
          addBtn.style.borderRadius = "6px";
          addBtn.style.border = "1px solid rgba(99, 102, 241, 0.4)";
          addBtn.style.background = "rgba(99, 102, 241, 0.15)";
          addBtn.style.color = "#a5b4fc";
          addBtn.style.cursor = "pointer";
          addBtn.style.transition = "all 0.15s ease";
          addBtn.style.width = "100%";
          addBtn.onmouseover = () => {
            addBtn.style.background = "rgba(99, 102, 241, 0.25)";
            addBtn.style.borderColor = "rgba(99, 102, 241, 0.6)";
          };
          addBtn.onmouseout = () => {
            addBtn.style.background = "rgba(99, 102, 241, 0.15)";
            addBtn.style.borderColor = "rgba(99, 102, 241, 0.4)";
          };
          addBtn.onclick = async () => {
            const execName = exec.name || "";
            const execBio = exec.position || exec.bio || "";
            const execLinkedIn = exec.linkedin_url || "";
            await addIndividualToDb(execName, execBio, execLinkedIn, addBtn);
          };
          addBtnContainer.appendChild(addBtn);
          card.appendChild(addBtnContainer);

          grid.appendChild(card);
        });

        topManagementEl.appendChild(grid);
      }

      function renderAIEvents(events, missing) {
        aiEventsEl.innerHTML = "";
        if (!events || !events.length) {
          aiEventsEl.innerHTML =
            '<div class="empty-state">No AI events found.</div>';
          aiMetaEl.textContent = "0 events";
          return;
        }

        aiMetaEl.textContent = `${events.length} event${
          events.length > 1 ? "s" : ""
        } (${missing.length} missing in DB)`;

        events.forEach((ev, idx) => {
          const container = document.createElement("div");
          container.className = "event-card";

          const isMissing = missing.some((m) => {
            return (
              (m["Event (short)"] || m.event_short || "") ===
              (ev["Event (short)"] || ev.event_short || "")
            );
          });

          const shortTitle = ev["Event (short)"] || ev.event_short || "Untitled";
          const annDate =
            ev["Announcement Date"] || ev.announcement_date || "Unknown";
          const closed =
            ev["Closed Date"] || ev.closed_date || "" || "Not available";
          const type =
            ev["Deal Type"] ||
            ev.deal_type ||
            ev["Event type"] ||
            ev.event_type ||
            "Unknown";
          const status = ev["Deal Status"] || ev.deal_status || "";
          const source = ev["Source URL"] || ev.source_url || "";

          const titleRow = document.createElement("div");
          titleRow.className = "event-title-row";

          // LEFT: editable fields
          const left = document.createElement("div");
          left.style.flex = "1";

          // Title
          const titleLabel = document.createElement("div");
          titleLabel.className = "event-title";
          const matchLabel = isMissing ? "MISSING in DB" : "Matched in DB";
          titleLabel.innerHTML = `${
            isMissing ? "‚ö†Ô∏è" : "‚úÖ"
          } AI Event #${idx + 1} <span style="font-size:11px;color:${
            isMissing ? "#facc15" : "#6ee7b7"
          };">(${matchLabel})</span>`;

          const titleInput = document.createElement("input");
          titleInput.type = "text";
          titleInput.id = `ev_${idx}_title`;
          titleInput.value = shortTitle;
          titleInput.style.width = "100%";
          titleInput.style.marginTop = "4px";
          titleInput.style.padding = "4px 7px";
          titleInput.style.borderRadius = "8px";
          titleInput.style.border = "1px solid #1f2937";
          titleInput.style.background = "#020617";
          titleInput.style.color = "#e5e7eb";
          titleInput.style.fontSize = "12px";

          // Dates row
          const datesRow = document.createElement("div");
          datesRow.style.display = "flex";
          datesRow.style.gap = "6px";
          datesRow.style.marginTop = "6px";

          // Helper to convert various date formats to YYYY-MM-DD for date input
          function parseToDateValue(dateStr) {
            if (!dateStr || dateStr === "Unknown" || dateStr === "Not available") return "";
            // Try to parse the date
            const d = new Date(dateStr);
            if (!isNaN(d.getTime())) {
              return d.toISOString().split('T')[0];
            }
            // If already in YYYY-MM-DD format
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            return "";
          }

          const annInput = document.createElement("input");
          annInput.type = "date";
          annInput.title = "Announcement Date";
          annInput.id = `ev_${idx}_ann`;
          annInput.value = parseToDateValue(annDate);
          annInput.style.flex = "1";
          annInput.style.padding = "3px 7px";
          annInput.style.borderRadius = "999px";
          annInput.style.border = "1px solid #1f2937";
          annInput.style.background = "#020617";
          annInput.style.color = "#e5e7eb";
          annInput.style.fontSize = "11px";
          annInput.style.cursor = "pointer";

          const closedInput = document.createElement("input");
          closedInput.type = "date";
          closedInput.title = "Closed Date";
          closedInput.id = `ev_${idx}_closed`;
          closedInput.value = parseToDateValue(closed);
          closedInput.style.flex = "1";
          closedInput.style.padding = "3px 7px";
          closedInput.style.borderRadius = "999px";
          closedInput.style.border = "1px solid #1f2937";
          closedInput.style.background = "#020617";
          closedInput.style.color = "#e5e7eb";
          closedInput.style.fontSize = "11px";
          closedInput.style.cursor = "pointer";

          datesRow.appendChild(annInput);
          datesRow.appendChild(closedInput);

          // Type / status row
          const typeRow = document.createElement("div");
          typeRow.style.display = "flex";
          typeRow.style.gap = "6px";
          typeRow.style.marginTop = "6px";

          const typeSelect = document.createElement("select");
          typeSelect.id = `ev_${idx}_type`;
          typeSelect.style.flex = "1";
          typeSelect.style.padding = "3px 7px";
          typeSelect.style.borderRadius = "999px";
          typeSelect.style.border = "1px solid #1f2937";
          typeSelect.style.background = "#020617";
          typeSelect.style.color = "#e5e7eb";
          typeSelect.style.fontSize = "11px";
          DEAL_TYPES.forEach((opt) => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt || "Deal type";
            if (opt && opt.toLowerCase() === type.toLowerCase()) {
              o.selected = true;
            }
            typeSelect.appendChild(o);
          });

          const statusSelect = document.createElement("select");
          statusSelect.id = `ev_${idx}_status`;
          statusSelect.style.flex = "1";
          statusSelect.style.padding = "3px 7px";
          statusSelect.style.borderRadius = "999px";
          statusSelect.style.border = "1px solid #1f2937";
          statusSelect.style.background = "#020617";
          statusSelect.style.color = "#e5e7eb";
          statusSelect.style.fontSize = "11px";
          DEAL_STATUSES.forEach((opt) => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt || "Deal status";
            if (opt && opt.toLowerCase() === status.toLowerCase()) {
              o.selected = true;
            }
            statusSelect.appendChild(o);
          });

          typeRow.appendChild(typeSelect);
          typeRow.appendChild(statusSelect);

          // Source URL
          const sourceInput = document.createElement("input");
          sourceInput.type = "text";
          sourceInput.placeholder = "Source URL (press release / announcement)";
          sourceInput.id = `ev_${idx}_source`;
          sourceInput.value = source;
          sourceInput.style.width = "100%";
          sourceInput.style.marginTop = "6px";
          sourceInput.style.padding = "3px 7px";
          sourceInput.style.borderRadius = "999px";
          sourceInput.style.border = "1px solid #1f2937";
          sourceInput.style.background = "#020617";
          sourceInput.style.color = "#e5e7eb";
          sourceInput.style.fontSize = "11px";

          left.appendChild(titleLabel);
          left.appendChild(titleInput);
          left.appendChild(datesRow);
          left.appendChild(typeRow);
          left.appendChild(sourceInput);

          // RIGHT: Add to DB button
          const btn = document.createElement("button");
          btn.className = "primary";
          btn.style.padding = "5px 10px";
          btn.style.fontSize = "11px";
          btn.innerHTML = "üöÄ Add to DB";

          btn.addEventListener("click", () => {
            addEventToDb(ev, idx, btn);
          });

          titleRow.appendChild(left);
          titleRow.appendChild(btn);

          container.appendChild(titleRow);

          // Show original, non-editable summary line under fields
          const meta = document.createElement("div");
          meta.className = "event-meta";
          meta.style.marginTop = "4px";
          meta.innerHTML = `
            <span>üì¢ ${annDate}</span>
            ${
              closed && closed !== "Not available"
                ? `<span>‚Ä¢ ‚úÖ ${closed}</span>`
                : ""
            }
            <span>‚Ä¢ ${type}</span>
            ${status ? `<span>‚Ä¢ ${status}</span>` : ""}
          `;
          container.appendChild(meta);

          // Counterparties (read‚Äëonly display)
          const cps = ev.counterparties || [];
          if (cps.length) {
            const cpBlock = document.createElement("div");
            cpBlock.style.marginTop = "6px";
            cpBlock.style.fontSize = "11px";

            const cpTitle = document.createElement("div");
            cpTitle.style.marginBottom = "2px";
            cpTitle.style.color = "#9ca3af";
            cpTitle.textContent = `Counterparties (${cps.length})`;
            cpBlock.appendChild(cpTitle);

            cps.forEach((cp) => {
              const name = cp.company_name || "Unknown";
              const role =
                cp.role || cp.role_description || cp.type || "Counterparty";
              const link = cp.company_linkedin_url || "";
              const press = cp.press_release_url || "";
              const indiv = cp.individuals || [];

              const line = document.createElement("div");
              line.style.marginBottom = "2px";

              let html = `‚Ä¢ <strong>${name}</strong> <span style="opacity:0.75;">(${role})</span>`;
              if (press) {
                html += ` <a href="${press}" target="_blank" class="source-link">[Announcement]</a>`;
              }
              if (link) {
                html += ` <a href="${link}" target="_blank" class="source-link">[LinkedIn]</a>`;
              }
              line.innerHTML = html;
              cpBlock.appendChild(line);

              if (indiv.length) {
                const pplContainer = document.createElement("div");
                pplContainer.style.marginLeft = "10px";
                pplContainer.style.marginTop = "4px";
                
                const pplLabel = document.createElement("div");
                pplLabel.style.color = "#9ca3af";
                pplLabel.style.fontSize = "11px";
                pplLabel.style.marginBottom = "4px";
                pplLabel.textContent = "Key people:";
                pplContainer.appendChild(pplLabel);
                
                indiv.slice(0, 6).forEach((person, personIdx) => {
                  const personName = person.name || "Unknown";
                  const personTitle = person.title || person.job_title || "";
                  const personLinkedIn = person.linkedin_url || "";
                  
                  const personRow = document.createElement("div");
                  personRow.style.display = "flex";
                  personRow.style.alignItems = "center";
                  personRow.style.gap = "8px";
                  personRow.style.marginBottom = "3px";
                  personRow.style.marginLeft = "8px";
                  
                  // Person info
                  const personInfo = document.createElement("span");
                  personInfo.style.color = "#d1d5db";
                  personInfo.style.fontSize = "12px";
                  let personHtml = `üë§ <strong>${personName}</strong>`;
                  if (personTitle) {
                    personHtml += ` <span style="opacity:0.7;">‚Äì ${personTitle}</span>`;
                  }
                  if (personLinkedIn) {
                    personHtml += ` <a href="${personLinkedIn}" target="_blank" class="source-link">[LinkedIn]</a>`;
                  }
                  personInfo.innerHTML = personHtml;
                  personRow.appendChild(personInfo);
                  
                  // Add button for individual
                  const addBtn = document.createElement("button");
                  addBtn.textContent = "Add";
                  addBtn.style.padding = "2px 8px";
                  addBtn.style.fontSize = "10px";
                  addBtn.style.borderRadius = "4px";
                  addBtn.style.border = "1px solid rgba(99, 102, 241, 0.4)";
                  addBtn.style.background = "rgba(99, 102, 241, 0.15)";
                  addBtn.style.color = "#a5b4fc";
                  addBtn.style.cursor = "pointer";
                  addBtn.style.transition = "all 0.15s ease";
                  addBtn.onmouseover = () => {
                    addBtn.style.background = "rgba(99, 102, 241, 0.25)";
                    addBtn.style.borderColor = "rgba(99, 102, 241, 0.6)";
                  };
                  addBtn.onmouseout = () => {
                    addBtn.style.background = "rgba(99, 102, 241, 0.15)";
                    addBtn.style.borderColor = "rgba(99, 102, 241, 0.4)";
                  };
                  addBtn.onclick = async () => {
                    await addIndividualToDb(personName, personTitle, personLinkedIn, addBtn);
                  };
                  personRow.appendChild(addBtn);
                  
                  pplContainer.appendChild(personRow);
                });
                
                cpBlock.appendChild(pplContainer);
              }
            });

            container.appendChild(cpBlock);
          }

          // Advisors section for AI events
          const advisors = ev.advisors || [];
          if (advisors.length) {
            const advisorBlock = document.createElement("div");
            advisorBlock.style.marginTop = "8px";
            advisorBlock.style.padding = "8px";
            advisorBlock.style.background = "rgba(251, 191, 36, 0.08)";
            advisorBlock.style.borderRadius = "6px";
            advisorBlock.style.border = "1px solid rgba(251, 191, 36, 0.2)";
            advisorBlock.style.fontSize = "11px";

            const advisorHeading = document.createElement("div");
            advisorHeading.style.color = "#fbbf24";
            advisorHeading.style.marginBottom = "4px";
            advisorHeading.style.fontWeight = "600";
            advisorHeading.textContent = `üéØ Advisors (${advisors.length})`;
            advisorBlock.appendChild(advisorHeading);

            advisors.forEach((adv) => {
              const advName = adv.advisor_name || "Unknown Advisor";
              const advType = adv.advisor_type || "";
              const advisedParty = adv.advised_party || "";
              const advUrl = adv.announcement_url || "";

              const advRow = document.createElement("div");
              advRow.style.marginLeft = "8px";
              advRow.style.marginBottom = "3px";
              advRow.style.color = "#fcd34d";

              let advHtml = `‚Ä¢ <strong>${advName}</strong>`;
              if (advType) {
                advHtml += ` <span style="opacity:0.7;">(${advType})</span>`;
              }
              if (advisedParty) {
                advHtml += ` <span style="color:#9ca3af;">‚Üí advised ${advisedParty}</span>`;
              }
              if (advUrl) {
                advHtml += ` <a href="${advUrl}" target="_blank" class="source-link">[Link]</a>`;
              }

              advRow.innerHTML = advHtml;
              advisorBlock.appendChild(advRow);
            });

            container.appendChild(advisorBlock);
          }

          aiEventsEl.appendChild(container);
        });
      }

      function renderDBEvents(events) {
        dbEventsEl.innerHTML = "";
        if (!events || !events.length) {
          dbEventsEl.innerHTML =
            '<div class="empty-state">No events in database.</div>';
          dbMetaEl.textContent = "0 events";
          return;
        }
        dbMetaEl.textContent = `${events.length} event${
          events.length > 1 ? "s" : ""
        }`;

        events.forEach((ev) => {
          const card = document.createElement("div");
          card.className = "event-card";
          const desc = ev.description || "Unknown event";
          const ann = ev.announcement_date || "Unknown";
          const closed = ev.closed_date || "";
          const type = ev.deal_type || "Unknown";
          const status = ev.deal_status || "";
          const evDisplay = ev.ev_display || "";

          const metaPieces = [`üì¢ ${ann}`];
          if (closed) metaPieces.push(`‚úÖ ${closed}`);
          metaPieces.push(type);
          if (status) metaPieces.push(status);
          if (evDisplay) metaPieces.push(`üí∞ ${evDisplay}`);

          card.innerHTML = `
            <div class="event-title">${desc}</div>
            <div class="event-meta">
              ${metaPieces.map((m) => `<span>${m}</span>`).join("")}
            </div>
          `;

          // Counterparties from DB: target + other buckets if present
          const cpContainer = document.createElement("div");
          cpContainer.style.marginTop = "6px";
          cpContainer.style.fontSize = "11px";

          const target = ev.target_company;
          const cpLines = [];

          if (target && target.name) {
            const tUrl = target.counterparty_announcement_url || "";
            let tHtml = `‚Ä¢ <strong>${target.name}</strong> <span style="opacity:0.75;">(Target)</span>`;
            if (tUrl) {
              tHtml += ` <a href="${tUrl}" target="_blank" class="source-link">[Announcement]</a>`;
            }
            cpLines.push(tHtml);
          }

          const buckets = [
            "other_counterparties",
            "investors",
            "sellers",
            "buyers",
          ];
          buckets.forEach((key) => {
            const arr = ev[key] || [];
            arr.forEach((cp) => {
              const name = cp.name || "Unknown";
              const status = cp.counterparty_status || cp.role || "";
              const url = cp.counterparty_announcement_url || "";
              let html = `‚Ä¢ <strong>${name}</strong>`;
              if (status) {
                html += ` <span style="opacity:0.75;">(${status})</span>`;
              }
              if (url) {
                html += ` <a href="${url}" target="_blank" class="source-link">[Announcement]</a>`;
              }
              cpLines.push(html);
            });
          });

          if (cpLines.length) {
            const heading = document.createElement("div");
            heading.style.color = "#9ca3af";
            heading.style.marginBottom = "2px";
            heading.textContent = `Counterparties (${cpLines.length})`;
            cpContainer.appendChild(heading);

            cpLines.forEach((html) => {
              const line = document.createElement("div");
              line.innerHTML = html;
              cpContainer.appendChild(line);
            });

            card.appendChild(cpContainer);
          }

          // Advisors section for DB events
          const advisors = ev.advisors || [];
          if (advisors.length) {
            const advisorContainer = document.createElement("div");
            advisorContainer.style.marginTop = "8px";
            advisorContainer.style.fontSize = "11px";
            advisorContainer.style.padding = "8px";
            advisorContainer.style.background = "rgba(251, 191, 36, 0.08)";
            advisorContainer.style.borderRadius = "6px";
            advisorContainer.style.border = "1px solid rgba(251, 191, 36, 0.2)";

            const advisorHeading = document.createElement("div");
            advisorHeading.style.color = "#fbbf24";
            advisorHeading.style.marginBottom = "4px";
            advisorHeading.style.fontWeight = "600";
            advisorHeading.textContent = `üéØ Advisors (${advisors.length})`;
            advisorContainer.appendChild(advisorHeading);

            advisors.forEach((adv) => {
              const advCompany = adv.advisor_company || {};
              const advName = advCompany.name || "Unknown Advisor";
              const advUrl = adv.announcement_url || "";

              const advLine = document.createElement("div");
              advLine.style.marginLeft = "8px";
              advLine.style.marginBottom = "2px";
              let advHtml = `‚Ä¢ <strong>${advName}</strong>`;
              if (advUrl) {
                advHtml += ` <a href="${advUrl}" target="_blank" class="source-link">[Link]</a>`;
              }
              advLine.innerHTML = advHtml;
              advisorContainer.appendChild(advLine);
            });

            card.appendChild(advisorContainer);
          }

          dbEventsEl.appendChild(card);
        });
      }

      // Create company in database (when company doesn't exist)
      async function createCompanyInDb(button) {
        button.disabled = true;
        button.innerHTML = "‚è≥ Creating‚Ä¶";
        log("Creating company in database...", "warn");

        try {
          // Get values from AI overview form
          const nameInput = document.getElementById("ai_name");
          const cityInput = document.getElementById("ai_city");
          const countryInput = document.getElementById("ai_country");
          const websiteInput = document.getElementById("ai_website");
          const linkedinInput = document.getElementById("ai_linkedin");
          const descInput = document.getElementById("ai_description");

          const name = nameInput?.value?.trim() || "";
          const city = cityInput?.value?.trim() || "";
          const country = countryInput?.value?.trim() || "";
          const website = websiteInput?.value?.trim() || "";
          const linkedin = linkedinInput?.value?.trim() || "";
          const description = descInput?.value?.trim() || "";

          if (!name) {
            log("Error: Company name is required", "err");
            button.disabled = false;
            button.innerHTML = "‚ûï Create Company in Database";
            return;
          }

          // Step 1: Get location_id from city/country
          log(`Step 1: Getting location ID for ${city}, ${country}...`, "info");
          let locationId = 0;
          
          if (city || country) {
            try {
              const locUrl = `${XANO_BASE}/api:8Bv5PK4I/get_location?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}`;
              log(`GET ${locUrl}`, "info");
              
              const locRes = await fetch(locUrl, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
              });
              
              const locData = await locRes.json();
              log(`Location response: ${JSON.stringify(locData)}`, "info");
              
              if (locData && locData.id) {
                locationId = locData.id;
                log(`‚úÖ Got location ID: ${locationId}`, "ok");
              } else {
                log("‚ö†Ô∏è No location ID found, using 0", "warn");
              }
            } catch (locErr) {
              log(`‚ö†Ô∏è Location lookup failed: ${locErr.message}`, "warn");
            }
          }

          // Step 2: Create company with POST
          log(`Step 2: Creating company "${name}"...`, "info");
          
          const payload = {
            name: name,
            website: website,
            linkedin: linkedin,
            description: description,
            new_company_id: 0,  // Will be assigned by Xano
            locations_id: locationId,
          };
          
          log(`POST ${XANO_BASE}/api:8Bv5PK4I/post_company_overview`, "info");
          log(`Payload: ${JSON.stringify(payload)}`, "info");

          const res = await fetch(`${XANO_BASE}/api:8Bv5PK4I/post_company_overview`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const responseText = await res.text();
          log(`Response status: ${res.status}`, res.ok ? "ok" : "err");
          log(`Response: ${responseText}`, res.ok ? "ok" : "err");

          if (res.ok) {
            button.innerHTML = "‚úÖ Created!";
            button.style.background = "rgba(16, 185, 129, 0.3)";
            button.style.borderColor = "rgba(16, 185, 129, 0.6)";
            log(`‚úÖ Company "${name}" created successfully!`, "ok");
            
            // Parse response to get new company ID if available
            try {
              const resData = JSON.parse(responseText);
              if (resData.id || resData.new_company_id) {
                const newId = resData.id || resData.new_company_id;
                log(`New company ID: ${newId}`, "ok");
                // Update the Xano status badge
                updateXanoStatus({ id: newId }, { name: name });
              }
            } catch (e) {
              // Response might not be JSON
            }
            
            // Hide the create button after success
            setTimeout(() => {
              const container = document.getElementById("createInDbContainer");
              if (container) container.style.display = "none";
            }, 2000);
          } else {
            button.innerHTML = "‚ùå Failed";
            button.style.background = "rgba(239, 68, 68, 0.2)";
            button.style.borderColor = "rgba(239, 68, 68, 0.5)";
            button.style.color = "#fca5a5";
            log(`‚ùå Failed to create company: ${responseText}`, "err");
            
            // Re-enable button after delay
            setTimeout(() => {
              button.disabled = false;
              button.innerHTML = "‚ûï Create Company in Database";
              button.style.background = "rgba(16, 185, 129, 0.15)";
              button.style.borderColor = "rgba(16, 185, 129, 0.4)";
              button.style.color = "#6ee7b7";
            }, 3000);
          }
        } catch (err) {
          log(`‚ùå Error creating company: ${err.message}`, "err");
          button.disabled = false;
          button.innerHTML = "‚ûï Create Company in Database";
          button.style.background = "rgba(16, 185, 129, 0.15)";
          button.style.borderColor = "rgba(16, 185, 129, 0.4)";
          button.style.color = "#6ee7b7";
        }
      }

      // Add individual to database
      async function addIndividualToDb(name, bio, linkedinUrl, button) {
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = "‚è≥";
        log(`Adding individual "${name}" to database...`, "warn");

        try {
          // Step 1: Get location_id from AI overview city/country (if available)
          let locationId = 0;
          const cityInput = document.getElementById("ai_city");
          const countryInput = document.getElementById("ai_country");
          const city = cityInput?.value?.trim() || "";
          const country = countryInput?.value?.trim() || "";

          if (city || country) {
            try {
              const locUrl = `${XANO_BASE}/api:8Bv5PK4I/get_location?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}`;
              log(`GET location for ${city}, ${country}...`, "info");
              
              const locRes = await fetch(locUrl, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
              });
              
              const locData = await locRes.json();
              
              if (locData && locData.id) {
                locationId = locData.id;
                log(`Got location ID: ${locationId}`, "ok");
              } else {
                log("No location ID found, using 0", "warn");
              }
            } catch (locErr) {
              log(`Location lookup failed: ${locErr.message}`, "warn");
            }
          }

          // Step 2: POST individual
          const payload = {
            name: name || "",
            bio: bio || "",  // Using title/job as bio
            linkedin_URL: linkedinUrl || "",
            locations_id: locationId,
          };

          log(`POST ${XANO_BASE}/api:8Bv5PK4I/post_individual`, "info");
          log(`Payload: ${JSON.stringify(payload)}`, "info");

          const res = await fetch(`${XANO_BASE}/api:8Bv5PK4I/post_individual`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const responseText = await res.text();
          log(`Response status: ${res.status}`, res.ok ? "ok" : "err");
          log(`Response: ${responseText}`, res.ok ? "ok" : "err");

          if (res.ok) {
            button.textContent = "‚úÖ";
            button.style.background = "rgba(16, 185, 129, 0.3)";
            button.style.borderColor = "rgba(16, 185, 129, 0.6)";
            button.style.color = "#6ee7b7";
            log(`‚úÖ Individual "${name}" added successfully!`, "ok");
            
            // Keep button disabled after success
          } else {
            button.textContent = "‚ùå";
            button.style.background = "rgba(239, 68, 68, 0.2)";
            button.style.borderColor = "rgba(239, 68, 68, 0.5)";
            button.style.color = "#fca5a5";
            log(`‚ùå Failed to add individual: ${responseText}`, "err");
            
            // Re-enable button after delay
            setTimeout(() => {
              button.disabled = false;
              button.textContent = originalText;
              button.style.background = "rgba(99, 102, 241, 0.15)";
              button.style.borderColor = "rgba(99, 102, 241, 0.4)";
              button.style.color = "#a5b4fc";
            }, 3000);
          }
        } catch (err) {
          log(`‚ùå Error adding individual: ${err.message}`, "err");
          button.disabled = false;
          button.textContent = originalText;
          button.style.background = "rgba(99, 102, 241, 0.15)";
          button.style.borderColor = "rgba(99, 102, 241, 0.4)";
          button.style.color = "#a5b4fc";
        }
      }

      async function addEventToDb(eventObj, idx, button) {
        button.disabled = true;
        button.textContent = "‚è≥ Sending‚Ä¶";
        log(
          `Sending AI event #${idx + 1} to Xano /create_corporate_event‚Ä¶`,
          "warn"
        );

        // Prefer edited values from inputs; fall back to original AI object
        const titleInput = document.getElementById(`ev_${idx}_title`);
        const annInput = document.getElementById(`ev_${idx}_ann`);
        const closedInput = document.getElementById(`ev_${idx}_closed`);
        const typeSelect = document.getElementById(`ev_${idx}_type`);
        const statusSelect = document.getElementById(`ev_${idx}_status`);
        const sourceInput = document.getElementById(`ev_${idx}_source`);

        const title =
          (titleInput && titleInput.value.trim()) ||
          eventObj["Event (short)"] ||
          eventObj.event_short ||
          "";
        const annDate =
          (annInput && annInput.value.trim()) ||
          eventObj["Announcement Date"] ||
          eventObj.announcement_date ||
          "";
        const closedRaw =
          (closedInput && closedInput.value.trim()) ||
          eventObj["Closed Date"] ||
          eventObj.closed_date ||
          "";
        const dealType =
          (typeSelect && typeSelect.value) ||
          eventObj["Deal Type"] ||
          eventObj.deal_type ||
          eventObj["Event type"] ||
          eventObj.event_type ||
          "Acquisition";
        const dealStatus =
          (statusSelect && statusSelect.value) ||
          eventObj["Deal Status"] ||
          eventObj.deal_status ||
          "Completed";
        const sourceUrl =
          (sourceInput && sourceInput.value.trim()) ||
          eventObj["Source URL"] ||
          eventObj.source_url ||
          "";
        const counterparties = eventObj.counterparties || [];

        const payload = {
          title: title || "Untitled Event",
          // Xano expects a human‚Äëreadable description ‚Äì use the same string
          description: title || "Untitled Event",
          announcement_date: annDate || "2024-01-01",
          closed_date: closedRaw || null,
          deal_type: dealType,
          deal_status: dealStatus,
          investment_amount: "",
          currency_id: 15,
          counterparties: (counterparties || []).map((cp) => {
            const individuals =
              (cp.individuals || []).map((ind) => ({
                name: ind.name || "",
                job_title: ind.title || "",
              })) || [];
            return {
              name: cp.company_name || "",
              role:
                cp.role ||
                cp.role_description ||
                "Target",
              announcement_url: sourceUrl || cp.press_release_url || "",
              linkedin_url: cp.company_linkedin_url || "",
              individuals,
            };
          }),
        };

        const endpoint = `${XANO_BASE}/api:617tZc8l/create_corporate_event`;
        log(`POST ${endpoint}`, "info");

        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const text = await res.text();
          log(`HTTP ${res.status}: ${text.slice(0, 200)}`, "info");
          let parsed;
          try {
            parsed = JSON.parse(text);
          } catch (e) {}

          if (parsed && parsed.success) {
            button.textContent = "‚úÖ Added";
            button.style.background = "linear-gradient(135deg,#22c55e,#16a34a)";
            log(
              `Success: event_id=${parsed.event_id}, counterparties=${parsed.total_counterparties}`,
              "ok"
            );
          } else {
            button.textContent = "‚ùå Failed";
            button.style.background =
              "linear-gradient(135deg,#ef4444,#b91c1c)";
            log(
              `Xano error: ${
                parsed ? JSON.stringify(parsed) : text || "Unknown error"
              }`,
              "err"
            );
            setTimeout(() => {
              button.disabled = false;
              button.textContent = "üöÄ Retry";
              button.style.background =
                "linear-gradient(135deg,#6366f1,#8b5cf6)";
            }, 3500);
          }
        } catch (err) {
          log(`Fetch error: ${err.message}`, "err");
          button.textContent = "‚ùå Error";
          button.style.background =
            "linear-gradient(135deg,#ef4444,#b91c1c)";
          setTimeout(() => {
            button.disabled = false;
            button.textContent = "üöÄ Retry";
            button.style.background =
              "linear-gradient(135deg,#6366f1,#8b5cf6)";
          }, 3500);
        }
      }

      async function runAnalyze() {
        const query = queryInput.value.trim();
        if (!query) {
          alert("Please enter a company URL or name.");
          return;
        }

        clearEvents();
        resetXanoStatus();  // Hide the status badge while loading
        aiMetaEl.textContent = "Loading‚Ä¶";
        dbMetaEl.textContent = "Loading‚Ä¶";
        logEl.innerHTML = "";
        setStatus("Analyzing‚Ä¶", "info");
        log(`Starting analysis for: "${query}"`, "info");

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = "‚è≥ Analyzing‚Ä¶";

        try {
          const res = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
          });

          const json = await res.json();
          if (!res.ok) {
            log(`Backend error: ${JSON.stringify(json)}`, "err");
            setStatus("Error", "err");
            aiEventsEl.innerHTML =
              '<div class="empty-state">Backend error ‚Äì check logs.</div>';
            dbEventsEl.innerHTML =
              '<div class="empty-state">No DB data.</div>';
            return;
          }

          const {
            existing_company,
            db_company,
            db_overview,
            ai_overview,
            db_events,
            ai_events,
            missing_events,
            matched_events,
          } = json;

          // Update the prominent Xano status badge
          updateXanoStatus(existing_company, db_company);

          if (existing_company && existing_company.id) {
            dbMetaEl.textContent = `Company ID ${existing_company.id}`;
            log(
              `Company exists in DB (id=${existing_company.id}). Events: ${
                (db_events || []).length
              }`,
              "ok"
            );
          } else {
            dbMetaEl.textContent = "Company not found in DB";
            log("Company not found in DB ‚Äì AI-only mode.", "warn");
          }

          renderAIOverview(ai_overview || null);
          renderDBOverview(db_overview || null);
          renderAIEvents(ai_events || [], missing_events || []);
          renderDBEvents(db_events || []);
          renderTopManagement(json.top_management || []);

          const aiCount = (ai_events || []).length;
          const dbCount = (db_events || []).length;
          const mgmtCount = (json.top_management || []).length;
          log(
            `AI events: ${aiCount}, DB events: ${dbCount}, matched: ${
              (matched_events || []).length
            }, missing: ${(missing_events || []).length}, executives: ${mgmtCount}`,
            "ok"
          );
          setStatus("Done", "ok");
        } catch (err) {
          log(`Fetch /analyze error: ${err.message}`, "err");
          setStatus("Error", "err");
        } finally {
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = "üöÄ Analyze";
        }
      }

      analyzeBtn.addEventListener("click", runAnalyze);
      queryInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          runAnalyze();
        }
      });
    </script>
  </body>
</html>


