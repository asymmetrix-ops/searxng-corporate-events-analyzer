<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SearXNG ‚Äì Events UI (No Streamlit)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #050816;
        --bg-card: #0b1020;
        --bg-pill: #111827;
        --accent: #6366f1;
        --accent-soft: #4f46e5;
        --accent-danger: #ef4444;
        --accent-success: #10b981;
        --border-subtle: #1f2937;
        --text: #e5e7eb;
        --muted: #9ca3af;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
        color: var(--text);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          sans-serif;
      }

      .shell {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
      }

      .title-block h1 {
        font-size: 24px;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .title-block p {
        margin: 4px 0 0;
        font-size: 13px;
        color: var(--muted);
      }

      .badge {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 118, 110, 0.15);
        color: #5eead4;
        border: 1px solid rgba(45, 212, 191, 0.35);
      }

      .panel {
        background: rgba(15, 23, 42, 0.95);
        border-radius: 18px;
        padding: 16px 18px 14px;
        box-shadow: 0 10px 40px rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(55, 65, 81, 0.85);
        backdrop-filter: blur(16px);
      }

      .input-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 4px;
      }

      .chip {
        font-size: 11px;
        padding: 2px 9px;
        border-radius: 999px;
        background: var(--bg-pill);
        color: var(--muted);
        border: 1px solid #1f2937;
      }

      input[type="text"] {
        flex: 1;
        padding: 9px 11px;
        border-radius: 999px;
        border: 1px solid #1e293b;
        background: radial-gradient(circle at top left, #020617, #020617 55%, #020617);
        color: var(--text);
        font-size: 13px;
        outline: none;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      }

      input[type="text"]::placeholder {
        color: #4b5563;
      }

      button.primary {
        padding: 8px 18px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.55);
        transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
      }

      button.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 34px rgba(79, 70, 229, 0.7);
      }

      button.primary:disabled {
        opacity: 0.5;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      .hint-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-top: 4px;
      }

      .hint-row small {
        color: var(--muted);
        font-size: 11px;
      }

      .hint-row code {
        background: rgba(15, 23, 42, 0.85);
        border-radius: 999px;
        padding: 2px 8px;
        border: 1px solid #1f2937;
      }

      .split {
        display: grid;
        grid-template-columns: 1.15fr 1fr;
        gap: 18px;
        margin-top: 20px;
      }

      .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .pill {
        font-size: 11px;
        padding: 3px 9px;
        border-radius: 999px;
        background: #020617;
        border: 1px solid #111827;
        color: #9ca3af;
      }

      .events-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .event-card {
        border-radius: 14px;
        padding: 16px 18px;
        background: radial-gradient(circle at top left, #020617 0, #020617 47%, #020617 100%);
        border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .event-title-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
      }

      /* Improved form inputs */
      .form-group {
        margin-bottom: 12px;
      }
      .form-label {
        display: block;
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 4px;
        font-weight: 500;
      }
      .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #374151;
        background: #0f172a;
        color: #e5e7eb;
        font-size: 13px;
        transition: all 0.15s ease;
      }
      .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      }
      .form-input::placeholder, textarea.form-input::placeholder {
        color: #6b7280;
      }
      textarea.form-input {
        font-family: inherit;
        line-height: 1.5;
      }
      .form-row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
      }
      .form-row > * {
        flex: 1;
      }
      
      /* Counterparty cards */
      .counterparty-card {
        background: rgba(31, 41, 55, 0.4);
        border: 1px solid rgba(55, 65, 81, 0.6);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 10px;
      }
      .counterparty-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .counterparty-name {
        font-weight: 600;
        color: #e5e7eb;
        font-size: 14px;
      }
      .counterparty-role {
        font-size: 11px;
        padding: 3px 10px;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.15);
        color: #a5b4fc;
        border: 1px solid rgba(99, 102, 241, 0.3);
      }
      .counterparty-expand-btn {
        background: transparent;
        border: 1px solid rgba(99, 102, 241, 0.3);
        color: #a5b4fc;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .counterparty-expand-btn:hover {
        background: rgba(99, 102, 241, 0.15);
        border-color: rgba(99, 102, 241, 0.5);
      }
      .counterparty-details {
        display: none;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(55, 65, 81, 0.6);
      }
      .counterparty-details.expanded {
        display: block;
      }
      
      /* Save button styles */
      .save-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .save-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }
      .save-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .event-title {
        font-size: 13px;
        font-weight: 600;
      }

      .event-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
        font-size: 11px;
        color: var(--muted);
      }

      .tag {
        padding: 2px 7px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid #1f2937;
      }

      .log-panel {
        margin-top: 16px;
        border-radius: 12px;
        background: #020617;
        border: 1px solid #1f2937;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        max-height: 180px;
        overflow-y: auto;
        padding: 8px 9px;
      }

      .log-line {
        margin: 1px 0;
      }

      .log-line.info {
        color: #93c5fd;
      }

      .log-line.warn {
        color: #fbbf24;
      }

      .log-line.ok {
        color: #6ee7b7;
      }

      .log-line.err {
        color: #fca5a5;
      }

      .empty-state {
        font-size: 12px;
        color: var(--muted);
        padding: 10px 8px;
      }

      .source-link {
        font-size: 11px;
        color: #93c5fd;
        text-decoration: none;
      }

      .source-link:hover {
        text-decoration: underline;
      }

      /* Date input styling for dark mode */
      input[type="date"] {
        color-scheme: dark;
      }
      
      input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(0.8);
        cursor: pointer;
      }

      @media (max-width: 900px) {
        .split {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="header">
        <div class="title-block">
          <h1>
            üß≠ SearXNG
            <span style="font-weight: 500; opacity: 0.8"
              >‚Äì Corporate Events Console</span
            >
          </h1>
          <p>
            Side‚Äëby‚Äëside AI vs Database comparison with
            <strong>non‚Äërefreshing</strong> ‚ÄúAdd to DB‚Äù buttons.
          </p>
        </div>
        <div class="badge">beta ‚Äì fastapi ui (no streamlit)</div>
      </header>

      <section class="panel">
        <div class="input-row">
          <span class="chip">1</span>
          <input
            id="queryInput"
            type="text"
            placeholder="Enter company URL or name, e.g. https://heliointelligence.com/"
          />
          <button id="analyzeBtn" class="primary">
            <span>üöÄ Analyze</span>
          </button>
        </div>
        <div class="hint-row">
          <small
            >If the URL exists in Xano, we'll fetch DB events and compare to AI
            events.</small
          >
          <small id="dbStatusBadge" style="display: none;"></small>
        </div>
        <!-- Database Status Badge -->
        <div id="xanoStatusContainer" style="margin-top: 12px; display: none;">
          <div id="xanoStatusBadge" style="
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
          ">
            <span id="xanoStatusIcon"></span>
            <span id="xanoStatusText"></span>
          </div>
        </div>
      </section>

      <!-- Company Overview -->
      <section class="split" style="margin-top: 18px; margin-bottom: 8px">
        <div>
          <div class="column-header">
            <div>
              <strong>ü§ñ AI Company Overview</strong>
              <span id="aiOverviewMeta" class="pill">Waiting for query‚Ä¶</span>
            </div>
          </div>
          <div id="aiOverview" class="events-list">
            <div class="empty-state">
              Run an analysis to populate AI‚Äëgenerated company overview here.
            </div>
          </div>
        </div>
        <div>
          <div class="column-header">
            <div>
              <strong>üóÑÔ∏è Database Company Overview</strong>
              <span id="dbOverviewMeta" class="pill">No company loaded</span>
            </div>
          </div>
          <div id="dbOverview" class="events-list">
            <div class="empty-state">
              If the company exists in Xano, its overview will appear here.
            </div>
          </div>
        </div>
      </section>

      <!-- Key People / Top Management Section (ABOVE Events) -->
      <section class="split">
        <!-- AI Column - Top Management -->
        <div>
          <div class="column-header">
            <div>
              <strong>ü§ñ AI Key People</strong>
              <span id="mgmtMeta" class="pill">Waiting for query‚Ä¶</span>
            </div>
          </div>
          <div id="topManagement" class="events-list">
            <div class="empty-state">
              Run an analysis to see AI‚Äëdiscovered company leadership here.
            </div>
          </div>
        </div>

        <!-- DB Column - Management from Xano -->
        <div>
          <div class="column-header">
            <div>
              <strong>üóÑÔ∏è DB Key People</strong>
              <span id="dbMgmtMeta" class="pill">No company loaded</span>
            </div>
          </div>
          <div id="dbManagement" class="events-list">
            <div class="empty-state">
              If the company exists in Xano, its key people will appear here.
            </div>
          </div>
        </div>
      </section>

      <!-- Events -->
      <section class="split">
        <!-- AI Column -->
        <div>
          <div class="column-header">
            <div>
              <strong>ü§ñ AI Events</strong>
              <span id="aiMeta" class="pill">Waiting for query‚Ä¶</span>
            </div>
          </div>
          <div id="aiEvents" class="events-list">
            <div class="empty-state">
              Run an analysis to see AI‚Äëdiscovered corporate events here.
            </div>
          </div>
        </div>

        <!-- DB Column -->
        <div>
          <div class="column-header">
            <div>
              <strong>üóÑÔ∏è Database Events</strong>
              <span id="dbMeta" class="pill">No company loaded</span>
            </div>
          </div>
          <div id="dbEvents" class="events-list">
            <div class="empty-state">
              If the company exists in Xano, its events will appear here.
            </div>
          </div>
        </div>
      </section>

      <section style="margin-top: 18px">
        <div class="column-header">
          <div>
            <strong>üì° API Log</strong>
          </div>
          <span class="pill" id="statusPill">Idle</span>
        </div>
        <div id="log" class="log-panel"></div>
      </section>
    </div>

    <script>
      const analyzeBtn = document.getElementById("analyzeBtn");
      const queryInput = document.getElementById("queryInput");
      const aiEventsEl = document.getElementById("aiEvents");
      const dbEventsEl = document.getElementById("dbEvents");
      const aiMetaEl = document.getElementById("aiMeta");
      const dbMetaEl = document.getElementById("dbMeta");
      const aiOverviewEl = document.getElementById("aiOverview");
      const dbOverviewEl = document.getElementById("dbOverview");
      const aiOverviewMeta = document.getElementById("aiOverviewMeta");
      const dbOverviewMeta = document.getElementById("dbOverviewMeta");
      const logEl = document.getElementById("log");
      const statusPill = document.getElementById("statusPill");
      const xanoStatusContainer = document.getElementById("xanoStatusContainer");
      const xanoStatusBadge = document.getElementById("xanoStatusBadge");
      const xanoStatusIcon = document.getElementById("xanoStatusIcon");
      const xanoStatusText = document.getElementById("xanoStatusText");
      const topManagementEl = document.getElementById("topManagement");
      const mgmtMetaEl = document.getElementById("mgmtMeta");
      const dbManagementEl = document.getElementById("dbManagement");
      const dbMgmtMetaEl = document.getElementById("dbMgmtMeta");

      const XANO_BASE = "{{ xano_base_url }}";

      // Business Focus Categories (from server.py)
      const BUSINESS_FOCUS_CATEGORIES = {
        74: "Financial Services",
        75: "Data & Analytics",
        76: "Software",
        77: "Business Services",
        78: "Consumer Internet",
        79: "Consumer Media",
        80: "Aerospace",
        81: "Food",
        82: "Insurance",
        83: "Satellites",
        84: "Events",
        85: "Retail",
        86: "Wholesale",
        87: "Industrials",
        88: "Agriculture",
        89: "Telecommunications",
        90: "Healthcare",
        91: "Law",
        92: "Pharmaceuticals",
        93: "Education & Training",
        94: "Real Estate",
        95: "Defence",
        96: "Entertainment",
        97: "Medical Equipment",
        98: "Laboratory Equipment",
        99: "Shipping",
        100: "Academic Publishing",
        101: "Trade Association",
        102: "Fitness",
        103: "Chemicals",
        104: "Not-for-Profit",
        105: "Semiconductors",
        106: "Natural Resources",
        107: "Power Generation",
        108: "Consumer Electronics",
        109: "Energy & Commodities",
        110: "Crypto",
        111: "Engineering",
        112: "Aviation",
        113: "Automotive",
        114: "Digital Infrastructure",
        115: "Professional Body",
        117: "Manufacturing",
        118: "Marketplace",
        119: "Business Media",
        120: "Government Agency",
        121: "Real Estate Broker"
      };

      // Smart keyword mapping for intelligent suggestions
      const BUSINESS_FOCUS_KEYWORDS = {
        "Financial Services": [
          "fintech", "banking", "payments", "lending", "credit", "investment", "wealth management",
          "financial technology", "digital banking", "peer-to-peer lending", "crowdfunding",
          "asset management", "trading", "securities", "capital markets", "fintech", "neo bank"
        ],
        "Data & Analytics": [
          "data analytics", "big data", "business intelligence", "data science", "machine learning",
          "ai analytics", "predictive analytics", "data visualization", "data mining", "data platform",
          "analytics software", "data management", "data processing", "data insights"
        ],
        "Software": [
          "saas", "software as a service", "enterprise software", "cloud software", "application development",
          "software development", "api", "platform", "digital platform", "tech platform", "b2b software"
        ],
        "Business Services": [
          "consulting", "professional services", "b2b services", "business consulting", "management consulting",
          "strategy consulting", "digital transformation", "business process", "outsourcing", "business solutions"
        ],
        "Consumer Internet": [
          "e-commerce", "online marketplace", "consumer app", "mobile app", "social media", "content platform",
          "consumer technology", "user experience", "consumer engagement", "digital consumer"
        ],
        "Healthcare": [
          "healthcare", "medical technology", "health tech", "patient care", "clinical", "medical devices",
          "health informatics", "telemedicine", "digital health", "healthcare technology", "medical ai"
        ],
        "Pharmaceuticals": [
          "pharmaceuticals", "drug development", "biotech", "life sciences", "drug discovery",
          "clinical trials", "pharma", "biopharmaceuticals", "therapeutics", "medicines"
        ],
        "Telecommunications": [
          "telecom", "telecommunications", "5g", "network infrastructure", "communication technology",
          "wireless", "fiber optics", "satellite communications", "iot connectivity"
        ],
        "Manufacturing": [
          "manufacturing", "industrial", "production", "factory automation", "supply chain",
          "industrial technology", "smart manufacturing", "industry 4.0"
        ],
        "Automotive": [
          "automotive", "electric vehicles", "autonomous driving", "mobility", "connected car",
          "vehicle technology", "transportation", "auto industry"
        ],
        "Aerospace": [
          "aerospace", "aviation", "space", "satellite", "drone", "aeronautics", "space technology"
        ],
        "Defence": [
          "defense", "military", "security", "cybersecurity", "surveillance", "defense technology"
        ],
        "Energy & Commodities": [
          "energy", "renewable energy", "oil & gas", "commodities", "solar", "wind energy",
          "clean energy", "energy storage", "mining", "natural resources"
        ],
        "Real Estate": [
          "real estate", "property", "proptech", "real estate technology", "property management",
          "commercial real estate", "residential real estate"
        ],
        "Retail": [
          "retail", "e-commerce", "consumer goods", "shopping", "retail technology", "brick and mortar"
        ],
        "Education & Training": [
          "education", "e-learning", "online learning", "training", "educational technology", "edtech"
        ],
        "Insurance": [
          "insurance", "insurtech", "risk management", "underwriting", "claims processing"
        ],
        "Food": [
          "food", "agritech", "food technology", "nutrition", "food delivery", "food safety"
        ],
        "Entertainment": [
          "entertainment", "gaming", "media", "content", "streaming", "digital entertainment"
        ]
      };

      // Global state flags (initialize early)
      window._companyExistsInDb = false;
      window._dbDescription = null;
      window._dbOverviewData = null;  // Store full DB overview for copy buttons
      window._dbCompanyId = null;     // Store company ID for save operations
      window._companyId = null;       // Store company ID for individual creation

      // Global job title lookup function (reused by individual operations)
      // Returns array of job title IDs (can be multiple for compound titles)
      window.lookupJobTitles = async (titleText) => {
        if (!titleText) return [];

        // Job title normalization mappings - map long forms to short forms that exist in DB
        const titleNormalization = {
          "Chief Executive Officer": "CEO",
          "Chief Operating Officer": "COO",
          "Chief Technology Officer": "CTO",
          "Chief Financial Officer": "CFO",
          "Chief Marketing Officer": "CMO",
          "Chief Product Officer": "CPO",
          "Co-Founder": "Co-Founder",
          "Co Founder": "Co-Founder",
          "Co-founder": "Co-Founder",
          "Vice President": "VP"
        };

        // Split compound titles by common separators
        const separators = [" & ", " and ", ", ", " / ", " | "];
        let titleParts = [titleText];

        for (const separator of separators) {
          if (titleText.includes(separator)) {
            titleParts = titleText.split(separator).map(p => p.trim()).filter(Boolean);
            log(`üîÄ Split compound title: "${titleText}" ‚Üí [${titleParts.join(", ")}]`, "info");
            break;
          }
        }

        const foundJobTitleIds = [];
        const foundTitles = [];

        // Try each title part
        for (const originalPart of titleParts) {
          log(`üîç Processing title part: "${originalPart}"`, "info");

          // First try normalized version (CEO instead of Chief Executive Officer)
          const normalizedPart = titleNormalization[originalPart] || originalPart;

          // Try normalized version first (most likely to work)
          if (normalizedPart !== originalPart) {
            log(`üîÑ Trying normalized version: "${originalPart}" ‚Üí "${normalizedPart}"`, "info");
          }

          const searchTerms = normalizedPart !== originalPart ?
            [normalizedPart, originalPart] : [originalPart];

          let foundForThisPart = false;

          for (const searchTerm of searchTerms) {
            if (foundForThisPart) break; // Already found for this part

            try {
              const jobTitleUrl = `${XANO_BASE}/api:8Bv5PK4I/job_title_lookup?job_title=${encodeURIComponent(searchTerm)}`;
              const jobTitleRes = await fetch(jobTitleUrl, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
              });

              if (jobTitleRes.ok) {
                const jobTitleData = await jobTitleRes.json();
                if (jobTitleData && jobTitleData.id && !foundJobTitleIds.includes(jobTitleData.id)) {
                  foundJobTitleIds.push(jobTitleData.id);
                  foundTitles.push(searchTerm);
                  foundForThisPart = true;
                  log(`‚úÖ Found job title ID: ${jobTitleData.id} for "${searchTerm}"`, "ok");
                }
              }
            } catch (jobTitleErr) {
              log(`‚ö†Ô∏è Job title lookup error for "${searchTerm}": ${jobTitleErr.message}`, "warn");
            }
          }
        }

        if (foundJobTitleIds.length > 0) {
          log(`üéØ Found job title IDs: [${foundJobTitleIds.join(", ")}] for titles: [${foundTitles.join(", ")}]`, "ok");
          return foundJobTitleIds;
        } else {
          log(`‚ö†Ô∏è No job title IDs found for: "${titleText}"`, "warn");
          return [];
        }
      };

      // Global location lookup function (reused by company and individual operations)
      window.lookupLocation = async (city, country) => {
        if (!city && !country) return 0;

        // Normalize country before lookup
        const normalizedCountry = normalizeCountry(country || "");
        if (normalizedCountry !== country && country) {
          log(`üìç Normalized country: "${country}" ‚Üí "${normalizedCountry}"`, "info");
        }

        try {
          const locUrl = `${XANO_BASE}/api:8Bv5PK4I/get_location?city=${encodeURIComponent(city || "")}&country=${encodeURIComponent(normalizedCountry || "")}`;
          log(`GET location for ${city || ""}, ${normalizedCountry || ""}...`, "info");

          const locRes = await fetch(locUrl, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });

          const locData = await locRes.json();

          if (locData) {
            // Try direct id field
            if (locData.id && typeof locData.id === 'number') {
              log(`‚úÖ Found location ID in 'id' field: ${locData.id}`, "ok");
              return locData.id;
            }
            // Try locations_id field
            else if (locData.locations_id && typeof locData.locations_id === 'number') {
              log(`‚úÖ Found location ID in 'locations_id' field: ${locData.locations_id}`, "ok");
              return locData.locations_id;
            }
            // Try nested structures
            else if (locData.location && locData.location.id && typeof locData.location.id === 'number') {
              log(`‚úÖ Found location ID in 'location.id' field: ${locData.location.id}`, "ok");
              return locData.location.id;
            }
            else if (locData._locations && locData._locations.id && typeof locData._locations.id === 'number') {
              log(`‚úÖ Found location ID in '_locations.id' field: ${locData._locations.id}`, "ok");
              return locData._locations.id;
            }
            else {
              log(`‚ö†Ô∏è Location response: ${JSON.stringify(locData)}`, "warn");
              log(`‚ö†Ô∏è Location ID not found in response`, "warn");
              return 0;
            }
          } else {
            log("‚ö†Ô∏è No location data found", "warn");
            return 0;
          }
        } catch (locErr) {
          log(`‚ö†Ô∏è Location lookup failed: ${locErr.message}`, "warn");
          return 0;
        }
      };

      // Helper: Create a small copy button for a field
      function createCopyBtn(fieldId, dbFieldName, label) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.title = `Copy ${label} from DB`;
        btn.innerHTML = "üìã";
        btn.style.padding = "2px 6px";
        btn.style.fontSize = "10px";
        btn.style.borderRadius = "4px";
        btn.style.border = "1px solid rgba(99, 102, 241, 0.3)";
        btn.style.background = "rgba(99, 102, 241, 0.1)";
        btn.style.color = "#a5b4fc";
        btn.style.cursor = "pointer";
        btn.style.marginLeft = "4px";
        btn.style.transition = "all 0.15s ease";
        btn.style.display = "none"; // Hidden until DB data is loaded
        btn.className = "copy-from-db-btn";
        btn.dataset.fieldId = fieldId;
        btn.dataset.dbField = dbFieldName;
        
        btn.onmouseover = () => {
          btn.style.background = "rgba(99, 102, 241, 0.25)";
          btn.style.borderColor = "rgba(99, 102, 241, 0.5)";
        };
        btn.onmouseout = () => {
          btn.style.background = "rgba(99, 102, 241, 0.1)";
          btn.style.borderColor = "rgba(99, 102, 241, 0.3)";
        };
        btn.onclick = () => {
          if (window._dbOverviewData && window._dbOverviewData[dbFieldName]) {
            const input = document.getElementById(fieldId);
            if (input) {
              if (input.tagName === "SELECT") {
                // For select, try to find matching option
                const dbVal = window._dbOverviewData[dbFieldName].toLowerCase();
                for (let opt of input.options) {
                  if (opt.value.toLowerCase() === dbVal) {
                    input.value = opt.value;
                    break;
                  }
                }
              } else {
                input.value = window._dbOverviewData[dbFieldName];
              }
              // Visual feedback
              btn.innerHTML = "‚úÖ";
              btn.style.background = "rgba(16, 185, 129, 0.2)";
              btn.style.borderColor = "rgba(16, 185, 129, 0.5)";
              setTimeout(() => {
                btn.innerHTML = "üìã";
                btn.style.background = "rgba(99, 102, 241, 0.1)";
                btn.style.borderColor = "rgba(99, 102, 241, 0.3)";
              }, 1000);
            }
          }
        };
        return btn;
      }

      // Show all copy buttons when DB data is available
      function showCopyButtons() {
        document.querySelectorAll(".copy-from-db-btn").forEach(btn => {
          const dbField = btn.dataset.dbField;
          if (window._dbOverviewData && window._dbOverviewData[dbField]) {
            btn.style.display = "inline-block";
          }
        });
      }

      // Helper: Create a save button for a field (only for existing companies)
      // Normalize country names for location lookup
      function normalizeCountry(country) {
        if (!country) return country;
        const countryUpper = country.toUpperCase().trim();
        if (countryUpper === "UK" || countryUpper === "U.K." || countryUpper === "U.K") {
          return "United Kingdom";
        } else if (countryUpper === "USA" || countryUpper === "US" || countryUpper === "U.S." || countryUpper === "U.S.A." || countryUpper === "U.S.A") {
          return "United States";
        }
        return country; // Return as-is if no normalization needed
      }

      function createSaveBtn(fieldId, apiFieldName, label) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.title = `Save ${label} to DB`;
        btn.innerHTML = "üíæ";
        btn.style.padding = "2px 6px";
        btn.style.fontSize = "10px";
        btn.style.borderRadius = "4px";
        btn.style.border = "1px solid rgba(16, 185, 129, 0.3)";
        btn.style.background = "rgba(16, 185, 129, 0.1)";
        btn.style.color = "#6ee7b7";
        btn.style.cursor = "pointer";
        btn.style.marginLeft = "4px";
        btn.style.transition = "all 0.15s ease";
        btn.style.display = "none"; // Hidden until company exists in DB
        btn.className = "save-to-db-btn";
        btn.dataset.fieldId = fieldId;
        btn.dataset.apiField = apiFieldName;
        
        btn.onmouseover = () => {
          btn.style.background = "rgba(16, 185, 129, 0.25)";
          btn.style.borderColor = "rgba(16, 185, 129, 0.5)";
        };
        btn.onmouseout = () => {
          btn.style.background = "rgba(16, 185, 129, 0.1)";
          btn.style.borderColor = "rgba(16, 185, 129, 0.3)";
        };
        btn.onclick = async () => {
          if (!window._dbCompanyId) {
            log("No company ID - cannot save", "err");
            return;
          }
          
          const input = document.getElementById(fieldId);
          if (!input) return;
          
          let value = input.tagName === "SELECT" ? input.value : input.value.trim();
          
          // Build updates object
          let updates = {};
          
          // Handle special field mappings
          if (apiFieldName === "linkedin") {
            updates = {
              linkedin_data: {
                LinkedIn_URL: value
              }
            };
          } else if (apiFieldName === "website") {
            updates = { url: value };
          } else if (apiFieldName === "primary_business_focus") {
            // For primary_business_focus, do lookup first, then save as array
            btn.innerHTML = "‚è≥";
            btn.disabled = true;
            
            // Use async IIFE to handle lookup and save
            (async () => {
              try {
                const businessFocusName = value.trim();
                if (!businessFocusName) {
                  log("No business focus name to save", "warn");
                  btn.innerHTML = "üíæ";
                  btn.disabled = false;
                  return;
                }
                
                // Step 1: Lookup business focus ID
                log(`Looking up business focus: ${businessFocusName}...`, "info");
                const lookupUrl = `${XANO_BASE}/api:8Bv5PK4I/business_focus_lookup?business_focus_title=${encodeURIComponent(businessFocusName)}`;
                
                const lookupRes = await fetch(lookupUrl, {
                  method: "GET",
                  headers: { "Content-Type": "application/json" },
                });
                
                let focusId = 0;
                if (lookupRes.ok) {
                  const lookupData = await lookupRes.json();
                  if (lookupData && lookupData.id) {
                    focusId = lookupData.id;
                    log(`‚úÖ Found business focus ID: ${focusId}`, "ok");
                  } else {
                    log(`‚ö†Ô∏è No ID found for business focus: ${businessFocusName}`, "warn");
                  }
                } else {
                  log(`‚ö†Ô∏è Business focus lookup failed for: ${businessFocusName}`, "warn");
                }
                
                if (focusId === 0) {
                  btn.innerHTML = "‚ùå";
                  btn.style.background = "rgba(239, 68, 68, 0.2)";
                  log("‚ùå Business focus not found in database - cannot save", "err");
                  setTimeout(() => {
                    btn.innerHTML = "üíæ";
                    btn.style.background = "rgba(16, 185, 129, 0.1)";
                    btn.disabled = false;
                  }, 2000);
                  return;
                }
                
                // Step 2: Save primary_business_focus_id as array
                const updates = {
                  primary_business_focus_id: [focusId]  // Always an array
                };
                
                const response = await fetch(
                  `${XANO_BASE}/api:8Bv5PK4I/edit_company/${window._dbCompanyId}`,
                  {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      new_company_id: window._dbCompanyId,
                      updates: updates
                    })
                  }
                );
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                  btn.innerHTML = "‚úÖ";
                  btn.style.background = "rgba(16, 185, 129, 0.3)";
                  log(`‚úÖ Saved ${label} (ID: ${focusId}): ${businessFocusName}`, "ok");
                  
                  // Update local DB data
                  if (window._dbOverviewData) {
                    window._dbOverviewData.primary_business_focus = businessFocusName;
                    window._dbOverviewData.primary_business_focus_id = focusId;
                  }
                  
                  // Refresh Xano data
                  await refreshXanoData();
                  
                  setTimeout(() => {
                    btn.innerHTML = "üíæ";
                    btn.style.background = "rgba(16, 185, 129, 0.1)";
                    btn.disabled = false;
                  }, 2000);
                } else {
                  btn.innerHTML = "‚ùå";
                  btn.style.background = "rgba(239, 68, 68, 0.2)";
                  log(`‚ùå Failed to save ${label}: ${result.message || "Unknown error"}`, "err");
                  setTimeout(() => {
                    btn.innerHTML = "üíæ";
                    btn.style.background = "rgba(16, 185, 129, 0.1)";
                    btn.disabled = false;
                  }, 2000);
                }
              } catch (err) {
                btn.innerHTML = "‚ùå";
                btn.style.background = "rgba(239, 68, 68, 0.2)";
                log(`‚ùå Error saving ${label}: ${err.message}`, "err");
                setTimeout(() => {
                  btn.innerHTML = "üíæ";
                  btn.style.background = "rgba(16, 185, 129, 0.1)";
                  btn.disabled = false;
                }, 2000);
              }
            })();
            return; // Exit early, async function handles everything
          } else if (apiFieldName === "year_founded") {
            // For year_founded, do lookup first, then save with years_id
            btn.innerHTML = "‚è≥";
            btn.disabled = true;
            
            // Use async IIFE to handle lookup and save
            (async () => {
              try {
                const yearValue = value.trim();
                if (!yearValue) {
                  log("No year value to save", "warn");
                  btn.innerHTML = "üíæ";
                  btn.disabled = false;
                  return;
                }
                
                // Step 1: Lookup year ID
                log(`Looking up year: ${yearValue}...`, "info");
                const lookupUrl = `${XANO_BASE}/api:8Bv5PK4I/years_lookup?year=${encodeURIComponent(yearValue)}`;
                
                const lookupRes = await fetch(lookupUrl, {
                  method: "GET",
                  headers: { "Content-Type": "application/json" },
                });
                
                let yearId = 0;
                if (lookupRes.ok) {
                  const lookupData = await lookupRes.json();
                  if (lookupData && lookupData.id) {
                    yearId = lookupData.id;
                    log(`‚úÖ Found year ID: ${yearId}`, "ok");
                  } else {
                    log(`‚ö†Ô∏è No ID found for year: ${yearValue}`, "warn");
                  }
                } else {
                  log(`‚ö†Ô∏è Year lookup failed for: ${yearValue}`, "warn");
                }
                
                // Step 2: Save both year_founded (text) and years_id (if found)
                const updates = {
                  year_founded: parseInt(yearValue, 10) || 0,  // Keep text field for compatibility
                };
                
                if (yearId > 0) {
                  updates.years_id = yearId;
                }
                
                const response = await fetch(
                  `${XANO_BASE}/api:8Bv5PK4I/edit_company/${window._dbCompanyId}`,
                  {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      new_company_id: window._dbCompanyId,
                      updates: updates
                    })
                  }
                );
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                  btn.innerHTML = "‚úÖ";
                  btn.style.background = "rgba(16, 185, 129, 0.3)";
                  log(`‚úÖ Saved ${label}${yearId > 0 ? ` (ID: ${yearId})` : ""}: ${yearValue}`, "ok");
                  
                  // Update local DB data
                  if (window._dbOverviewData) {
                    window._dbOverviewData.year_founded = yearValue;
                  }
                  
                  // Refresh Xano data
                  await refreshXanoData();
                  
                  setTimeout(() => {
                    btn.innerHTML = "üíæ";
                    btn.style.background = "rgba(16, 185, 129, 0.1)";
                    btn.disabled = false;
                  }, 2000);
                } else {
                  btn.innerHTML = "‚ùå";
                  btn.style.background = "rgba(239, 68, 68, 0.2)";
                  log(`‚ùå Failed to save ${label}: ${result.message || "Unknown error"}`, "err");
                  setTimeout(() => {
                    btn.innerHTML = "üíæ";
                    btn.style.background = "rgba(16, 185, 129, 0.1)";
                    btn.disabled = false;
                  }, 2000);
                }
              } catch (err) {
                btn.innerHTML = "‚ùå";
                btn.style.background = "rgba(239, 68, 68, 0.2)";
                log(`‚ùå Error saving ${label}: ${err.message}`, "err");
                setTimeout(() => {
                  btn.innerHTML = "üíæ";
                  btn.style.background = "rgba(16, 185, 129, 0.1)";
                  btn.disabled = false;
                }, 2000);
              }
            })();
            return; // Exit early, async function handles everything
          } else {
            updates[apiFieldName] = value;
          }
          
          btn.innerHTML = "‚è≥";
          btn.disabled = true;
          
          try {
            const response = await fetch(
              `${XANO_BASE}/api:8Bv5PK4I/edit_company/${window._dbCompanyId}`,
              {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  new_company_id: window._dbCompanyId,
                  updates: updates
                })
              }
            );
            
            const result = await response.json();
            
            if (response.ok && result.success) {
              btn.innerHTML = "‚úÖ";
              btn.style.background = "rgba(16, 185, 129, 0.3)";
              log(`‚úÖ Saved ${label}: ${value}`, "ok");
              
              // Update local DB data
              if (window._dbOverviewData) {
                if (apiFieldName === "linkedin") {
                  window._dbOverviewData.linkedin = value;
                } else if (apiFieldName === "website") {
                  window._dbOverviewData.website = value;
                } else {
                  window._dbOverviewData[apiFieldName] = value;
                }
              }
              
              // Refresh Xano data
              await refreshXanoData();
              
              setTimeout(() => {
                btn.innerHTML = "üíæ";
                btn.style.background = "rgba(16, 185, 129, 0.1)";
                btn.disabled = false;
              }, 2000);
            } else {
              btn.innerHTML = "‚ùå";
              btn.style.background = "rgba(239, 68, 68, 0.2)";
              log(`‚ùå Failed to save ${label}: ${result.message || "Unknown error"}`, "err");
              setTimeout(() => {
                btn.innerHTML = "üíæ";
                btn.style.background = "rgba(16, 185, 129, 0.1)";
                btn.disabled = false;
              }, 2000);
            }
          } catch (err) {
            btn.innerHTML = "‚ùå";
            btn.style.background = "rgba(239, 68, 68, 0.2)";
            log(`‚ùå Error saving ${label}: ${err.message}`, "err");
            setTimeout(() => {
              btn.innerHTML = "üíæ";
              btn.style.background = "rgba(16, 185, 129, 0.1)";
              btn.disabled = false;
            }, 2000);
          }
        };
        return btn;
      }

      // Show save buttons when company exists in DB
      function showSaveButtons() {
        document.querySelectorAll(".save-to-db-btn").forEach(btn => {
          if (window._dbCompanyId) {
            btn.style.display = "inline-block";
          } else {
            btn.style.display = "none";
          }
        });
      }
      
      // Function to update Xano status badge
      function updateXanoStatus(existingCompany, dbCompany) {
        xanoStatusContainer.style.display = "block";
        
        if (existingCompany && existingCompany.id) {
          // Company found in database
          window._companyExistsInDb = true;
          xanoStatusBadge.style.background = "rgba(5, 150, 105, 0.15)";
          xanoStatusBadge.style.border = "1px solid rgba(16, 185, 129, 0.4)";
          xanoStatusBadge.style.color = "#6ee7b7";
          xanoStatusIcon.textContent = "‚úÖ";
          const companyName = dbCompany?.name || `ID: ${existingCompany.id}`;
          xanoStatusText.innerHTML = `<strong>Found in Database</strong> ‚Äî ${companyName} (ID: ${existingCompany.id})`;
          
          // Hide "Create in DB" button, show "Copy from DB" if description exists
          const createContainer = document.getElementById("createInDbContainer");
          if (createContainer) createContainer.style.display = "none";
        } else {
          // Company NOT found in database
          window._companyExistsInDb = false;
          xanoStatusBadge.style.background = "rgba(239, 68, 68, 0.1)";
          xanoStatusBadge.style.border = "1px solid rgba(239, 68, 68, 0.3)";
          xanoStatusBadge.style.color = "#fca5a5";
          xanoStatusIcon.textContent = "‚ö†Ô∏è";
          xanoStatusText.innerHTML = `<strong>Not in Database</strong> ‚Äî Company will be analyzed using AI only`;
          
          // Show "Create in DB" button, hide "Copy from DB"
          const createContainer = document.getElementById("createInDbContainer");
          if (createContainer) createContainer.style.display = "block";
          const copyContainer = document.getElementById("copyFromDbContainer");
          if (copyContainer) copyContainer.style.display = "none";
        }
      }
      
      // Function to reset/hide the status badge
      function resetXanoStatus() {
        xanoStatusContainer.style.display = "none";
      }

      // Deal / status options (mirrors Streamlit version)
      const DEAL_TYPES = [
        "",
        "Acquisition",
        "Sale",
        "IPO",
        "MBO",
        "Investment",
        "Strategic Review",
        "Divestment",
        "Restructuring",
        "Dual track",
        "Closing",
        "Grant",
        "Debt financing",
        "Bankruptcy",
        "Reorganisation",
        "Employee tender offer",
        "Rebrand",
        "Partnership",
      ];

      const DEAL_STATUSES = [
        "",
        "Completed",
        "In Market",
        "Not yet launched",
        "Strategic Review",
        "Deal Prep",
        "In Exclusivity",
        "Pending",
      ];

      // Counterparty types with their IDs
      const COUNTERPARTY_TYPES = [
        { id: 17, type: "Target" },
        { id: 18, type: "Acquirer" },
        { id: 24, type: "Investor (majority)" },
        { id: 25, type: "Investor (minority)" },
        { id: 26, type: "Investor (unknown)" },
        { id: 19, type: "Seller" },
        { id: 20, type: "Joint Venture Partner" },
      ];

      // Ownership types with their IDs (mapping ownership text to ownership_type_id)
      const OWNERSHIP_TYPES = [
        { id: 1, type: "Public" },
        { id: 2, type: "Private" },
        { id: 3, type: "Venture-Backed" },
        { id: 4, type: "Private Equity-Backed" },
        { id: 5, type: "Family-Owned" },
        { id: 6, type: "Employee-Owned" },
        { id: 7, type: "Founder-Owned" },
        { id: 8, type: "Institutional-Owned" },
        { id: 9, type: "Government-Owned" },
        { id: 10, type: "Non-Profit" },
        { id: 11, type: "Subsidiary" },
        { id: 12, type: "Cooperative" },
        { id: 13, type: "Partnership" },
      ];

      // Helper function to get ownership_type_id from ownership text
      function getOwnershipTypeId(ownershipText) {
        if (!ownershipText) return 0;
        const found = OWNERSHIP_TYPES.find(ot => 
          ot.type.toLowerCase() === ownershipText.toLowerCase()
        );
        return found ? found.id : 0;
      }

      // Query for existing corporate event ID by description
      async function queryEventId(description) {
        if (!description) return null;
        
        try {
          const url = `${XANO_BASE}/api:8Bv5PK4I/query_existing_corporate_event?description=${encodeURIComponent(description)}`;
          const res = await fetch(url, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });
          
          if (res.ok) {
            const data = await res.json();
            if (data && data.id) {
              log(`‚úÖ Found event ID: ${data.id} for "${description.substring(0, 40)}..."`, "ok");
              return data.id;
            }
          }
          return null;
        } catch (err) {
          console.error("Error querying event ID:", err);
          return null;
        }
      }

      // Function to intelligently suggest business focus based on all available data
      function suggestBusinessFocus(companyData) {
        const suggestions = [];
        const scores = {};

        // Initialize scores for all categories
        Object.values(BUSINESS_FOCUS_CATEGORIES).forEach(category => {
          scores[category] = 0;
        });

        // Analyze company description
        const description = (companyData.description || "").toLowerCase();
        const name = (companyData.name || "").toLowerCase();
        const combinedText = description + " " + name;

        // Check keywords in description and name
        Object.entries(BUSINESS_FOCUS_KEYWORDS).forEach(([category, keywords]) => {
          keywords.forEach(keyword => {
            const regex = new RegExp(`\\b${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
            const matches = combinedText.match(regex);
            if (matches) {
              scores[category] += matches.length * 2; // Weight keyword matches highly
            }
          });
        });

        // Analyze sectors for additional clues
        const sectors = companyData.sectors || [];
        sectors.forEach(sector => {
          const sectorName = (sector.sector || sector.name || "").toLowerCase();

          // Healthcare-related sectors
          if (sectorName.includes("healthcare") || sectorName.includes("medical") ||
              sectorName.includes("pharma") || sectorName.includes("biotech")) {
            scores["Healthcare"] += 3;
            scores["Pharmaceuticals"] += 2;
            scores["Medical Equipment"] += 1;
          }

          // Tech-related sectors
          if (sectorName.includes("software") || sectorName.includes("technology") ||
              sectorName.includes("saas") || sectorName.includes("cloud")) {
            scores["Software"] += 3;
            scores["Data & Analytics"] += 1;
          }

          // Financial sectors
          if (sectorName.includes("finance") || sectorName.includes("banking") ||
              sectorName.includes("payment") || sectorName.includes("fintech")) {
            scores["Financial Services"] += 3;
          }

          // Manufacturing and industrials
          if (sectorName.includes("manufacturing") || sectorName.includes("industrial")) {
            scores["Manufacturing"] += 3;
            scores["Industrials"] += 2;
          }

          // Energy and commodities
          if (sectorName.includes("energy") || sectorName.includes("oil") ||
              sectorName.includes("gas") || sectorName.includes("renewable")) {
            scores["Energy & Commodities"] += 3;
          }

          // Real estate
          if (sectorName.includes("real estate") || sectorName.includes("property")) {
            scores["Real Estate"] += 3;
          }
        });

        // Convert scores to suggestions sorted by score
        const sortedSuggestions = Object.entries(scores)
          .filter(([category, score]) => score > 0)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5) // Top 5 suggestions
          .map(([category, score]) => ({
            name: category,
            score: score,
            confidence: score > 5 ? "High" : score > 2 ? "Medium" : "Low"
          }));

        return sortedSuggestions;
      }

      // Function to find business focus ID by name
      function getBusinessFocusId(name) {
        for (const [id, categoryName] of Object.entries(BUSINESS_FOCUS_CATEGORIES)) {
          if (categoryName.toLowerCase() === name.toLowerCase()) {
            return parseInt(id);
          }
        }
        return null;
      }

      // Edit corporate event API function
      async function editCorporateEventInDb(eventId, updates, button) {
        if (!eventId) {
          log("‚ùå No event ID provided", "err");
          return false;
        }
        
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = "‚è≥";
        
        log(`Updating corporate event ID ${eventId}...`, "warn");
        
        try {
          const payload = {
            event_id: eventId,
            updates: updates
          };
          
          const res = await fetch(`${XANO_BASE}/api:8Bv5PK4I/edit_corporate_event/${eventId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          
          const data = await res.json();
          
          if (res.ok) {
            button.textContent = "‚úÖ";
            button.style.background = "linear-gradient(135deg, #10b981 0%, #059669 100%)";
            log(`‚úÖ Event ${eventId} updated successfully!`, "ok");
            
            // Refresh Xano data to show the updated event
            await refreshXanoData();
            
            setTimeout(() => {
              button.disabled = false;
              button.textContent = originalText;
              button.style.background = "";
            }, 2000);
            
            return true;
          } else {
            button.textContent = "‚ùå";
            button.style.background = "linear-gradient(135deg, #ef4444 0%, #dc2626 100%)";
            log(`‚ùå Failed to update event: ${JSON.stringify(data)}`, "err");
            
            setTimeout(() => {
              button.disabled = false;
              button.textContent = originalText;
              button.style.background = "";
            }, 3000);
            
            return false;
          }
        } catch (err) {
          button.textContent = "‚ùå";
          log(`‚ùå Error updating event: ${err.message}`, "err");
          
          setTimeout(() => {
            button.disabled = false;
            button.textContent = originalText;
            button.style.background = "";
          }, 3000);
          
          return false;
        }
      }

      // Search for existing individual by name and LinkedIn URL
      async function searchIndividual(name, linkedinUrl) {
        try {
          const params = new URLSearchParams();
          if (name) params.append("name", name);
          if (linkedinUrl) params.append("linkedin_url", linkedinUrl);
          
          const url = `${XANO_BASE}/api:8Bv5PK4I/search_individual?${params.toString()}`;
          const res = await fetch(url, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });
          
          if (res.ok) {
            const data = await res.json();
            if (data && data.exists && data.individual_id) {
              log(`‚úÖ Found individual: ${name} (ID: ${data.individual_id})`, "ok");
              return data;
            }
          }
          return null;
        } catch (err) {
          console.error("Error searching individual:", err);
          return null;
        }
      }

      // Update individual via PATCH
      async function updateIndividual(roleId, updates, button) {
        if (!roleId) {
          log("‚ùå No role ID provided", "err");
          return false;
        }
        
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = "‚è≥";
        
        log(`Updating individual role ID ${roleId}...`, "warn");
        
        try {
          const payload = {
            role_id: roleId,
            ...updates
          };
          
          const res = await fetch(`${XANO_BASE}/api:8Bv5PK4I/update_individual/${roleId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          
          const data = await res.json();
          
          if (res.ok) {
            button.textContent = "‚úÖ";
            button.style.background = "linear-gradient(135deg, #10b981 0%, #059669 100%)";
            log(`‚úÖ Individual role ${roleId} updated successfully!`, "ok");
            
            // Refresh Xano data to show the updated individual
            await refreshXanoData();
            
            setTimeout(() => {
              button.disabled = false;
              button.textContent = originalText;
              button.style.background = "";
            }, 2000);
            
            return true;
          } else {
            button.textContent = "‚ùå";
            button.style.background = "linear-gradient(135deg, #ef4444 0%, #dc2626 100%)";
            log(`‚ùå Failed to update individual: ${JSON.stringify(data)}`, "err");
            
            setTimeout(() => {
              button.disabled = false;
              button.textContent = originalText;
              button.style.background = "";
            }, 3000);
            
            return false;
          }
        } catch (err) {
          button.textContent = "‚ùå";
          log(`‚ùå Error updating individual: ${err.message}`, "err");
          
          setTimeout(() => {
            button.disabled = false;
            button.textContent = originalText;
            button.style.background = "";
          }, 3000);
          
          return false;
        }
      }

      // Create new counterparty API function
      async function createCounterpartyInDb(corporateEventId, companyName, counterpartyTypeId, button, pressReleaseUrl = "") {
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = "‚è≥";
        
        log(`Creating counterparty "${companyName}" for event ${corporateEventId}...`, "warn");
        
        try {
          // Use the company ID from the current company being analyzed
          const companyId = window._companyId || 0;
          
          if (!companyId) {
            log("‚ö†Ô∏è Warning: No company_id available. Make sure company exists in DB first.", "warn");
          }
          
          const payload = {
            corporate_event_id: corporateEventId,
            company_id: companyId,  // Use the current company ID
            counterparty_type_id: counterpartyTypeId || 17,  // Default to "Target"
            press_release_url: pressReleaseUrl || "",
            individual_role_ids: {},
            company_name: companyName,  // Pass name for Xano to create/lookup counterparty company
          };
          
          log(`Using company_id: ${companyId} (window._companyId: ${window._companyId})`, "info");
          log(`POST ${XANO_BASE}/api:8Bv5PK4I/create_counterparty`, "info");
          log(`Payload: ${JSON.stringify(payload)}`, "info");
          
          const res = await fetch(`${XANO_BASE}/api:8Bv5PK4I/create_counterparty`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          
          const data = await res.json();
          
          if (res.ok) {
            button.textContent = "‚úÖ Created";
            button.style.background = "linear-gradient(135deg, #10b981 0%, #059669 100%)";
            button.style.color = "white";
            log(`‚úÖ Counterparty "${companyName}" created successfully!`, "ok");
            
            // Store the new counterparty ID if returned
            if (data.id || data.counterparty_id) {
              button.dataset.counterpartyId = data.id || data.counterparty_id;
              log(`New counterparty ID: ${data.id || data.counterparty_id}`, "ok");
            }
            
            // Refresh Xano data to show the newly created counterparty
            await refreshXanoData();
            
            setTimeout(() => {
              button.disabled = false;
              button.textContent = originalText;
              button.style.background = "";
              button.style.color = "";
            }, 3000);
            
            return data;
          } else {
            button.textContent = "‚ùå Failed";
            button.style.background = "linear-gradient(135deg, #ef4444 0%, #dc2626 100%)";
            button.style.color = "white";
            log(`‚ùå Failed to create counterparty: ${JSON.stringify(data)}`, "err");
            
            setTimeout(() => {
              button.disabled = false;
              button.textContent = originalText;
              button.style.background = "";
              button.style.color = "";
            }, 3000);
            
            return null;
          }
        } catch (err) {
          button.textContent = "‚ùå Error";
          log(`‚ùå Error creating counterparty: ${err.message}`, "err");
          
          setTimeout(() => {
            button.disabled = false;
            button.textContent = originalText;
            button.style.background = "";
            button.style.color = "";
          }, 3000);
          
          return null;
        }
      }

      // Edit counterparty API function
      async function editCounterpartyInDb(counterpartyId, updates, button) {
        if (!counterpartyId) {
          log("‚ùå No counterparty ID provided", "err");
          return false;
        }
        
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = "‚è≥ Saving...";
        
        log(`Updating counterparty ID ${counterpartyId}...`, "warn");
        
        try {
          const payload = {
            counterparty_id: counterpartyId,
            updates: updates
          };
          
          const res = await fetch(`${XANO_BASE}/api:8Bv5PK4I/edit_counterparty/${counterpartyId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          
          const data = await res.json();
          
          if (res.ok && data.success) {
            button.textContent = "‚úÖ Saved";
            button.style.background = "linear-gradient(135deg, #10b981 0%, #059669 100%)";
            log(`‚úÖ Counterparty ${counterpartyId} updated successfully!`, "ok");
            
            // Refresh Xano data to show the updated counterparty
            await refreshXanoData();
            
            setTimeout(() => {
              button.disabled = false;
              button.textContent = originalText;
              button.style.background = "";
            }, 2000);
            
            return true;
          } else {
            button.textContent = "‚ùå Failed";
            button.style.background = "linear-gradient(135deg, #ef4444 0%, #dc2626 100%)";
            log(`‚ùå Failed to update counterparty: ${JSON.stringify(data)}`, "err");
            
            setTimeout(() => {
              button.disabled = false;
              button.textContent = originalText;
              button.style.background = "";
            }, 3000);
            
            return false;
          }
        } catch (err) {
          button.textContent = "‚ùå Error";
          log(`‚ùå Error updating counterparty: ${err.message}`, "err");
          
          setTimeout(() => {
            button.disabled = false;
            button.textContent = originalText;
            button.style.background = "";
          }, 3000);
          
          return false;
        }
      }

      function log(msg, level = "info") {
        const time = new Date().toLocaleTimeString();
        const div = document.createElement("div");
        div.className = `log-line ${level}`;
        div.textContent = `[${time}] ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function setStatus(text, tone = "info") {
        statusPill.textContent = text;
        if (tone === "ok") {
          statusPill.style.background = "rgba(5, 46, 22, 0.9)";
          statusPill.style.color = "#6ee7b7";
        } else if (tone === "err") {
          statusPill.style.background = "rgba(127, 29, 29, 0.9)";
          statusPill.style.color = "#fecaca";
        } else {
          statusPill.style.background = "#020617";
          statusPill.style.color = "#9ca3af";
        }
      }

      function clearEvents() {
        aiEventsEl.innerHTML = "";
        dbEventsEl.innerHTML = "";
        aiOverviewEl.innerHTML = "";
        dbOverviewEl.innerHTML = "";
        topManagementEl.innerHTML = "";
        dbManagementEl.innerHTML = "";
        window._dbCompanyId = null;
        window._companyId = null;
        window._dbOverviewData = null;
      }

      function renderAIOverview(data) {
        aiOverviewEl.innerHTML = "";
        // Store AI overview data for later use (e.g., in createCompanyInDb)
        window._aiOverviewData = data;
        if (!data) {
          aiOverviewEl.innerHTML =
            '<div class="empty-state">No AI overview available.</div>';
          aiOverviewMeta.textContent = "No data";
          return;
        }
        aiOverviewMeta.textContent = "Editable";

        const card = document.createElement("div");
        card.className = "event-card";

        // Name row with copy button
        const rowName = document.createElement("div");
        rowName.style.display = "flex";
        rowName.style.alignItems = "center";
        rowName.style.gap = "4px";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.id = "ai_name";
        nameInput.value = data.name || "";
        nameInput.placeholder = "Company name";
        nameInput.style.flex = "1";
        nameInput.style.padding = "5px 8px";
        nameInput.style.borderRadius = "8px";
        nameInput.style.border = "1px solid #1f2937";
        nameInput.style.background = "#020617";
        nameInput.style.color = "#e5e7eb";
        nameInput.style.fontSize = "13px";

        rowName.appendChild(nameInput);
        rowName.appendChild(createCopyBtn("ai_name", "name", "Name"));
        rowName.appendChild(createSaveBtn("ai_name", "name", "Name"));

        const rowLoc = document.createElement("div");
        rowLoc.style.display = "flex";
        rowLoc.style.gap = "6px";
        rowLoc.style.marginTop = "6px";

        const cityInput = document.createElement("input");
        cityInput.type = "text";
        cityInput.id = "ai_city";
        cityInput.placeholder = "City";
        cityInput.value = data.city || "";
        cityInput.style.flex = "1";
        cityInput.style.padding = "3px 7px";
        cityInput.style.borderRadius = "999px";
        cityInput.style.border = "1px solid #1f2937";
        cityInput.style.background = "#020617";
        cityInput.style.color = "#e5e7eb";
        cityInput.style.fontSize = "11px";

        const countryInput = document.createElement("input");
        countryInput.type = "text";
        countryInput.id = "ai_country";
        countryInput.placeholder = "Country";
        countryInput.value = data.country || "";
        countryInput.style.flex = "1";
        countryInput.style.padding = "3px 7px";
        countryInput.style.borderRadius = "999px";
        countryInput.style.border = "1px solid #1f2937";
        countryInput.style.background = "#020617";
        countryInput.style.color = "#e5e7eb";
        countryInput.style.fontSize = "11px";

        rowLoc.appendChild(cityInput);
        rowLoc.appendChild(createCopyBtn("ai_city", "city", "City"));
        rowLoc.appendChild(countryInput);
        rowLoc.appendChild(createCopyBtn("ai_country", "country", "Country"));
        
        // Single save button for location (looks up location_id first)
        const saveLocBtn = document.createElement("button");
        saveLocBtn.type = "button";
        saveLocBtn.title = "Save Location to DB";
        saveLocBtn.innerHTML = "üíæ Save Location";
        saveLocBtn.style.padding = "3px 8px";
        saveLocBtn.style.fontSize = "10px";
        saveLocBtn.style.borderRadius = "4px";
        saveLocBtn.style.border = "1px solid rgba(16, 185, 129, 0.3)";
        saveLocBtn.style.background = "rgba(16, 185, 129, 0.1)";
        saveLocBtn.style.color = "#6ee7b7";
        saveLocBtn.style.cursor = "pointer";
        saveLocBtn.style.marginLeft = "8px";
        saveLocBtn.style.transition = "all 0.15s ease";
        saveLocBtn.style.display = "none";
        saveLocBtn.className = "save-to-db-btn";
        
        saveLocBtn.onmouseover = () => {
          saveLocBtn.style.background = "rgba(16, 185, 129, 0.25)";
          saveLocBtn.style.borderColor = "rgba(16, 185, 129, 0.5)";
        };
        saveLocBtn.onmouseout = () => {
          saveLocBtn.style.background = "rgba(16, 185, 129, 0.1)";
          saveLocBtn.style.borderColor = "rgba(16, 185, 129, 0.3)";
        };
        
        saveLocBtn.onclick = async () => {
          if (!window._dbCompanyId) {
            log("No company ID - cannot save", "err");
            return;
          }
          
          const city = cityInput.value.trim();
          const country = countryInput.value.trim();
          
          if (!city && !country) {
            log("No city or country to save", "warn");
            return;
          }
          
          saveLocBtn.innerHTML = "‚è≥";
          saveLocBtn.disabled = true;
          
          try {
            // Step 1: Lookup location_id using global function
            const locationId = await window.lookupLocation(city, country);
            
            // Step 2: Save locations_id to company
            const response = await fetch(
              `${XANO_BASE}/api:8Bv5PK4I/edit_company/${window._dbCompanyId}`,
              {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  new_company_id: window._dbCompanyId,
                  updates: {
                    locations_id: locationId
                  }
                })
              }
            );
            
            const result = await response.json();
            
            if (response.ok && result.success) {
              saveLocBtn.innerHTML = "‚úÖ";
              saveLocBtn.style.background = "rgba(16, 185, 129, 0.3)";
              log(`‚úÖ Saved location (ID: ${locationId}): ${city}, ${country}`, "ok");
              
              setTimeout(() => {
                saveLocBtn.innerHTML = "üíæ Save Location";
                saveLocBtn.style.background = "rgba(16, 185, 129, 0.1)";
                saveLocBtn.disabled = false;
              }, 2000);
            } else {
              saveLocBtn.innerHTML = "‚ùå";
              saveLocBtn.style.background = "rgba(239, 68, 68, 0.2)";
              log(`‚ùå Failed to save location: ${result.message || "Unknown error"}`, "err");
              setTimeout(() => {
                saveLocBtn.innerHTML = "üíæ Save Location";
                saveLocBtn.style.background = "rgba(16, 185, 129, 0.1)";
                saveLocBtn.disabled = false;
              }, 2000);
            }
          } catch (err) {
            saveLocBtn.innerHTML = "‚ùå";
            saveLocBtn.style.background = "rgba(239, 68, 68, 0.2)";
            log(`‚ùå Error saving location: ${err.message}`, "err");
            setTimeout(() => {
              saveLocBtn.innerHTML = "üíæ Save Location";
              saveLocBtn.style.background = "rgba(16, 185, 129, 0.1)";
              saveLocBtn.disabled = false;
            }, 2000);
          }
        };
        
        rowLoc.appendChild(saveLocBtn);

        // Primary Business Focus row
        const rowBusinessFocus = document.createElement("div");
        rowBusinessFocus.style.display = "flex";
        rowBusinessFocus.style.gap = "6px";
        rowBusinessFocus.style.marginTop = "6px";
        rowBusinessFocus.style.alignItems = "center";
        rowBusinessFocus.style.position = "relative"; // For dropdown positioning

        const businessFocusLabel = document.createElement("span");
        businessFocusLabel.textContent = "Business Focus:";
        businessFocusLabel.style.fontSize = "11px";
        businessFocusLabel.style.color = "#9ca3af";
        businessFocusLabel.style.minWidth = "90px";

        // Container for input and suggestions
        const businessFocusContainer = document.createElement("div");
        businessFocusContainer.style.flex = "1";
        businessFocusContainer.style.position = "relative";

        const businessFocusInput = document.createElement("input");
        businessFocusInput.type = "text";
        businessFocusInput.id = "ai_primary_business_focus";
        businessFocusInput.placeholder = "e.g., Software, Healthcare";
        businessFocusInput.value = data.primary_business_focus || "";
        businessFocusInput.style.width = "100%";
        businessFocusInput.style.padding = "3px 7px";
        businessFocusInput.style.borderRadius = "999px";
        businessFocusInput.style.border = "1px solid #1f2937";
        businessFocusInput.style.background = "#020617";
        businessFocusInput.style.color = "#e5e7eb";
        businessFocusInput.style.fontSize = "11px";
        businessFocusInput.autocomplete = "off";

        // Store the ID in a data attribute
        if (data.primary_business_focus_id) {
          businessFocusInput.dataset.businessFocusId = data.primary_business_focus_id;
        }

        // Create suggestions dropdown
        const suggestionsDropdown = document.createElement("div");
        suggestionsDropdown.style.position = "absolute";
        suggestionsDropdown.style.top = "100%";
        suggestionsDropdown.style.left = "0";
        suggestionsDropdown.style.right = "0";
        suggestionsDropdown.style.background = "#0b1020";
        suggestionsDropdown.style.border = "1px solid #1f2937";
        suggestionsDropdown.style.borderRadius = "8px";
        suggestionsDropdown.style.maxHeight = "200px";
        suggestionsDropdown.style.overflowY = "auto";
        suggestionsDropdown.style.zIndex = "1000";
        suggestionsDropdown.style.display = "none";
        suggestionsDropdown.style.boxShadow = "0 4px 12px rgba(0, 0, 0, 0.5)";


        // Hide suggestions when clicking outside
        document.addEventListener("click", (e) => {
          if (!businessFocusContainer.contains(e.target)) {
            suggestionsDropdown.style.display = "none";
          }
        });

        businessFocusContainer.appendChild(businessFocusInput);
        businessFocusContainer.appendChild(suggestionsDropdown);

        // Show ID badge if mapped
        const idBadge = document.createElement("span");
        if (data.primary_business_focus_id && data.primary_business_focus_id > 0) {
          idBadge.textContent = `ID: ${data.primary_business_focus_id}`;
          idBadge.style.fontSize = "9px";
          idBadge.style.color = "#10b981";
          idBadge.style.background = "rgba(16, 185, 129, 0.15)";
          idBadge.style.padding = "2px 6px";
          idBadge.style.borderRadius = "4px";
          idBadge.style.border = "1px solid rgba(16, 185, 129, 0.3)";
          idBadge.title = "Mapped to database ID";
        } else if (data.primary_business_focus) {
          idBadge.textContent = "Not mapped";
          idBadge.style.fontSize = "9px";
          idBadge.style.color = "#f59e0b";
          idBadge.style.background = "rgba(245, 158, 11, 0.15)";
          idBadge.style.padding = "2px 6px";
          idBadge.style.borderRadius = "4px";
          idBadge.style.border = "1px solid rgba(245, 158, 11, 0.3)";
          idBadge.title = "Not found in predefined list";
        }

        // Add smart suggestions button
        const suggestBtn = document.createElement("button");
        suggestBtn.type = "button";
        suggestBtn.title = "Get AI suggestions";
        suggestBtn.innerHTML = "üß†";
        suggestBtn.style.padding = "2px 6px";
        suggestBtn.style.fontSize = "10px";
        suggestBtn.style.borderRadius = "4px";
        suggestBtn.style.border = "1px solid rgba(99, 102, 241, 0.3)";
        suggestBtn.style.background = "rgba(99, 102, 241, 0.1)";
        suggestBtn.style.color = "#a5b4fc";
        suggestBtn.style.cursor = "pointer";
        suggestBtn.style.marginRight = "4px";
        // Function to update suggestions (defined in scope)
        const updateSuggestionsLocal = () => {
          const currentData = window._aiOverviewData || data;
          const suggestions = suggestBusinessFocus(currentData);

          suggestionsDropdown.innerHTML = "";

          if (suggestions.length === 0) {
            suggestionsDropdown.style.display = "none";
            return;
          }

          suggestions.forEach(suggestion => {
            const suggestionItem = document.createElement("div");
            suggestionItem.style.padding = "8px 12px";
            suggestionItem.style.cursor = "pointer";
            suggestionItem.style.borderBottom = "1px solid #1f2937";
            suggestionItem.style.display = "flex";
            suggestionItem.style.justifyContent = "space-between";
            suggestionItem.style.alignItems = "center";
            suggestionItem.style.fontSize = "11px";

            const suggestionText = document.createElement("span");
            suggestionText.textContent = suggestion.name;

            const confidenceBadge = document.createElement("span");
            confidenceBadge.textContent = suggestion.confidence;
            confidenceBadge.style.fontSize = "9px";
            confidenceBadge.style.padding = "2px 6px";
            confidenceBadge.style.borderRadius = "4px";

            if (suggestion.confidence === "High") {
              confidenceBadge.style.background = "rgba(16, 185, 129, 0.2)";
              confidenceBadge.style.color = "#10b981";
            } else if (suggestion.confidence === "Medium") {
              confidenceBadge.style.background = "rgba(245, 158, 11, 0.2)";
              confidenceBadge.style.color = "#f59e0b";
            } else {
              confidenceBadge.style.background = "rgba(156, 163, 175, 0.2)";
              confidenceBadge.style.color = "#9ca3af";
            }

            suggestionItem.appendChild(suggestionText);
            suggestionItem.appendChild(confidenceBadge);

            suggestionItem.addEventListener("mouseenter", () => {
              suggestionItem.style.background = "rgba(99, 102, 241, 0.1)";
            });
            suggestionItem.addEventListener("mouseleave", () => {
              suggestionItem.style.background = "transparent";
            });
            suggestionItem.addEventListener("click", () => {
              businessFocusInput.value = suggestion.name;
              const id = getBusinessFocusId(suggestion.name);
              if (id) {
                businessFocusInput.dataset.businessFocusId = id;
              }
              suggestionsDropdown.style.display = "none";
              // Trigger change event to update ID badge
              businessFocusInput.dispatchEvent(new Event('input'));
            });

            suggestionsDropdown.appendChild(suggestionItem);
          });

          suggestionsDropdown.style.display = suggestions.length > 0 ? "block" : "none";
        };

        // Remove the old updateSuggestions function definition
        // Add event listeners to input
        businessFocusInput.addEventListener("focus", updateSuggestionsLocal);
        businessFocusInput.addEventListener("input", () => {
          // Filter suggestions based on input
          const filterText = businessFocusInput.value.toLowerCase();
          const suggestionItems = suggestionsDropdown.querySelectorAll("div");

          let visibleCount = 0;
          suggestionItems.forEach(item => {
            const text = item.querySelector("span:first-child").textContent.toLowerCase();
            if (text.includes(filterText) || filterText === "") {
              item.style.display = "flex";
              visibleCount++;
            } else {
              item.style.display = "none";
            }
          });

          suggestionsDropdown.style.display = visibleCount > 0 ? "block" : "none";
        });

        suggestBtn.addEventListener("click", (e) => {
          e.preventDefault();
          updateSuggestionsLocal();
          if (suggestionsDropdown.style.display === "none" || suggestionsDropdown.style.display === "") {
            suggestionsDropdown.style.display = "block";
          } else {
            suggestionsDropdown.style.display = "none";
          }
        });

        rowBusinessFocus.appendChild(businessFocusLabel);
        rowBusinessFocus.appendChild(businessFocusContainer);
        if (idBadge.textContent) {
          rowBusinessFocus.appendChild(idBadge);
        }
        rowBusinessFocus.appendChild(suggestBtn);
        rowBusinessFocus.appendChild(createCopyBtn("ai_primary_business_focus", "primary_business_focus", "Business Focus"));
        rowBusinessFocus.appendChild(createSaveBtn("ai_primary_business_focus", "primary_business_focus", "Business Focus"));

        // AI Sectors row (read-only chips from AI research)
        const rowSectors = document.createElement("div");
        rowSectors.style.display = "flex";
        rowSectors.style.flexWrap = "wrap";
        rowSectors.style.gap = "4px";
        rowSectors.style.marginTop = "6px";
        rowSectors.style.alignItems = "center";

        const sectorsLabel = document.createElement("span");
        sectorsLabel.textContent = "üìä Sectors (AI):";
        sectorsLabel.style.fontSize = "11px";
        sectorsLabel.style.color = "#9ca3af";
        sectorsLabel.style.marginRight = "4px";
        sectorsLabel.style.fontWeight = "600";
        rowSectors.appendChild(sectorsLabel);

        if (data.sectors && data.sectors.length) {
          const primarySectorsAi = data.sectors.filter(
            (s) => (s.importance || "").toLowerCase() === "primary"
          );
          const secondarySectorsAi = data.sectors.filter(
            (s) => (s.importance || "").toLowerCase() === "secondary"
          );
          const otherSectorsAi = data.sectors.filter(
            (s) =>
              !s.importance ||
              (s.importance.toLowerCase() !== "primary" &&
                s.importance.toLowerCase() !== "secondary")
          );

          primarySectorsAi.forEach((s) => {
            const badge = document.createElement("span");
            badge.textContent = "üéØ " + (s.sector || s.name || s);
            badge.style.background = "rgba(59, 130, 246, 0.18)";
            badge.style.color = "#bfdbfe";
            badge.style.padding = "2px 8px";
            badge.style.borderRadius = "999px";
            badge.style.border = "1px solid rgba(59, 130, 246, 0.5)";
            badge.title = "Primary sector (AI guess)";
            rowSectors.appendChild(badge);
          });

          secondarySectorsAi.forEach((s) => {
            const badge = document.createElement("span");
            badge.textContent = "üìä " + (s.sector || s.name || s);
            badge.style.background = "rgba(96, 165, 250, 0.12)";
            badge.style.color = "#bfdbfe";
            badge.style.padding = "2px 8px";
            badge.style.borderRadius = "999px";
            badge.style.border = "1px solid rgba(96, 165, 250, 0.4)";
            badge.title = "Secondary sector (AI guess)";
            rowSectors.appendChild(badge);
          });

          if (
            otherSectorsAi.length &&
            primarySectorsAi.length === 0 &&
            secondarySectorsAi.length === 0
          ) {
            const sectorsText = otherSectorsAi
              .map((s) => s.sector || s.name || s)
              .join(", ");
            const badge = document.createElement("span");
            badge.textContent = "üìä " + sectorsText;
            badge.style.background = "rgba(148, 163, 184, 0.12)";
            badge.style.color = "#e5e7eb";
            badge.style.padding = "2px 8px";
            badge.style.borderRadius = "999px";
            badge.style.border = "1px solid rgba(148, 163, 184, 0.4)";
            badge.title = "Sectors (AI guess)";
            rowSectors.appendChild(badge);
          }
        } else {
          const placeholder = document.createElement("span");
          placeholder.textContent = "Not detected";
          placeholder.style.fontSize = "11px";
          placeholder.style.color = "#6b7280";
          rowSectors.appendChild(placeholder);
        }

        // Save Sectors button (if sectors exist and company is in DB)
        if (data.sectors && data.sectors.length > 0) {
          const saveSectorsBtn = document.createElement("button");
          saveSectorsBtn.type = "button";
          saveSectorsBtn.title = "Save Sectors to DB";
          saveSectorsBtn.innerHTML = "üíæ Save Sectors";
          saveSectorsBtn.style.padding = "3px 8px";
          saveSectorsBtn.style.fontSize = "10px";
          saveSectorsBtn.style.borderRadius = "4px";
          saveSectorsBtn.style.border = "1px solid rgba(16, 185, 129, 0.3)";
          saveSectorsBtn.style.background = "rgba(16, 185, 129, 0.1)";
          saveSectorsBtn.style.color = "#6ee7b7";
          saveSectorsBtn.style.cursor = "pointer";
          saveSectorsBtn.style.marginLeft = "8px";
          saveSectorsBtn.style.transition = "all 0.15s ease";
          saveSectorsBtn.style.display = "none"; // Hidden until company exists in DB
          saveSectorsBtn.className = "save-to-db-btn";
          
          saveSectorsBtn.onmouseover = () => {
            saveSectorsBtn.style.background = "rgba(16, 185, 129, 0.25)";
            saveSectorsBtn.style.borderColor = "rgba(16, 185, 129, 0.5)";
          };
          saveSectorsBtn.onmouseout = () => {
            saveSectorsBtn.style.background = "rgba(16, 185, 129, 0.1)";
            saveSectorsBtn.style.borderColor = "rgba(16, 185, 129, 0.3)";
          };
          
          saveSectorsBtn.onclick = async () => {
            if (!window._dbCompanyId) {
              log("No company ID - cannot save sectors", "err");
              return;
            }
            
            saveSectorsBtn.innerHTML = "‚è≥";
            saveSectorsBtn.disabled = true;
            
            try {
              // Step 1: Lookup sector IDs for all sectors
              const allSectors = data.sectors || [];
              const sectorIds = [];
              
              log(`Looking up ${allSectors.length} sectors...`, "info");
              
              for (const sector of allSectors) {
                const sectorName = sector.sector || sector.name || "";
                if (!sectorName) continue;
                
                try {
                  const lookupUrl = `${XANO_BASE}/api:8Bv5PK4I/sectors_lookup?sector_name=${encodeURIComponent(sectorName)}`;
                  log(`Looking up sector: ${sectorName}...`, "info");
                  
                  const lookupRes = await fetch(lookupUrl, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                  });
                  
                  if (lookupRes.ok) {
                    const lookupData = await lookupRes.json();
                    if (lookupData && lookupData.id) {
                      sectorIds.push(lookupData.id);
                      log(`‚úÖ Found sector ID ${lookupData.id} for "${sectorName}"`, "ok");
                    } else {
                      log(`‚ö†Ô∏è No ID found for sector: ${sectorName}`, "warn");
                    }
                  } else {
                    log(`‚ö†Ô∏è Lookup failed for sector: ${sectorName}`, "warn");
                  }
                } catch (lookupErr) {
                  log(`‚ö†Ô∏è Error looking up sector "${sectorName}": ${lookupErr.message}`, "warn");
                }
              }
              
              if (sectorIds.length === 0) {
                log("‚ùå No sector IDs found - cannot save", "err");
                saveSectorsBtn.innerHTML = "‚ùå";
                saveSectorsBtn.style.background = "rgba(239, 68, 68, 0.2)";
                setTimeout(() => {
                  saveSectorsBtn.innerHTML = "üíæ Save Sectors";
                  saveSectorsBtn.style.background = "rgba(16, 185, 129, 0.1)";
                  saveSectorsBtn.disabled = false;
                }, 2000);
                return;
              }
              
              // Step 2: Save sectors_id array to company
              log(`Saving ${sectorIds.length} sector IDs: [${sectorIds.join(", ")}]`, "info");
              
              const response = await fetch(
                `${XANO_BASE}/api:8Bv5PK4I/edit_company/${window._dbCompanyId}`,
                {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    new_company_id: window._dbCompanyId,
                    updates: {
                      sectors_id: sectorIds
                    }
                  })
                }
              );
              
              const result = await response.json();
              
              if (response.ok && result.success) {
                saveSectorsBtn.innerHTML = "‚úÖ";
                saveSectorsBtn.style.background = "rgba(16, 185, 129, 0.3)";
                log(`‚úÖ Saved ${sectorIds.length} sectors (IDs: [${sectorIds.join(", ")}])`, "ok");
                
                // Refresh Xano data
                await refreshXanoData();
                
                setTimeout(() => {
                  saveSectorsBtn.innerHTML = "üíæ Save Sectors";
                  saveSectorsBtn.style.background = "rgba(16, 185, 129, 0.1)";
                  saveSectorsBtn.disabled = false;
                }, 2000);
              } else {
                saveSectorsBtn.innerHTML = "‚ùå";
                saveSectorsBtn.style.background = "rgba(239, 68, 68, 0.2)";
                log(`‚ùå Failed to save sectors: ${result.message || "Unknown error"}`, "err");
                setTimeout(() => {
                  saveSectorsBtn.innerHTML = "üíæ Save Sectors";
                  saveSectorsBtn.style.background = "rgba(16, 185, 129, 0.1)";
                  saveSectorsBtn.disabled = false;
                }, 2000);
              }
            } catch (err) {
              saveSectorsBtn.innerHTML = "‚ùå";
              saveSectorsBtn.style.background = "rgba(239, 68, 68, 0.2)";
              log(`‚ùå Error saving sectors: ${err.message}`, "err");
              setTimeout(() => {
                saveSectorsBtn.innerHTML = "üíæ Save Sectors";
                saveSectorsBtn.style.background = "rgba(16, 185, 129, 0.1)";
                saveSectorsBtn.disabled = false;
              }, 2000);
            }
          };
          
          rowSectors.appendChild(saveSectorsBtn);
        }

        // Ownership Status row
        const rowOwnership = document.createElement("div");
        rowOwnership.style.display = "flex";
        rowOwnership.style.gap = "6px";
        rowOwnership.style.marginTop = "6px";
        rowOwnership.style.alignItems = "center";

        const ownershipLabel = document.createElement("span");
        ownershipLabel.textContent = "Ownership:";
        ownershipLabel.style.fontSize = "11px";
        ownershipLabel.style.color = "#9ca3af";
        ownershipLabel.style.minWidth = "70px";

        const ownershipSelect = document.createElement("select");
        ownershipSelect.id = "ai_ownership";
        ownershipSelect.style.flex = "1";
        ownershipSelect.style.padding = "4px 8px";
        ownershipSelect.style.borderRadius = "999px";
        ownershipSelect.style.border = "1px solid #1f2937";
        ownershipSelect.style.background = "#020617";
        ownershipSelect.style.color = "#e5e7eb";
        ownershipSelect.style.fontSize = "11px";
        ownershipSelect.style.cursor = "pointer";

        const ownershipTypes = [
          "", 
          // Public vs Private
          "Public", "Private",
          // By Investor/Owner Type  
          "Venture-Backed", "Private Equity-Backed", "Family-Owned", 
          "Employee-Owned", "Founder-Owned", "Institutional-Owned",
          // Special Categories
          "Government-Owned", "Non-Profit", "Subsidiary", 
          "Cooperative", "Partnership"
        ];

        ownershipTypes.forEach(ot => {
          const option = document.createElement("option");
          option.value = ot;
          option.textContent = ot || "-- Select Ownership --";
          if (ot.toLowerCase() === (data.ownership || "").toLowerCase()) {
            option.selected = true;
          }
          ownershipSelect.appendChild(option);
        });

        rowOwnership.appendChild(ownershipLabel);
        rowOwnership.appendChild(ownershipSelect);
        rowOwnership.appendChild(createCopyBtn("ai_ownership", "ownership", "Ownership"));
        rowOwnership.appendChild(createSaveBtn("ai_ownership", "ownership_status", "Ownership"));

        // Year Founded row
        const rowExtra = document.createElement("div");
        rowExtra.style.display = "flex";
        rowExtra.style.gap = "6px";
        rowExtra.style.marginTop = "6px";
        rowExtra.style.alignItems = "center";

        const yearLabel = document.createElement("span");
        yearLabel.textContent = "Founded:";
        yearLabel.style.fontSize = "11px";
        yearLabel.style.color = "#9ca3af";
        yearLabel.style.minWidth = "55px";

        const yearInput = document.createElement("input");
        yearInput.type = "text";
        yearInput.id = "ai_year_founded";
        yearInput.placeholder = "Year";
        yearInput.value = data.year_founded || "";
        yearInput.style.width = "70px";
        yearInput.style.padding = "3px 7px";
        yearInput.style.borderRadius = "999px";
        yearInput.style.border = "1px solid #1f2937";
        yearInput.style.background = "#020617";
        yearInput.style.color = "#e5e7eb";
        yearInput.style.fontSize = "11px";
        yearInput.style.textAlign = "center";

        rowExtra.appendChild(yearLabel);
        rowExtra.appendChild(yearInput);
        rowExtra.appendChild(createCopyBtn("ai_year_founded", "year_founded", "Year Founded"));
        rowExtra.appendChild(createSaveBtn("ai_year_founded", "year_founded", "Year Founded"));

        // Press/News Page URL row
        const rowPressPage = document.createElement("div");
        rowPressPage.style.display = "flex";
        rowPressPage.style.gap = "6px";
        rowPressPage.style.marginTop = "6px";
        rowPressPage.style.alignItems = "center";

        const pressPageLabel = document.createElement("span");
        pressPageLabel.textContent = "üì∞ Press Page:";
        pressPageLabel.style.fontSize = "11px";
        pressPageLabel.style.color = "#9ca3af";
        pressPageLabel.style.minWidth = "80px";

        const pressPageInput = document.createElement("input");
        pressPageInput.type = "text";
        pressPageInput.id = "ai_webpage_monitored";
        pressPageInput.placeholder = "e.g., https://company.com/press";
        pressPageInput.value = data.webpage_monitored || "";
        pressPageInput.style.flex = "1";
        pressPageInput.style.padding = "3px 7px";
        pressPageInput.style.borderRadius = "999px";
        pressPageInput.style.border = "1px solid #1f2937";
        pressPageInput.style.background = "#020617";
        pressPageInput.style.color = "#e5e7eb";
        pressPageInput.style.fontSize = "11px";

        rowPressPage.appendChild(pressPageLabel);
        rowPressPage.appendChild(pressPageInput);
        rowPressPage.appendChild(createCopyBtn("ai_webpage_monitored", "webpage_monitored", "Press Page"));
        rowPressPage.appendChild(createSaveBtn("ai_webpage_monitored", "webpage_monitored", "Press Page"));

        const rowLinks = document.createElement("div");
        rowLinks.style.display = "flex";
        rowLinks.style.gap = "6px";
        rowLinks.style.marginTop = "6px";

        const websiteInput = document.createElement("input");
        websiteInput.type = "text";
        websiteInput.id = "ai_website";
        websiteInput.placeholder = "Website URL";
        websiteInput.value = data.website || "";
        websiteInput.style.flex = "1";
        websiteInput.style.padding = "3px 7px";
        websiteInput.style.borderRadius = "999px";
        websiteInput.style.border = "1px solid #1f2937";
        websiteInput.style.background = "#020617";
        websiteInput.style.color = "#e5e7eb";
        websiteInput.style.fontSize = "11px";

        const linkedinInput = document.createElement("input");
        linkedinInput.type = "text";
        linkedinInput.id = "ai_linkedin";
        linkedinInput.placeholder = "LinkedIn URL";
        linkedinInput.value = data.linkedin || "";
        linkedinInput.style.flex = "1";
        linkedinInput.style.padding = "3px 7px";
        linkedinInput.style.borderRadius = "999px";
        linkedinInput.style.border = "1px solid #1f2937";
        linkedinInput.style.background = "#020617";
        linkedinInput.style.color = "#e5e7eb";
        linkedinInput.style.fontSize = "11px";

        rowLinks.appendChild(websiteInput);
        rowLinks.appendChild(createCopyBtn("ai_website", "website", "Website"));
        rowLinks.appendChild(createSaveBtn("ai_website", "website", "Website"));
        rowLinks.appendChild(linkedinInput);
        rowLinks.appendChild(createCopyBtn("ai_linkedin", "linkedin", "LinkedIn"));
        rowLinks.appendChild(createSaveBtn("ai_linkedin", "linkedin", "LinkedIn"));

        const desc = document.createElement("textarea");
        desc.id = "ai_description";
        desc.value = data.description || "";
        desc.placeholder = "AI‚Äëgenerated description (editable)";
        desc.style.width = "100%";
        desc.style.marginTop = "6px";
        desc.style.minHeight = "70px";
        desc.style.padding = "5px 8px";
        desc.style.borderRadius = "8px";
        desc.style.border = "1px solid #1f2937";
        desc.style.background = "#020617";
        desc.style.color = "#e5e7eb";
        desc.style.fontSize = "12px";

        // "Copy from DB" button container
        const copyFromDbContainer = document.createElement("div");
        copyFromDbContainer.id = "copyFromDbContainer";
        copyFromDbContainer.style.marginTop = "8px";
        copyFromDbContainer.style.display = "none"; // Hidden by default, shown if DB has description

        const copyFromDbBtn = document.createElement("button");
        copyFromDbBtn.id = "copyFromDbBtn";
        copyFromDbBtn.innerHTML = "üìã Copy Description from Database";
        copyFromDbBtn.style.padding = "6px 12px";
        copyFromDbBtn.style.borderRadius = "8px";
        copyFromDbBtn.style.border = "1px solid rgba(99, 102, 241, 0.4)";
        copyFromDbBtn.style.background = "rgba(99, 102, 241, 0.15)";
        copyFromDbBtn.style.color = "#a5b4fc";
        copyFromDbBtn.style.fontSize = "11px";
        copyFromDbBtn.style.cursor = "pointer";
        copyFromDbBtn.style.transition = "all 0.15s ease";
        copyFromDbBtn.onmouseover = () => {
          copyFromDbBtn.style.background = "rgba(99, 102, 241, 0.25)";
          copyFromDbBtn.style.borderColor = "rgba(99, 102, 241, 0.6)";
        };
        copyFromDbBtn.onmouseout = () => {
          copyFromDbBtn.style.background = "rgba(99, 102, 241, 0.15)";
          copyFromDbBtn.style.borderColor = "rgba(99, 102, 241, 0.4)";
        };
        copyFromDbBtn.onclick = () => {
          if (window._dbDescription) {
            desc.value = window._dbDescription;
            log("Copied description from database", "ok");
            // Visual feedback
            copyFromDbBtn.innerHTML = "‚úÖ Copied!";
            copyFromDbBtn.style.background = "rgba(16, 185, 129, 0.2)";
            copyFromDbBtn.style.borderColor = "rgba(16, 185, 129, 0.5)";
            copyFromDbBtn.style.color = "#6ee7b7";
            setTimeout(() => {
              copyFromDbBtn.innerHTML = "üìã Copy Description from Database";
              copyFromDbBtn.style.background = "rgba(99, 102, 241, 0.15)";
              copyFromDbBtn.style.borderColor = "rgba(99, 102, 241, 0.4)";
              copyFromDbBtn.style.color = "#a5b4fc";
            }, 2000);
          }
        };
        copyFromDbContainer.appendChild(copyFromDbBtn);
        
        // Save description button
        const saveDescBtn = createSaveBtn("ai_description", "description", "Description");
        saveDescBtn.style.marginLeft = "8px";
        copyFromDbContainer.appendChild(saveDescBtn);

        // "Create in DB" button container (shown when company NOT in database)
        const createInDbContainer = document.createElement("div");
        createInDbContainer.id = "createInDbContainer";
        createInDbContainer.style.marginTop = "10px";
        // Show by default if company is NOT in DB (checked via global flag)
        createInDbContainer.style.display = window._companyExistsInDb ? "none" : "block";

        const createInDbBtn = document.createElement("button");
        createInDbBtn.id = "createInDbBtn";
        createInDbBtn.innerHTML = "‚ûï Create Company in Database";
        createInDbBtn.style.padding = "8px 16px";
        createInDbBtn.style.borderRadius = "8px";
        createInDbBtn.style.border = "1px solid rgba(16, 185, 129, 0.4)";
        createInDbBtn.style.background = "rgba(16, 185, 129, 0.15)";
        createInDbBtn.style.color = "#6ee7b7";
        createInDbBtn.style.fontSize = "12px";
        createInDbBtn.style.fontWeight = "600";
        createInDbBtn.style.cursor = "pointer";
        createInDbBtn.style.transition = "all 0.15s ease";
        createInDbBtn.onmouseover = () => {
          createInDbBtn.style.background = "rgba(16, 185, 129, 0.25)";
          createInDbBtn.style.borderColor = "rgba(16, 185, 129, 0.6)";
        };
        createInDbBtn.onmouseout = () => {
          createInDbBtn.style.background = "rgba(16, 185, 129, 0.15)";
          createInDbBtn.style.borderColor = "rgba(16, 185, 129, 0.4)";
        };
        createInDbBtn.onclick = async () => {
          await createCompanyInDb(createInDbBtn);
        };
        createInDbContainer.appendChild(createInDbBtn);

        card.appendChild(rowName);
        card.appendChild(rowLoc);
        card.appendChild(rowBusinessFocus);
        card.appendChild(rowSectors);
        card.appendChild(rowOwnership);
        card.appendChild(rowExtra);
        card.appendChild(rowPressPage);
        card.appendChild(rowLinks);
        card.appendChild(desc);
        card.appendChild(copyFromDbContainer);
        card.appendChild(createInDbContainer);

        aiOverviewEl.appendChild(card);
      }

      function renderDBOverview(data) {
        dbOverviewEl.innerHTML = "";
        // Reset the DB description and overview data
        window._dbDescription = null;
        window._dbOverviewData = null;
        
        if (!data) {
          dbOverviewEl.innerHTML =
            '<div class="empty-state">No DB overview available.</div>';
          dbOverviewMeta.textContent = "No company";
          // Hide the "Copy from DB" button
          const copyContainer = document.getElementById("copyFromDbContainer");
          if (copyContainer) copyContainer.style.display = "none";
          // Hide all copy buttons
          document.querySelectorAll(".copy-from-db-btn").forEach(btn => btn.style.display = "none");
          return;
        }
        
        // Store DB overview data for copy buttons
        window._dbOverviewData = data;
        showCopyButtons();
        showSaveButtons();
        
        dbOverviewMeta.textContent = "Loaded from Xano";

        const card = document.createElement("div");
        card.className = "event-card";

        // Name row (read-only, matches AI side layout)
        const rowName = document.createElement("div");
        rowName.style.display = "flex";
        rowName.style.alignItems = "center";
        rowName.style.gap = "4px";

        const nameDisplay = document.createElement("div");
        nameDisplay.textContent = data.name || "Unknown company";
        nameDisplay.style.flex = "1";
        nameDisplay.style.padding = "5px 8px";
        nameDisplay.style.borderRadius = "8px";
        nameDisplay.style.border = "1px solid #1f2937";
        nameDisplay.style.background = "#020617";
        nameDisplay.style.color = "#e5e7eb";
        nameDisplay.style.fontSize = "13px";
        nameDisplay.style.cursor = "default";

        rowName.appendChild(nameDisplay);
        card.appendChild(rowName);

        // Location row (read-only, matches AI side layout)
        const rowLoc = document.createElement("div");
        rowLoc.style.display = "flex";
        rowLoc.style.gap = "6px";
        rowLoc.style.marginTop = "6px";

        const cityDisplay = document.createElement("div");
        cityDisplay.textContent = data.city || "";
        cityDisplay.style.flex = "1";
        cityDisplay.style.padding = "3px 7px";
        cityDisplay.style.borderRadius = "999px";
        cityDisplay.style.border = "1px solid #1f2937";
        cityDisplay.style.background = "#020617";
        cityDisplay.style.color = "#e5e7eb";
        cityDisplay.style.fontSize = "11px";
        cityDisplay.style.cursor = "default";

        const countryDisplay = document.createElement("div");
        countryDisplay.textContent = data.country || "";
        countryDisplay.style.flex = "1";
        countryDisplay.style.padding = "3px 7px";
        countryDisplay.style.borderRadius = "999px";
        countryDisplay.style.border = "1px solid #1f2937";
        countryDisplay.style.background = "#020617";
        countryDisplay.style.color = "#e5e7eb";
        countryDisplay.style.fontSize = "11px";
        countryDisplay.style.cursor = "default";

        rowLoc.appendChild(cityDisplay);
        rowLoc.appendChild(countryDisplay);
        card.appendChild(rowLoc);

        // Primary Business Focus row (read-only, matches AI side layout)
        const rowBusinessFocus = document.createElement("div");
        rowBusinessFocus.style.display = "flex";
        rowBusinessFocus.style.gap = "6px";
        rowBusinessFocus.style.marginTop = "6px";
        rowBusinessFocus.style.alignItems = "center";

        const businessFocusLabel = document.createElement("span");
        businessFocusLabel.textContent = "üéØ Primary Business Focus:";
        businessFocusLabel.style.fontSize = "11px";
        businessFocusLabel.style.color = "#9ca3af";
        businessFocusLabel.style.minWidth = "140px";
        businessFocusLabel.style.fontWeight = "600";

        const businessFocusDisplay = document.createElement("div");
        businessFocusDisplay.textContent = data.primary_business_focus || "";
        businessFocusDisplay.style.flex = "1";
        businessFocusDisplay.style.padding = "3px 7px";
        businessFocusDisplay.style.borderRadius = "999px";
        businessFocusDisplay.style.border = "1px solid #1f2937";
        businessFocusDisplay.style.background = "#020617";
        businessFocusDisplay.style.color = "#e5e7eb";
        businessFocusDisplay.style.fontSize = "11px";
        businessFocusDisplay.style.cursor = "default";

        // Show ID badge if available
        if (data.primary_business_focus_id && data.primary_business_focus_id > 0) {
          const idBadge = document.createElement("span");
          idBadge.textContent = `ID: ${data.primary_business_focus_id}`;
          idBadge.style.fontSize = "9px";
          idBadge.style.color = "#10b981";
          idBadge.style.background = "rgba(16, 185, 129, 0.15)";
          idBadge.style.padding = "2px 6px";
          idBadge.style.borderRadius = "4px";
          idBadge.style.border = "1px solid rgba(16, 185, 129, 0.3)";
          idBadge.title = "Database ID";
          rowBusinessFocus.appendChild(businessFocusLabel);
          rowBusinessFocus.appendChild(businessFocusDisplay);
          rowBusinessFocus.appendChild(idBadge);
        } else if (data.primary_business_focus) {
          rowBusinessFocus.appendChild(businessFocusLabel);
          rowBusinessFocus.appendChild(businessFocusDisplay);
        }
        card.appendChild(rowBusinessFocus);

        // Sectors row (read-only, matches AI side layout)
        const rowSectors = document.createElement("div");
        rowSectors.style.display = "flex";
        rowSectors.style.flexWrap = "wrap";
        rowSectors.style.gap = "4px";
        rowSectors.style.marginTop = "6px";
        rowSectors.style.alignItems = "center";

        const sectorsLabel = document.createElement("span");
        sectorsLabel.textContent = "üìä Sectors (DB):";
        sectorsLabel.style.fontSize = "11px";
        sectorsLabel.style.color = "#9ca3af";
        sectorsLabel.style.marginRight = "4px";
        sectorsLabel.style.fontWeight = "600";
        rowSectors.appendChild(sectorsLabel);

        if (data.sectors && data.sectors.length) {
          const primarySectors = data.sectors.filter(s => (s.importance || "").toLowerCase() === "primary");
          const secondarySectors = data.sectors.filter(s => (s.importance || "").toLowerCase() === "secondary");
          const otherSectors = data.sectors.filter(s => !s.importance || (s.importance.toLowerCase() !== "primary" && s.importance.toLowerCase() !== "secondary"));

          primarySectors.forEach(s => {
            const badge = document.createElement("span");
            badge.textContent = "üéØ " + (s.sector || s.name || s);
            badge.style.background = "rgba(59, 130, 246, 0.18)";
            badge.style.color = "#bfdbfe";
            badge.style.padding = "2px 8px";
            badge.style.borderRadius = "999px";
            badge.style.border = "1px solid rgba(59, 130, 246, 0.5)";
            badge.title = "Primary sector";
            rowSectors.appendChild(badge);
          });

          secondarySectors.forEach(s => {
            const badge = document.createElement("span");
            badge.textContent = "üìä " + (s.sector || s.name || s);
            badge.style.background = "rgba(96, 165, 250, 0.12)";
            badge.style.color = "#bfdbfe";
            badge.style.padding = "2px 8px";
            badge.style.borderRadius = "999px";
            badge.style.border = "1px solid rgba(96, 165, 250, 0.4)";
            badge.title = "Secondary sector";
            rowSectors.appendChild(badge);
          });

          if (otherSectors.length && primarySectors.length === 0 && secondarySectors.length === 0) {
            const sectorsText = otherSectors.map(s => s.sector || s.name || s).join(", ");
            const badge = document.createElement("span");
            badge.textContent = "üìä " + sectorsText;
            badge.style.background = "rgba(148, 163, 184, 0.12)";
            badge.style.color = "#e5e7eb";
            badge.style.padding = "2px 8px";
            badge.style.borderRadius = "999px";
            badge.style.border = "1px solid rgba(148, 163, 184, 0.4)";
            badge.title = "Sectors";
            rowSectors.appendChild(badge);
          }
        } else {
          const placeholder = document.createElement("span");
          placeholder.textContent = "Not set";
          placeholder.style.fontSize = "11px";
          placeholder.style.color = "#6b7280";
          rowSectors.appendChild(placeholder);
        }
        card.appendChild(rowSectors);

        // Ownership Status row (read-only, matches AI side layout)
        const rowOwnership = document.createElement("div");
        rowOwnership.style.display = "flex";
        rowOwnership.style.gap = "6px";
        rowOwnership.style.marginTop = "6px";
        rowOwnership.style.alignItems = "center";

        const ownershipLabel = document.createElement("span");
        ownershipLabel.textContent = "Ownership:";
        ownershipLabel.style.fontSize = "11px";
        ownershipLabel.style.color = "#9ca3af";
        ownershipLabel.style.minWidth = "70px";

        const ownershipDisplay = document.createElement("div");
        ownershipDisplay.textContent = data.ownership || "";
        ownershipDisplay.style.flex = "1";
        ownershipDisplay.style.padding = "4px 8px";
        ownershipDisplay.style.borderRadius = "999px";
        ownershipDisplay.style.border = "1px solid #1f2937";
        ownershipDisplay.style.background = "#020617";
        ownershipDisplay.style.color = "#e5e7eb";
        ownershipDisplay.style.fontSize = "11px";
        ownershipDisplay.style.cursor = "default";

        rowOwnership.appendChild(ownershipLabel);
        rowOwnership.appendChild(ownershipDisplay);
        card.appendChild(rowOwnership);

        // Year Founded row (read-only, matches AI side layout)
        const rowExtra = document.createElement("div");
        rowExtra.style.display = "flex";
        rowExtra.style.gap = "6px";
        rowExtra.style.marginTop = "6px";
        rowExtra.style.alignItems = "center";

        const yearLabel = document.createElement("span");
        yearLabel.textContent = "Founded:";
        yearLabel.style.fontSize = "11px";
        yearLabel.style.color = "#9ca3af";
        yearLabel.style.minWidth = "55px";

        const yearDisplay = document.createElement("div");
        yearDisplay.textContent = data.year_founded || "";
        yearDisplay.style.width = "70px";
        yearDisplay.style.padding = "3px 7px";
        yearDisplay.style.borderRadius = "999px";
        yearDisplay.style.border = "1px solid #1f2937";
        yearDisplay.style.background = "#020617";
        yearDisplay.style.color = "#e5e7eb";
        yearDisplay.style.fontSize = "11px";
        yearDisplay.style.textAlign = "center";
        yearDisplay.style.cursor = "default";

        rowExtra.appendChild(yearLabel);
        rowExtra.appendChild(yearDisplay);
        card.appendChild(rowExtra);

        // Press/News Page URL row (read-only, matches AI side layout)
        const rowPressPage = document.createElement("div");
        rowPressPage.style.display = "flex";
        rowPressPage.style.gap = "6px";
        rowPressPage.style.marginTop = "6px";
        rowPressPage.style.alignItems = "center";

        const pressPageLabel = document.createElement("span");
        pressPageLabel.textContent = "üì∞ Press Page:";
        pressPageLabel.style.fontSize = "11px";
        pressPageLabel.style.color = "#9ca3af";
        pressPageLabel.style.minWidth = "80px";

        const pressPageDisplay = document.createElement("div");
        if (data.webpage_monitored) {
          const pressLink = document.createElement("a");
          pressLink.href = data.webpage_monitored;
          pressLink.target = "_blank";
          pressLink.textContent = data.webpage_monitored;
          pressLink.style.flex = "1";
          pressLink.style.padding = "3px 7px";
          pressLink.style.borderRadius = "999px";
          pressLink.style.border = "1px solid #1f2937";
          pressLink.style.background = "#020617";
          pressLink.style.color = "#3b82f6";
          pressLink.style.fontSize = "11px";
          pressLink.style.textDecoration = "none";
          pressLink.style.overflow = "hidden";
          pressLink.style.textOverflow = "ellipsis";
          pressLink.style.whiteSpace = "nowrap";
          pressPageDisplay.appendChild(pressLink);
        } else {
          pressPageDisplay.textContent = "";
          pressPageDisplay.style.flex = "1";
        }

        rowPressPage.appendChild(pressPageLabel);
        rowPressPage.appendChild(pressPageDisplay);
        card.appendChild(rowPressPage);

        // Links row (read-only, matches AI side layout)
        const rowLinks = document.createElement("div");
        rowLinks.style.display = "flex";
        rowLinks.style.gap = "6px";
        rowLinks.style.marginTop = "6px";

        const websiteDisplay = document.createElement("div");
        if (data.website) {
          const websiteLink = document.createElement("a");
          websiteLink.href = data.website;
          websiteLink.target = "_blank";
          websiteLink.textContent = data.website;
          websiteLink.style.flex = "1";
          websiteLink.style.padding = "3px 7px";
          websiteLink.style.borderRadius = "999px";
          websiteLink.style.border = "1px solid #1f2937";
          websiteLink.style.background = "#020617";
          websiteLink.style.color = "#3b82f6";
          websiteLink.style.fontSize = "11px";
          websiteLink.style.textDecoration = "none";
          websiteLink.style.overflow = "hidden";
          websiteLink.style.textOverflow = "ellipsis";
          websiteLink.style.whiteSpace = "nowrap";
          websiteDisplay.appendChild(websiteLink);
        } else {
          websiteDisplay.textContent = "";
          websiteDisplay.style.flex = "1";
        }

        const linkedinDisplay = document.createElement("div");
        if (data.linkedin) {
          const linkedinLink = document.createElement("a");
          linkedinLink.href = data.linkedin;
          linkedinLink.target = "_blank";
          linkedinLink.textContent = data.linkedin;
          linkedinLink.style.flex = "1";
          linkedinLink.style.padding = "3px 7px";
          linkedinLink.style.borderRadius = "999px";
          linkedinLink.style.border = "1px solid #1f2937";
          linkedinLink.style.background = "#020617";
          linkedinLink.style.color = "#3b82f6";
          linkedinLink.style.fontSize = "11px";
          linkedinLink.style.textDecoration = "none";
          linkedinLink.style.overflow = "hidden";
          linkedinLink.style.textOverflow = "ellipsis";
          linkedinLink.style.whiteSpace = "nowrap";
          linkedinDisplay.appendChild(linkedinLink);
        } else {
          linkedinDisplay.textContent = "";
          linkedinDisplay.style.flex = "1";
        }

        rowLinks.appendChild(websiteDisplay);
        rowLinks.appendChild(linkedinDisplay);
        card.appendChild(rowLinks);

        // Description (read-only, matches AI side layout)
        const desc = document.createElement("div");
        desc.textContent = data.description || "";
        desc.style.width = "100%";
        desc.style.marginTop = "6px";
        desc.style.minHeight = "70px";
        desc.style.padding = "5px 8px";
        desc.style.borderRadius = "8px";
        desc.style.border = "1px solid #1f2937";
        desc.style.background = "#020617";
        desc.style.color = "#e5e7eb";
        desc.style.fontSize = "12px";
        desc.style.whiteSpace = "pre-wrap";
        desc.style.cursor = "default";

        // Store the DB description for copy functionality
        if (data.description) {
          window._dbDescription = data.description;
          const copyContainer = document.getElementById("copyFromDbContainer");
          if (copyContainer) {
            copyContainer.style.display = "block";
          }
        } else {
          // Hide the "Copy from DB" button if no description
          const copyContainer = document.getElementById("copyFromDbContainer");
          if (copyContainer) copyContainer.style.display = "none";
        }

        dbOverviewEl.appendChild(card);
      }

      function renderTopManagement(executives) {
        topManagementEl.innerHTML = "";
        if (!executives || !executives.length) {
          topManagementEl.innerHTML =
            '<div class="empty-state">No top management data found.</div>';
          mgmtMetaEl.textContent = "0 executives";
          return;
        }

        mgmtMetaEl.textContent = `${executives.length} executive${executives.length > 1 ? "s" : ""}`;

        // Create a grid for executives
        const grid = document.createElement("div");
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(320px, 1fr))";
        grid.style.gap = "14px";

        executives.forEach((exec, idx) => {
          const card = document.createElement("div");
          card.className = "event-card";
          card.style.padding = "16px";

          const execName = exec.name || "Unknown";
          const execPosition = exec.position || "";
          const execStatus = exec.status || "Current";
          const execLocation = exec.location || "";
          const execBio = exec.bio || "";
          const execLinkedIn = exec.linkedin_url || "";
          const execEmployeeUrl = exec.current_employee_url || "";

          // Header with name and status
          const header = document.createElement("div");
          header.style.display = "flex";
          header.style.justifyContent = "space-between";
          header.style.alignItems = "flex-start";
          header.style.marginBottom = "12px";

          const headerLeft = document.createElement("div");
          
          const nameDisplay = document.createElement("div");
          nameDisplay.className = "event-title";
          nameDisplay.style.fontSize = "15px";
          nameDisplay.style.marginBottom = "4px";
          nameDisplay.textContent = execName;
          headerLeft.appendChild(nameDisplay);

          const positionDisplay = document.createElement("div");
          positionDisplay.style.fontSize = "12px";
          positionDisplay.style.color = "#a5b4fc";
          positionDisplay.textContent = execPosition;
          headerLeft.appendChild(positionDisplay);

          header.appendChild(headerLeft);

          // Status badge + Edit button
          const headerRight = document.createElement("div");
          headerRight.style.display = "flex";
          headerRight.style.flexDirection = "column";
          headerRight.style.alignItems = "flex-end";
          headerRight.style.gap = "6px";

          const statusBadge = document.createElement("span");
          statusBadge.style.fontSize = "10px";
          statusBadge.style.padding = "3px 10px";
          statusBadge.style.borderRadius = "999px";
          statusBadge.style.whiteSpace = "nowrap";
          if (execStatus.toLowerCase() === "current") {
            statusBadge.style.background = "rgba(16, 185, 129, 0.15)";
            statusBadge.style.color = "#6ee7b7";
            statusBadge.style.border = "1px solid rgba(16, 185, 129, 0.3)";
          } else {
            statusBadge.style.background = "rgba(156, 163, 175, 0.15)";
            statusBadge.style.color = "#9ca3af";
            statusBadge.style.border = "1px solid rgba(156, 163, 175, 0.3)";
          }
          statusBadge.textContent = execStatus;
          headerRight.appendChild(statusBadge);

          header.appendChild(headerRight);
          card.appendChild(header);

          // Info display section
          const infoSection = document.createElement("div");
          infoSection.id = `exec_${idx}_info`;

          if (execLocation) {
            const loc = document.createElement("div");
            loc.style.fontSize = "11px";
            loc.style.color = "#9ca3af";
            loc.style.marginBottom = "8px";
            loc.textContent = "üìç " + execLocation;
            infoSection.appendChild(loc);
          }

          if (execBio) {
            const bio = document.createElement("div");
            bio.style.fontSize = "11px";
            bio.style.color = "#d1d5db";
            bio.style.lineHeight = "1.5";
            bio.style.marginBottom = "8px";
            bio.style.padding = "8px";
            bio.style.background = "rgba(31, 41, 55, 0.3)";
            bio.style.borderRadius = "6px";
            bio.textContent = execBio;
            infoSection.appendChild(bio);
          }

          if (execLinkedIn) {
            const link = document.createElement("a");
            link.href = execLinkedIn;
            link.target = "_blank";
            link.className = "source-link";
            link.style.display = "inline-block";
            link.style.marginBottom = "8px";
            link.textContent = "üîó LinkedIn Profile";
            infoSection.appendChild(link);
          }

          if (execEmployeeUrl) {
            const link = document.createElement("a");
            link.href = execEmployeeUrl;
            link.target = "_blank";
            link.className = "source-link";
            link.style.display = "inline-block";
            link.style.marginBottom = "8px";
            link.textContent = "üåê Company Profile";
            infoSection.appendChild(link);
          }

          card.appendChild(infoSection);

          // Expandable edit section
          const editSection = document.createElement("div");
          editSection.className = "counterparty-details";
          editSection.id = `exec_${idx}_edit`;

          // Helper to create field save button for individual
          function createIndividualFieldSaveBtn(fieldName, getValue, updateKey) {
            const btn = document.createElement("button");
            btn.textContent = "üíæ";
            btn.title = `Save ${fieldName}`;
            btn.style.padding = "8px 12px";
            btn.style.fontSize = "12px";
            btn.style.borderRadius = "8px";
            btn.style.border = "1px solid rgba(16, 185, 129, 0.4)";
            btn.style.background = "rgba(16, 185, 129, 0.15)";
            btn.style.color = "#6ee7b7";
            btn.style.cursor = "pointer";
            btn.style.transition = "all 0.15s ease";
            btn.style.marginLeft = "8px";
            btn.style.flexShrink = "0";
            
            btn.onmouseover = () => {
              btn.style.background = "rgba(16, 185, 129, 0.25)";
              btn.style.borderColor = "rgba(16, 185, 129, 0.6)";
            };
            btn.onmouseout = () => {
              btn.style.background = "rgba(16, 185, 129, 0.15)";
              btn.style.borderColor = "rgba(16, 185, 129, 0.4)";
            };
            
            btn.onclick = async () => {
              btn.disabled = true;
              btn.textContent = "üîç";
              
              // Search for individual
              const result = await searchIndividual(execName, execLinkedIn);
              if (!result || !result.roles || result.roles.length === 0) {
                btn.textContent = "‚ùå";
                log(`‚ùå Individual not found in DB: ${execName}`, "err");
                setTimeout(() => {
                  btn.disabled = false;
                  btn.textContent = "üíæ";
                }, 2000);
                return;
              }
              
              const roleId = result.roles[0].id;
              const value = getValue();
              
              // Handle different field types that need lookups
              let updates = {};
              if (updateKey === "job_title" || updateKey === "position") {
                // Use smart job title lookup (returns array, pick best for PATCH)
                const jobTitleIds = await window.lookupJobTitles(value);

                // For PATCH updates, send single job_title_id (best match)
                if (jobTitleIds.length > 0) {
                  updates = {
                    job_title_id: jobTitleIds[0]  // Use first/best match for updates
                  };
                } else {
                  // If lookup failed, still try to update (API might handle it)
                  log(`‚ö†Ô∏è No job title ID found, skipping update`, "warn");
                  btn.textContent = "‚ùå";
                  setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = "üíæ";
                  }, 2000);
                  return;
                }
              } else if (updateKey === "location_text") {
                // Lookup location_id from location_text
                let locationId = 0;
                if (value) {
                  // Parse location_text (format: "City, Country" or "City, State, Country")
                  const parts = value.split(",").map(p => p.trim()).filter(Boolean);
                  if (parts.length >= 2) {
                    // Assume last part is country, rest is city/state
                    const rawCountry = parts[parts.length - 1];
                    const country = normalizeCountry(rawCountry);
                    const city = parts.slice(0, -1).join(", ");
                    if (country !== rawCountry) {
                      log(`üìç Normalized country: "${rawCountry}" ‚Üí "${country}"`, "info");
                    }
                    locationId = await window.lookupLocation(city, country);
                  } else if (parts.length === 1) {
                    // Single value - try as city, then as country
                    locationId = await window.lookupLocation(parts[0], "");
                    if (!locationId) {
                      const normalizedSingleValue = normalizeCountry(parts[0]);
                      if (normalizedSingleValue !== parts[0]) {
                        log(`üìç Normalized location: "${parts[0]}" ‚Üí "${normalizedSingleValue}"`, "info");
                      }
                      locationId = await window.lookupLocation("", normalizedSingleValue);
                    }
                  }
                }

                // Send location_id
                updates = {
                  location_id: locationId
                };
                log(`‚úÖ Using location_id: ${locationId} for "${value}"`, "ok");
              } else {
                updates = { [updateKey]: value };
              }
              
              await updateIndividual(roleId, updates, btn);
              btn.textContent = "üíæ";
            };
            
            return btn;
          }

          // Name field
          const nameGroup = document.createElement("div");
          nameGroup.className = "form-group";
          const nameLabel = document.createElement("label");
          nameLabel.className = "form-label";
          nameLabel.textContent = "üë§ Name";
          const nameInputRow = document.createElement("div");
          nameInputRow.style.display = "flex";
          nameInputRow.style.alignItems = "center";
          const nameInput = document.createElement("input");
          nameInput.type = "text";
          nameInput.className = "form-input";
          nameInput.id = `exec_${idx}_name`;
          nameInput.value = execName;
          nameInput.style.flex = "1";
          nameInputRow.appendChild(nameInput);
          nameInputRow.appendChild(createIndividualFieldSaveBtn("name", () => nameInput.value.trim(), "name"));
          nameGroup.appendChild(nameLabel);
          nameGroup.appendChild(nameInputRow);
          editSection.appendChild(nameGroup);

          // Job Title field
          const titleGroup = document.createElement("div");
          titleGroup.className = "form-group";
          const titleLabel = document.createElement("label");
          titleLabel.className = "form-label";
          titleLabel.textContent = "üíº Job Title";
          const titleInputRow = document.createElement("div");
          titleInputRow.style.display = "flex";
          titleInputRow.style.alignItems = "center";
          const titleInput = document.createElement("input");
          titleInput.type = "text";
          titleInput.className = "form-input";
          titleInput.id = `exec_${idx}_title`;
          titleInput.value = execPosition;
          titleInput.style.flex = "1";
          titleInputRow.appendChild(titleInput);
          titleInputRow.appendChild(createIndividualFieldSaveBtn("job title", () => titleInput.value.trim(), "job_title"));
          titleGroup.appendChild(titleLabel);
          titleGroup.appendChild(titleInputRow);
          editSection.appendChild(titleGroup);

          // Status field
          const statusGroup = document.createElement("div");
          statusGroup.className = "form-group";
          const statusLabel = document.createElement("label");
          statusLabel.className = "form-label";
          statusLabel.textContent = "üìä Status";
          const statusInputRow = document.createElement("div");
          statusInputRow.style.display = "flex";
          statusInputRow.style.alignItems = "center";
          const statusSelect = document.createElement("select");
          statusSelect.className = "form-select";
          statusSelect.id = `exec_${idx}_status`;
          statusSelect.style.flex = "1";
          ["Current", "Past"].forEach(opt => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            if (opt.toLowerCase() === execStatus.toLowerCase()) o.selected = true;
            statusSelect.appendChild(o);
          });
          statusInputRow.appendChild(statusSelect);
          statusInputRow.appendChild(createIndividualFieldSaveBtn("status", () => statusSelect.value, "status"));
          statusGroup.appendChild(statusLabel);
          statusGroup.appendChild(statusInputRow);
          editSection.appendChild(statusGroup);

          // Location field
          const locGroup = document.createElement("div");
          locGroup.className = "form-group";
          const locLabel = document.createElement("label");
          locLabel.className = "form-label";
          locLabel.textContent = "üìç Location";
          const locInputRow = document.createElement("div");
          locInputRow.style.display = "flex";
          locInputRow.style.alignItems = "center";
          const locInput = document.createElement("input");
          locInput.type = "text";
          locInput.className = "form-input";
          locInput.id = `exec_${idx}_location`;
          locInput.value = execLocation;
          locInput.placeholder = "e.g., San Francisco, CA";
          locInput.style.flex = "1";
          locInputRow.appendChild(locInput);
          locInputRow.appendChild(createIndividualFieldSaveBtn("location", () => locInput.value.trim(), "location_text"));
          locGroup.appendChild(locLabel);
          locGroup.appendChild(locInputRow);
          editSection.appendChild(locGroup);

          // Bio field
          const bioGroup = document.createElement("div");
          bioGroup.className = "form-group";
          const bioLabel = document.createElement("label");
          bioLabel.className = "form-label";
          bioLabel.textContent = "üìù Bio";
          const bioInputRow = document.createElement("div");
          bioInputRow.style.display = "flex";
          bioInputRow.style.alignItems = "flex-start";
          const bioInput = document.createElement("textarea");
          bioInput.className = "form-input";
          bioInput.id = `exec_${idx}_bio`;
          bioInput.value = execBio;
          bioInput.placeholder = "Professional background and experience...";
          bioInput.style.flex = "1";
          bioInput.style.minHeight = "80px";
          bioInput.style.resize = "vertical";
          bioInputRow.appendChild(bioInput);
          bioInputRow.appendChild(createIndividualFieldSaveBtn("bio", () => bioInput.value.trim(), "bio"));
          bioGroup.appendChild(bioLabel);
          bioGroup.appendChild(bioInputRow);
          editSection.appendChild(bioGroup);

          // LinkedIn URL field
          const linkedinGroup = document.createElement("div");
          linkedinGroup.className = "form-group";
          const linkedinLabel = document.createElement("label");
          linkedinLabel.className = "form-label";
          linkedinLabel.textContent = "üîó LinkedIn URL";
          const linkedinInputRow = document.createElement("div");
          linkedinInputRow.style.display = "flex";
          linkedinInputRow.style.alignItems = "center";
          const linkedinInput = document.createElement("input");
          linkedinInput.type = "url";
          linkedinInput.className = "form-input";
          linkedinInput.id = `exec_${idx}_linkedin`;
          linkedinInput.value = execLinkedIn;
          linkedinInput.placeholder = "https://linkedin.com/in/...";
          linkedinInput.style.flex = "1";
          linkedinInputRow.appendChild(linkedinInput);
          linkedinInputRow.appendChild(createIndividualFieldSaveBtn("LinkedIn URL", () => linkedinInput.value.trim(), "linkedin_url"));
          linkedinGroup.appendChild(linkedinLabel);
          linkedinGroup.appendChild(linkedinInputRow);
          editSection.appendChild(linkedinGroup);

          // Current Employee URL field (company webpage)
          const employeeUrlGroup = document.createElement("div");
          employeeUrlGroup.className = "form-group";
          const employeeUrlLabel = document.createElement("label");
          employeeUrlLabel.className = "form-label";
          employeeUrlLabel.textContent = "üåê Company Profile URL";
          const employeeUrlInputRow = document.createElement("div");
          employeeUrlInputRow.style.display = "flex";
          employeeUrlInputRow.style.alignItems = "center";
          const employeeUrlInput = document.createElement("input");
          employeeUrlInput.type = "url";
          employeeUrlInput.className = "form-input";
          employeeUrlInput.id = `exec_${idx}_employee_url`;
          employeeUrlInput.value = execEmployeeUrl;
          employeeUrlInput.placeholder = "https://company.com/team/name";
          employeeUrlInput.style.flex = "1";
          employeeUrlInputRow.appendChild(employeeUrlInput);
          employeeUrlInputRow.appendChild(createIndividualFieldSaveBtn("Company Profile URL", () => employeeUrlInput.value.trim(), "current_employee_url"));
          employeeUrlGroup.appendChild(employeeUrlLabel);
          employeeUrlGroup.appendChild(employeeUrlInputRow);
          editSection.appendChild(employeeUrlGroup);

          card.appendChild(editSection);

          // Button row: Edit + Add to DB
          const btnRow = document.createElement("div");
          btnRow.style.marginTop = "12px";
          btnRow.style.paddingTop = "12px";
          btnRow.style.borderTop = "1px solid rgba(255,255,255,0.1)";
          btnRow.style.display = "flex";
          btnRow.style.gap = "8px";

          // Edit toggle button
          const editBtn = document.createElement("button");
          editBtn.className = "counterparty-expand-btn";
          editBtn.style.flex = "1";
          editBtn.textContent = "‚úèÔ∏è Edit";
          editBtn.onclick = () => {
            const isExpanded = editSection.classList.contains("expanded");
            editSection.classList.toggle("expanded");
            editBtn.textContent = isExpanded ? "‚úèÔ∏è Edit" : "‚úñÔ∏è Close";
          };
          btnRow.appendChild(editBtn);

          // Add to DB button
          const addBtn = document.createElement("button");
          addBtn.textContent = "‚ûï Add";
          addBtn.style.flex = "1";
          addBtn.style.padding = "8px 12px";
          addBtn.style.fontSize = "11px";
          addBtn.style.borderRadius = "6px";
          addBtn.style.border = "1px solid rgba(99, 102, 241, 0.4)";
          addBtn.style.background = "rgba(99, 102, 241, 0.15)";
          addBtn.style.color = "#a5b4fc";
          addBtn.style.cursor = "pointer";
          addBtn.style.transition = "all 0.15s ease";
          addBtn.onmouseover = () => {
            addBtn.style.background = "rgba(99, 102, 241, 0.25)";
            addBtn.style.borderColor = "rgba(99, 102, 241, 0.6)";
          };
          addBtn.onmouseout = () => {
            addBtn.style.background = "rgba(99, 102, 241, 0.15)";
            addBtn.style.borderColor = "rgba(99, 102, 241, 0.4)";
          };
          addBtn.onclick = async () => {
            await addIndividualToDb(execName, execPosition, execLinkedIn, addBtn, {
              job_title: execPosition,
              status: execStatus,
              location_text: execLocation,
              bio: execBio,
              current_employee_url: execEmployeeUrl,
            });
          };
          btnRow.appendChild(addBtn);

          card.appendChild(btnRow);

          grid.appendChild(card);
        });

        topManagementEl.appendChild(grid);
      }

      function renderDBManagement(management) {
        dbManagementEl.innerHTML = "";
        if (!management || !management.length) {
          dbManagementEl.innerHTML =
            '<div class="empty-state">No key people in database.</div>';
          dbMgmtMetaEl.textContent = "0 people";
          return;
        }
        dbMgmtMetaEl.textContent = `${management.length} ${
          management.length === 1 ? "person" : "people"
        }`;

        const grid = document.createElement("div");
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(240px, 1fr))";
        grid.style.gap = "12px";

        management.forEach((person) => {
          const card = document.createElement("div");
          card.className = "event-card";
          card.style.padding = "12px";

          const name = person.Individual_text || person.name || "Unknown";
          const jobTitles = person.job_titles_id || [];
          const title = jobTitles.length > 0 
            ? jobTitles.map(j => j.job_title).join(", ")
            : person.title || person.position || "";
          const status = person.Status || "";
          const linkedinUrl = person.linkedin_url || "";
          const employeeUrl = person.current_employee_url || "";

          // Name
          const nameEl = document.createElement("div");
          nameEl.style.fontWeight = "600";
          nameEl.style.fontSize = "13px";
          nameEl.style.color = "#e5e7eb";
          nameEl.style.marginBottom = "4px";
          nameEl.textContent = name;
          card.appendChild(nameEl);

          // Title/Position
          if (title) {
            const titleEl = document.createElement("div");
            titleEl.style.fontSize = "11px";
            titleEl.style.color = "#9ca3af";
            titleEl.style.marginBottom = "4px";
            titleEl.textContent = title;
            card.appendChild(titleEl);
          }

          // Status badge
          if (status) {
            const statusBadge = document.createElement("span");
            statusBadge.textContent = status;
            statusBadge.style.fontSize = "9px";
            statusBadge.style.padding = "2px 6px";
            statusBadge.style.borderRadius = "999px";
            if (status.toLowerCase() === "current") {
              statusBadge.style.background = "rgba(16, 185, 129, 0.15)";
              statusBadge.style.color = "#6ee7b7";
              statusBadge.style.border = "1px solid rgba(16, 185, 129, 0.3)";
            } else {
              statusBadge.style.background = "rgba(156, 163, 175, 0.15)";
              statusBadge.style.color = "#9ca3af";
              statusBadge.style.border = "1px solid rgba(156, 163, 175, 0.3)";
            }
            card.appendChild(statusBadge);
          }

          // LinkedIn
          if (linkedinUrl) {
            const linkedinLink = document.createElement("a");
            linkedinLink.href = linkedinUrl;
            linkedinLink.target = "_blank";
            linkedinLink.className = "source-link";
            linkedinLink.style.display = "block";
            linkedinLink.style.marginTop = "6px";
            linkedinLink.style.fontSize = "10px";
            linkedinLink.textContent = "üîó LinkedIn";
            card.appendChild(linkedinLink);
          }

          // Company Profile URL
          if (employeeUrl) {
            const employeeLink = document.createElement("a");
            employeeLink.href = employeeUrl;
            employeeLink.target = "_blank";
            employeeLink.className = "source-link";
            employeeLink.style.display = "block";
            employeeLink.style.marginTop = "6px";
            employeeLink.style.fontSize = "10px";
            employeeLink.textContent = "üåê Company Profile";
            card.appendChild(employeeLink);
          }

          grid.appendChild(card);
        });

        dbManagementEl.appendChild(grid);
      }

      function renderAIEvents(events, missing) {
        aiEventsEl.innerHTML = "";
        if (!events || !events.length) {
          aiEventsEl.innerHTML =
            '<div class="empty-state">No AI events found.</div>';
          aiMetaEl.textContent = "0 events";
          return;
        }

        aiMetaEl.textContent = `${events.length} event${
          events.length > 1 ? "s" : ""
        } (${missing.length} missing in DB)`;

        events.forEach((ev, idx) => {
          const container = document.createElement("div");
          container.className = "event-card";

          const isMissing = missing.some((m) => {
            return (
              (m["Event (short)"] || m.event_short || "") ===
              (ev["Event (short)"] || ev.event_short || "")
            );
          });

          const shortTitle = ev["Event (short)"] || ev.event_short || "Untitled";
          const annDate =
            ev["Announcement Date"] || ev.announcement_date || "Unknown";
          const closed =
            ev["Closed Date"] || ev.closed_date || "" || "Not available";
          const type =
            ev["Deal Type"] ||
            ev.deal_type ||
            ev["Event type"] ||
            ev.event_type ||
            "Unknown";
          const status = ev["Deal Status"] || ev.deal_status || "";
          const source = ev["Source URL"] || ev.source_url || "";

          const titleRow = document.createElement("div");
          titleRow.className = "event-title-row";

          // LEFT: editable fields
          const left = document.createElement("div");
          left.style.flex = "1";

          // Title
          const titleLabel = document.createElement("div");
          titleLabel.className = "event-title";
          const matchLabel = isMissing ? "MISSING in DB" : "Matched in DB";
          titleLabel.innerHTML = `${
            isMissing ? "‚ö†Ô∏è" : "‚úÖ"
          } AI Event #${idx + 1} <span style="font-size:11px;color:${
            isMissing ? "#facc15" : "#6ee7b7"
          };">(${matchLabel})</span>`;

          // Helper to create inline save button for a field
          function createFieldSaveBtn(fieldName, getValue, updateKey) {
            const btn = document.createElement("button");
            btn.textContent = "üíæ";
            btn.title = `Save ${fieldName}`;
            btn.style.padding = "8px 12px";
            btn.style.fontSize = "12px";
            btn.style.borderRadius = "8px";
            btn.style.border = "1px solid rgba(16, 185, 129, 0.4)";
            btn.style.background = "rgba(16, 185, 129, 0.15)";
            btn.style.color = "#6ee7b7";
            btn.style.cursor = "pointer";
            btn.style.transition = "all 0.15s ease";
            btn.style.marginLeft = "8px";
            btn.style.flexShrink = "0";
            
            btn.onmouseover = () => {
              btn.style.background = "rgba(16, 185, 129, 0.25)";
              btn.style.borderColor = "rgba(16, 185, 129, 0.6)";
            };
            btn.onmouseout = () => {
              btn.style.background = "rgba(16, 185, 129, 0.15)";
              btn.style.borderColor = "rgba(16, 185, 129, 0.4)";
            };
            
            btn.onclick = async () => {
              btn.disabled = true;
              btn.textContent = "üîç";
              
              const eventId = await queryEventId(shortTitle);
              if (!eventId) {
                btn.textContent = "‚ùå";
                log(`‚ùå Event not found in DB: ${shortTitle}`, "err");
                setTimeout(() => {
                  btn.disabled = false;
                  btn.textContent = "üíæ";
                }, 2000);
                return;
              }
              
              const value = getValue();
              const updates = { [updateKey]: value };
              
              await editCorporateEventInDb(eventId, updates, btn);
              btn.textContent = "üíæ";
            };
            
            return btn;
          }

          // Event Title input (short description)
          const titleGroup = document.createElement("div");
          titleGroup.className = "form-group";
          const titleInputLabel = document.createElement("label");
          titleInputLabel.className = "form-label";
          titleInputLabel.textContent = "Event Title (Short Description)";
          
          const titleInputRow = document.createElement("div");
          titleInputRow.style.display = "flex";
          titleInputRow.style.alignItems = "center";
          
          const titleInput = document.createElement("input");
          titleInput.type = "text";
          titleInput.className = "form-input";
          titleInput.id = `ev_${idx}_title`;
          titleInput.value = shortTitle;
          titleInput.placeholder = "e.g., Company A acquired Company B";
          titleInput.style.flex = "1";
          
          titleInputRow.appendChild(titleInput);
          
          // Add save button for title (only for matched events)
          if (!isMissing) {
            const titleSaveBtn = createFieldSaveBtn("title", () => titleInput.value.trim(), "description");
            titleInputRow.appendChild(titleSaveBtn);
          }
          
          titleGroup.appendChild(titleInputLabel);
          titleGroup.appendChild(titleInputRow);

          // Dates row
          const datesRow = document.createElement("div");
          datesRow.className = "form-row";

          // Helper to convert various date formats to YYYY-MM-DD for date input
          function parseToDateValue(dateStr) {
            if (!dateStr || dateStr === "Unknown" || dateStr === "Not available") return "";
            // Try to parse the date
            const d = new Date(dateStr);
            if (!isNaN(d.getTime())) {
              return d.toISOString().split('T')[0];
            }
            // If already in YYYY-MM-DD format
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            return "";
          }

          // Announcement Date
          const annGroup = document.createElement("div");
          annGroup.className = "form-group";
          const annLabel = document.createElement("label");
          annLabel.className = "form-label";
          annLabel.textContent = "üì¢ Announcement Date";
          
          const annInputRow = document.createElement("div");
          annInputRow.style.display = "flex";
          annInputRow.style.alignItems = "center";
          
          const annInput = document.createElement("input");
          annInput.type = "date";
          annInput.className = "form-input";
          annInput.id = `ev_${idx}_ann`;
          annInput.value = parseToDateValue(annDate);
          annInput.style.flex = "1";
          annInputRow.appendChild(annInput);
          
          if (!isMissing) {
            const annSaveBtn = createFieldSaveBtn("announcement date", () => annInput.value, "announcement_date");
            annInputRow.appendChild(annSaveBtn);
          }
          
          annGroup.appendChild(annLabel);
          annGroup.appendChild(annInputRow);

          // Closed Date
          const closedGroup = document.createElement("div");
          closedGroup.className = "form-group";
          const closedLabel = document.createElement("label");
          closedLabel.className = "form-label";
          closedLabel.textContent = "‚úÖ Closed Date";
          
          const closedInputRow = document.createElement("div");
          closedInputRow.style.display = "flex";
          closedInputRow.style.alignItems = "center";
          
          const closedInput = document.createElement("input");
          closedInput.type = "date";
          closedInput.className = "form-input";
          closedInput.id = `ev_${idx}_closed`;
          closedInput.value = parseToDateValue(closed);
          closedInput.style.flex = "1";
          closedInputRow.appendChild(closedInput);
          
          if (!isMissing) {
            const closedSaveBtn = createFieldSaveBtn("closed date", () => closedInput.value, "closed_date");
            closedInputRow.appendChild(closedSaveBtn);
          }
          
          closedGroup.appendChild(closedLabel);
          closedGroup.appendChild(closedInputRow);

          datesRow.appendChild(annGroup);
          datesRow.appendChild(closedGroup);

          // Type / status row
          const typeRow = document.createElement("div");
          typeRow.className = "form-row";

          // Deal Type
          const typeGroup = document.createElement("div");
          typeGroup.className = "form-group";
          const typeLabel = document.createElement("label");
          typeLabel.className = "form-label";
          typeLabel.textContent = "üìã Deal Type";
          
          const typeSelectRow = document.createElement("div");
          typeSelectRow.style.display = "flex";
          typeSelectRow.style.alignItems = "center";
          
          const typeSelect = document.createElement("select");
          typeSelect.className = "form-select";
          typeSelect.id = `ev_${idx}_type`;
          typeSelect.style.flex = "1";
          DEAL_TYPES.forEach((opt) => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt || "Select deal type...";
            if (opt && opt.toLowerCase() === type.toLowerCase()) {
              o.selected = true;
            }
            typeSelect.appendChild(o);
          });
          typeSelectRow.appendChild(typeSelect);
          
          if (!isMissing) {
            const typeSaveBtn = createFieldSaveBtn("deal type", () => typeSelect.value, "deal_type");
            typeSelectRow.appendChild(typeSaveBtn);
          }
          
          typeGroup.appendChild(typeLabel);
          typeGroup.appendChild(typeSelectRow);

          // Deal Status
          const statusGroup = document.createElement("div");
          statusGroup.className = "form-group";
          const statusLabel = document.createElement("label");
          statusLabel.className = "form-label";
          statusLabel.textContent = "üìä Deal Status";
          
          const statusSelectRow = document.createElement("div");
          statusSelectRow.style.display = "flex";
          statusSelectRow.style.alignItems = "center";
          
          const statusSelect = document.createElement("select");
          statusSelect.className = "form-select";
          statusSelect.id = `ev_${idx}_status`;
          statusSelect.style.flex = "1";
          DEAL_STATUSES.forEach((opt) => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt || "Select status...";
            if (opt && opt.toLowerCase() === status.toLowerCase()) {
              o.selected = true;
            }
            statusSelect.appendChild(o);
          });
          statusSelectRow.appendChild(statusSelect);
          
          if (!isMissing) {
            const statusSaveBtn = createFieldSaveBtn("deal status", () => statusSelect.value, "deal_status");
            statusSelectRow.appendChild(statusSaveBtn);
          }
          
          statusGroup.appendChild(statusLabel);
          statusGroup.appendChild(statusSelectRow);

          typeRow.appendChild(typeGroup);
          typeRow.appendChild(statusGroup);

          // Source URL
          const sourceGroup = document.createElement("div");
          sourceGroup.className = "form-group";
          const sourceLabel = document.createElement("label");
          sourceLabel.className = "form-label";
          sourceLabel.textContent = "üîó Source URL (Press Release / Announcement)";
          const sourceInput = document.createElement("input");
          sourceInput.type = "url";
          sourceInput.className = "form-input";
          sourceInput.placeholder = "https://company.com/press/announcement...";
          sourceInput.id = `ev_${idx}_source`;
          sourceInput.value = source;
          sourceGroup.appendChild(sourceLabel);
          sourceGroup.appendChild(sourceInput);

          left.appendChild(titleLabel);
          left.appendChild(titleGroup);
          left.appendChild(datesRow);
          left.appendChild(typeRow);
          left.appendChild(sourceGroup);

          // RIGHT: Button container
          const btnContainer = document.createElement("div");
          btnContainer.style.display = "flex";
          btnContainer.style.flexDirection = "column";
          btnContainer.style.gap = "8px";
          btnContainer.style.alignItems = "flex-end";
          btnContainer.style.minWidth = "120px";

          if (isMissing) {
            // Add to DB button (for missing events)
            const addBtn = document.createElement("button");
            addBtn.className = "primary";
            addBtn.style.padding = "10px 16px";
            addBtn.style.fontSize = "12px";
            addBtn.innerHTML = "üöÄ Add to DB";
            addBtn.addEventListener("click", () => {
              addEventToDb(ev, idx, addBtn);
            });
            btnContainer.appendChild(addBtn);
          } else {
            // Save All button (for matched events - exists in DB)
            const saveAllBtn = document.createElement("button");
            saveAllBtn.className = "save-btn";
            saveAllBtn.style.padding = "10px 16px";
            saveAllBtn.style.fontSize = "12px";
            saveAllBtn.innerHTML = "üíæ Save All";
            saveAllBtn.title = "Save all changes to this event";
            
            saveAllBtn.addEventListener("click", async () => {
              saveAllBtn.disabled = true;
              saveAllBtn.innerHTML = "üîç Finding...";
              
              // Query for the event ID using the original title
              const eventId = await queryEventId(shortTitle);
              
              if (!eventId) {
                saveAllBtn.innerHTML = "‚ùå Not found";
                log(`‚ùå Could not find event ID for: ${shortTitle}`, "err");
                setTimeout(() => {
                  saveAllBtn.disabled = false;
                  saveAllBtn.innerHTML = "üíæ Save All";
                }, 3000);
                return;
              }
              
              saveAllBtn.innerHTML = "‚è≥ Saving...";
              
              // Build updates from form fields
              const updates = {};
              
              const titleVal = document.getElementById(`ev_${idx}_title`)?.value?.trim();
              if (titleVal && titleVal !== shortTitle) updates.description = titleVal;
              
              const annVal = document.getElementById(`ev_${idx}_ann`)?.value;
              if (annVal) updates.announcement_date = annVal;
              
              const closedVal = document.getElementById(`ev_${idx}_closed`)?.value;
              if (closedVal) updates.closed_date = closedVal;
              
              const typeVal = document.getElementById(`ev_${idx}_type`)?.value;
              if (typeVal) updates.deal_type = typeVal;
              
              const statusVal = document.getElementById(`ev_${idx}_status`)?.value;
              if (statusVal) updates.deal_status = statusVal;
              
              // Include long description if available
              const longDescVal = ev.Description || ev.description || "";
              if (longDescVal) updates.long_description = longDescVal;
              
              if (Object.keys(updates).length === 0) {
                log("No changes to save", "warn");
                saveAllBtn.disabled = false;
                saveAllBtn.innerHTML = "üíæ Save All";
                return;
              }
              
              await editCorporateEventInDb(eventId, updates, saveAllBtn);
              saveAllBtn.innerHTML = "üíæ Save All";
            });
            
            btnContainer.appendChild(saveAllBtn);
            
            // Store event ID reference for individual field saves
            container.dataset.eventTitle = shortTitle;
          }

          titleRow.appendChild(left);
          titleRow.appendChild(btnContainer);

          container.appendChild(titleRow);

          // Show original, non-editable summary line under fields
          const meta = document.createElement("div");
          meta.className = "event-meta";
          meta.style.marginTop = "4px";
          meta.innerHTML = `
            <span>üì¢ ${annDate}</span>
            ${
              closed && closed !== "Not available"
                ? `<span>‚Ä¢ ‚úÖ ${closed}</span>`
                : ""
            }
            <span>‚Ä¢ ${type}</span>
            ${status ? `<span>‚Ä¢ ${status}</span>` : ""}
          `;
          container.appendChild(meta);

          // Long Description (AI-generated detailed description) - editable for matched events
          const longDesc = ev.Description || ev.description || ev.long_description || "";
          
          const descBlock = document.createElement("div");
          descBlock.style.marginTop = "12px";
          descBlock.style.padding = "12px";
          descBlock.style.background = "rgba(99, 102, 241, 0.08)";
          descBlock.style.borderRadius = "10px";
          descBlock.style.border = "1px solid rgba(99, 102, 241, 0.2)";
          
          const descHeader = document.createElement("div");
          descHeader.style.display = "flex";
          descHeader.style.justifyContent = "space-between";
          descHeader.style.alignItems = "center";
          descHeader.style.marginBottom = "8px";
          
          const descLabel = document.createElement("label");
          descLabel.className = "form-label";
          descLabel.style.color = "#a5b4fc";
          descLabel.style.marginBottom = "0";
          descLabel.textContent = "üìù Long Description";
          descHeader.appendChild(descLabel);
          
          // Save button for long description (only for matched events)
          if (!isMissing) {
            const longDescSaveBtn = createFieldSaveBtn("long description", () => {
              const textarea = document.getElementById(`ev_${idx}_longdesc`);
              return textarea ? textarea.value.trim() : longDesc;
            }, "long_description");
            descHeader.appendChild(longDescSaveBtn);
          }
          
          descBlock.appendChild(descHeader);
          
          if (!isMissing) {
            // Editable textarea for matched events
            const descTextarea = document.createElement("textarea");
            descTextarea.className = "form-input";
            descTextarea.id = `ev_${idx}_longdesc`;
            descTextarea.value = longDesc;
            descTextarea.placeholder = "Detailed description of the corporate event...";
            descTextarea.style.minHeight = "100px";
            descTextarea.style.resize = "vertical";
            descTextarea.style.lineHeight = "1.5";
            descBlock.appendChild(descTextarea);
          } else {
            // Read-only display for missing events
            const descText = document.createElement("div");
            descText.style.fontSize = "12px";
            descText.style.color = "#e5e7eb";
            descText.style.lineHeight = "1.5";
            descText.textContent = longDesc || "No description available";
            descBlock.appendChild(descText);
          }
          
          container.appendChild(descBlock);

          // Counterparties section with editable cards
          const cps = ev.counterparties || [];
          if (cps.length) {
            const cpSection = document.createElement("div");
            cpSection.style.marginTop = "16px";

            const cpHeader = document.createElement("div");
            cpHeader.style.display = "flex";
            cpHeader.style.alignItems = "center";
            cpHeader.style.justifyContent = "space-between";
            cpHeader.style.marginBottom = "12px";
            
            const cpTitle = document.createElement("div");
            cpTitle.style.fontSize = "13px";
            cpTitle.style.fontWeight = "600";
            cpTitle.style.color = "#e5e7eb";
            cpTitle.textContent = `üè¢ Counterparties (${cps.length})`;
            cpHeader.appendChild(cpTitle);
            cpSection.appendChild(cpHeader);

            cps.forEach((cp, cpIdx) => {
              const cpId = cp.id || cp.counterparty_id || null;
              const name = cp.company_name || "Unknown";
              const role = cp.role || cp.role_description || cp.type || "Counterparty";
              const typeId = cp.type_id || 0;
              const link = cp.company_linkedin_url || "";
              const press = cp.press_release_url || "";
              const indiv = cp.individuals || [];

              const cpCard = document.createElement("div");
              cpCard.className = "counterparty-card";
              // Store counterparty ID on the card for dynamic updates
              cpCard.dataset.counterpartyId = cpId || "";

              // Header row with name and expand button
              const header = document.createElement("div");
              header.className = "counterparty-header";
              
              const nameSpan = document.createElement("span");
              nameSpan.className = "counterparty-name";
              nameSpan.textContent = name;
              
              const roleSpan = document.createElement("span");
              roleSpan.className = "counterparty-role";
              roleSpan.textContent = role;
              
              const headerLeft = document.createElement("div");
              headerLeft.style.display = "flex";
              headerLeft.style.alignItems = "center";
              headerLeft.style.gap = "10px";
              headerLeft.appendChild(nameSpan);
              headerLeft.appendChild(roleSpan);
              
              const expandBtn = document.createElement("button");
              expandBtn.className = "counterparty-expand-btn";
              expandBtn.textContent = "‚úèÔ∏è Edit";
              
              header.appendChild(headerLeft);
              
              // Button group for header
              const headerBtns = document.createElement("div");
              headerBtns.style.display = "flex";
              headerBtns.style.gap = "6px";
              headerBtns.style.alignItems = "center";
              
              // Add/Create counterparty button (visible on header)
              if (!cpId) {
                const addCpBtn = document.createElement("button");
                addCpBtn.textContent = "üöÄ Add to DB";
                addCpBtn.title = "Add this counterparty to the database";
                addCpBtn.style.padding = "4px 10px";
                addCpBtn.style.fontSize = "10px";
                addCpBtn.style.borderRadius = "6px";
                addCpBtn.style.border = "1px solid rgba(99, 102, 241, 0.5)";
                addCpBtn.style.background = "linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)";
                addCpBtn.style.color = "white";
                addCpBtn.style.cursor = "pointer";
                addCpBtn.style.transition = "all 0.15s ease";
                addCpBtn.style.fontWeight = "600";
                addCpBtn.onmouseover = () => {
                  addCpBtn.style.transform = "translateY(-1px)";
                  addCpBtn.style.boxShadow = "0 2px 8px rgba(99, 102, 241, 0.3)";
                };
                addCpBtn.onmouseout = () => {
                  addCpBtn.style.transform = "";
                  addCpBtn.style.boxShadow = "";
                };
                addCpBtn.onclick = async () => {
                  addCpBtn.disabled = true;
                  addCpBtn.textContent = "üîç Finding...";
                  
                  const eventId = await queryEventId(shortTitle);
                  if (!eventId) {
                    addCpBtn.textContent = "‚ùå Event not in DB";
                    log(`‚ùå Add event to DB first`, "err");
                    setTimeout(() => {
                      addCpBtn.disabled = false;
                      addCpBtn.textContent = "üöÄ Add to DB";
                    }, 3000);
                    return;
                  }
                  
                  addCpBtn.textContent = "‚è≥ Creating...";
                  const result = await createCounterpartyInDb(eventId, name, typeId || 17, addCpBtn, press);
                  if (result && (result.id || result.counterparty_id)) {
                    const newCpId = result.id || result.counterparty_id;
                    // Update the card's dataset with the new counterparty ID
                    cpCard.dataset.counterpartyId = newCpId;
                    log(`‚úÖ Updated card with counterparty ID: ${newCpId}`, "ok");
                    addCpBtn.textContent = "‚úÖ Added!";
                    
                    // Update all Assign buttons in this counterparty card to reflect the new ID
                    cpCard.querySelectorAll('[data-assign-btn="true"]').forEach(btn => {
                      btn.title = "Assign existing individual to this counterparty";
                      btn.style.background = "rgba(16, 185, 129, 0.15)";
                      btn.style.color = "#6ee7b7";
                    });
                  }
                };
                headerBtns.appendChild(addCpBtn);
              }
              
              headerBtns.appendChild(expandBtn);
              header.appendChild(headerBtns);
              cpCard.appendChild(header);

              // Quick links row
              const quickLinks = document.createElement("div");
              quickLinks.style.fontSize = "11px";
              quickLinks.style.marginBottom = "8px";
              if (press) {
                const pressLink = document.createElement("a");
                pressLink.href = press;
                pressLink.target = "_blank";
                pressLink.className = "source-link";
                pressLink.textContent = "üìÑ Announcement";
                pressLink.style.marginRight = "12px";
                quickLinks.appendChild(pressLink);
              }
              if (link) {
                const liLink = document.createElement("a");
                liLink.href = link;
                liLink.target = "_blank";
                liLink.className = "source-link";
                liLink.textContent = "üîó LinkedIn";
                quickLinks.appendChild(liLink);
              }
              if (quickLinks.childNodes.length) {
                cpCard.appendChild(quickLinks);
              }

              // Expandable edit section
              const details = document.createElement("div");
              details.className = "counterparty-details";
              details.id = `cp_${idx}_${cpIdx}_details`;

              // Company Name input
              const nameGroup = document.createElement("div");
              nameGroup.className = "form-group";
              const nameLabel = document.createElement("label");
              nameLabel.className = "form-label";
              nameLabel.textContent = "Company Name";
              const nameInput = document.createElement("input");
              nameInput.type = "text";
              nameInput.className = "form-input";
              nameInput.value = name;
              nameInput.id = `cp_${idx}_${cpIdx}_name`;
              nameGroup.appendChild(nameLabel);
              nameGroup.appendChild(nameInput);
              details.appendChild(nameGroup);

              // Type selector row
              const typeRow = document.createElement("div");
              typeRow.className = "form-row";
              
              const typeGroup = document.createElement("div");
              typeGroup.className = "form-group";
              const typeLabel = document.createElement("label");
              typeLabel.className = "form-label";
              typeLabel.textContent = "Counterparty Type";
              const typeSelect = document.createElement("select");
              typeSelect.className = "form-select";
              typeSelect.id = `cp_${idx}_${cpIdx}_type`;
              COUNTERPARTY_TYPES.forEach(ct => {
                const opt = document.createElement("option");
                opt.value = ct.id;
                opt.textContent = ct.type;
                if (ct.id === typeId || ct.type.toLowerCase() === role.toLowerCase()) {
                  opt.selected = true;
                }
                typeSelect.appendChild(opt);
              });
              typeGroup.appendChild(typeLabel);
              typeGroup.appendChild(typeSelect);
              typeRow.appendChild(typeGroup);
              details.appendChild(typeRow);

              // Press Release URL input
              const pressGroup = document.createElement("div");
              pressGroup.className = "form-group";
              const pressLabel = document.createElement("label");
              pressLabel.className = "form-label";
              pressLabel.textContent = "Press Release / Announcement URL";
              const pressInput = document.createElement("input");
              pressInput.type = "url";
              pressInput.className = "form-input";
              pressInput.value = press;
              pressInput.placeholder = "https://company.com/press/announcement...";
              pressInput.id = `cp_${idx}_${cpIdx}_press`;
              pressGroup.appendChild(pressLabel);
              pressGroup.appendChild(pressInput);
              details.appendChild(pressGroup);

              // Save/Create buttons for counterparty
              const actionRow = document.createElement("div");
              actionRow.style.marginTop = "12px";
              actionRow.style.display = "flex";
              actionRow.style.gap = "8px";
              actionRow.style.justifyContent = "flex-end";
              
              if (cpId) {
                // Save button (counterparty exists in DB)
                const saveBtn = document.createElement("button");
                saveBtn.className = "save-btn";
                saveBtn.textContent = "üíæ Save Changes";
                saveBtn.onclick = async () => {
                  const updates = {};
                  const newName = document.getElementById(`cp_${idx}_${cpIdx}_name`).value.trim();
                  const newType = parseInt(document.getElementById(`cp_${idx}_${cpIdx}_type`).value);
                  const newPress = document.getElementById(`cp_${idx}_${cpIdx}_press`).value.trim();
                  
                  if (newName && newName !== name) updates.company_name = newName;
                  if (newType) updates.type_id = newType;
                  if (newPress !== press) updates.press_release_url = newPress;
                  
                  if (Object.keys(updates).length === 0) {
                    log("No changes to save", "warn");
                    return;
                  }
                  
                  await editCounterpartyInDb(cpId, updates, saveBtn);
                };
                actionRow.appendChild(saveBtn);
              } else {
                // Create button (counterparty not yet in DB)
                const createBtn = document.createElement("button");
                createBtn.style.padding = "8px 16px";
                createBtn.style.fontSize = "12px";
                createBtn.style.fontWeight = "600";
                createBtn.style.borderRadius = "8px";
                createBtn.style.border = "1px solid rgba(99, 102, 241, 0.5)";
                createBtn.style.background = "linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)";
                createBtn.style.color = "white";
                createBtn.style.cursor = "pointer";
                createBtn.style.transition = "all 0.15s ease";
                createBtn.textContent = "üöÄ Create Counterparty";
                createBtn.title = "Create this counterparty in the database";
                
                createBtn.onmouseover = () => {
                  createBtn.style.transform = "translateY(-1px)";
                  createBtn.style.boxShadow = "0 4px 12px rgba(99, 102, 241, 0.3)";
                };
                createBtn.onmouseout = () => {
                  createBtn.style.transform = "";
                  createBtn.style.boxShadow = "";
                };
                
                createBtn.onclick = async () => {
                  // First, get the event ID by querying with the event short title
                  createBtn.disabled = true;
                  createBtn.textContent = "üîç Finding event...";
                  
                  const eventId = await queryEventId(shortTitle);
                  
                  if (!eventId) {
                    createBtn.textContent = "‚ùå Event not in DB";
                    log(`‚ùå Must add event to DB first before creating counterparty`, "err");
                    setTimeout(() => {
                      createBtn.disabled = false;
                      createBtn.textContent = "üöÄ Create Counterparty";
                    }, 3000);
                    return;
                  }
                  
                  // Get values from form
                  const cpName = document.getElementById(`cp_${idx}_${cpIdx}_name`)?.value?.trim() || name;
                  const cpTypeId = parseInt(document.getElementById(`cp_${idx}_${cpIdx}_type`)?.value) || typeId || 17;
                  const cpPressUrl = document.getElementById(`cp_${idx}_${cpIdx}_press`)?.value?.trim() || press || "";
                  
                  createBtn.textContent = "‚è≥ Creating...";
                  
                  const result = await createCounterpartyInDb(eventId, cpName, cpTypeId, createBtn, cpPressUrl);
                  
                  if (result && (result.id || result.counterparty_id)) {
                    const newCpId = result.id || result.counterparty_id;
                    // Update the card's dataset with the new counterparty ID
                    cpCard.dataset.counterpartyId = newCpId;
                    log(`‚úÖ Updated card with counterparty ID: ${newCpId}`, "ok");
                    createBtn.textContent = "‚úÖ Created!";
                    
                    // Update all Assign buttons in this counterparty card to reflect the new ID
                    cpCard.querySelectorAll('[data-assign-btn="true"]').forEach(btn => {
                      btn.title = "Assign existing individual to this counterparty";
                      btn.style.background = "rgba(16, 185, 129, 0.15)";
                      btn.style.color = "#6ee7b7";
                    });
                  }
                };
                
                actionRow.appendChild(createBtn);
                
                // Info note
                const noteEl = document.createElement("div");
                noteEl.style.fontSize = "10px";
                noteEl.style.color = "#9ca3af";
                noteEl.style.marginTop = "8px";
                noteEl.style.fontStyle = "italic";
                noteEl.textContent = "‚ÑπÔ∏è Event must exist in DB first";
                details.appendChild(noteEl);
              }
              
              details.appendChild(actionRow);

              cpCard.appendChild(details);

              // Toggle expand
              expandBtn.onclick = () => {
                const isExpanded = details.classList.contains("expanded");
                details.classList.toggle("expanded");
                expandBtn.textContent = isExpanded ? "‚úèÔ∏è Edit" : "‚úñÔ∏è Close";
              };

              // Key people section (inside counterparty card)
              if (indiv.length) {
                const pplSection = document.createElement("div");
                pplSection.style.marginTop = "10px";
                pplSection.style.paddingTop = "10px";
                pplSection.style.borderTop = "1px solid rgba(55, 65, 81, 0.4)";
                
                const pplLabel = document.createElement("div");
                pplLabel.style.color = "#9ca3af";
                pplLabel.style.fontSize = "11px";
                pplLabel.style.marginBottom = "8px";
                pplLabel.style.fontWeight = "500";
                pplLabel.textContent = `üë• Key People (${indiv.length})`;
                pplSection.appendChild(pplLabel);
                
                indiv.slice(0, 6).forEach((person) => {
                  const personName = person.name || "Unknown";
                  const personTitle = person.title || person.job_title || "";
                  const personLinkedIn = person.linkedin_url || "";
                  
                  const personRow = document.createElement("div");
                  personRow.style.display = "flex";
                  personRow.style.alignItems = "center";
                  personRow.style.justifyContent = "space-between";
                  personRow.style.padding = "8px 10px";
                  personRow.style.marginBottom = "6px";
                  personRow.style.background = "rgba(31, 41, 55, 0.3)";
                  personRow.style.borderRadius = "8px";
                  
                  const personInfo = document.createElement("div");
                  personInfo.style.flex = "1";
                  let personHtml = `<span style="color:#e5e7eb;font-size:13px;font-weight:500;">üë§ ${personName}</span>`;
                  if (personTitle) {
                    personHtml += `<span style="color:#9ca3af;font-size:11px;margin-left:8px;">‚Äì ${personTitle}</span>`;
                  }
                  if (personLinkedIn) {
                    personHtml += ` <a href="${personLinkedIn}" target="_blank" class="source-link" style="font-size:10px;">[LinkedIn]</a>`;
                  }
                  personInfo.innerHTML = personHtml;
                  personRow.appendChild(personInfo);
                  
                  // Button container
                  const btnGroup = document.createElement("div");
                  btnGroup.style.display = "flex";
                  btnGroup.style.gap = "6px";
                  
                  // Add to DB button (creates new individual)
                  const addBtn = document.createElement("button");
                  addBtn.textContent = "‚ûï Create";
                  addBtn.title = "Create new individual in database";
                  addBtn.style.padding = "4px 10px";
                  addBtn.style.fontSize = "11px";
                  addBtn.style.borderRadius = "6px";
                  addBtn.style.border = "1px solid rgba(99, 102, 241, 0.4)";
                  addBtn.style.background = "rgba(99, 102, 241, 0.15)";
                  addBtn.style.color = "#a5b4fc";
                  addBtn.style.cursor = "pointer";
                  addBtn.style.transition = "all 0.15s ease";
                  addBtn.onmouseover = () => {
                    addBtn.style.background = "rgba(99, 102, 241, 0.25)";
                    addBtn.style.borderColor = "rgba(99, 102, 241, 0.6)";
                  };
                  addBtn.onmouseout = () => {
                    addBtn.style.background = "rgba(99, 102, 241, 0.15)";
                    addBtn.style.borderColor = "rgba(99, 102, 241, 0.4)";
                  };
                  addBtn.onclick = async () => {
                    // Use current counterparty ID from card dataset (updated after creation)
                    // Convert to integer - dataset values are always strings
                    const currentCpId = cpCard.dataset.counterpartyId 
                      ? parseInt(cpCard.dataset.counterpartyId, 10) 
                      : (cpId ? parseInt(cpId, 10) : 0);
                    await addIndividualToDb(personName, personTitle, personLinkedIn, addBtn, {
                      job_title: personTitle,
                      counterparty_id: currentCpId,
                    });
                  };
                  btnGroup.appendChild(addBtn);
                  
                  // Assign to Counterparty button (links existing individual)
                  // Helper function to get current counterparty ID from card dataset
                  const getCurrentCpId = () => {
                    return cpCard.dataset.counterpartyId || cpId || null;
                  };
                  
                  const assignBtn = document.createElement("button");
                  assignBtn.textContent = "üîó Assign";
                  assignBtn.dataset.assignBtn = "true"; // Mark for easy selection
                  
                  // Update button appearance based on current counterparty ID
                  const updateAssignButtonStyle = () => {
                    const currentId = getCurrentCpId();
                    assignBtn.title = currentId 
                      ? "Assign existing individual to this counterparty" 
                      : "Add counterparty to DB first, then assign";
                    assignBtn.style.background = currentId ? "rgba(16, 185, 129, 0.15)" : "rgba(107, 114, 128, 0.15)";
                    assignBtn.style.color = currentId ? "#6ee7b7" : "#9ca3af";
                  };
                  
                  updateAssignButtonStyle(); // Initial styling
                  
                  assignBtn.style.padding = "4px 10px";
                  assignBtn.style.fontSize = "11px";
                  assignBtn.style.borderRadius = "6px";
                  assignBtn.style.border = "1px solid rgba(16, 185, 129, 0.4)";
                  assignBtn.style.cursor = "pointer";
                  assignBtn.style.transition = "all 0.15s ease";
                  assignBtn.onmouseover = () => {
                    const currentId = getCurrentCpId();
                    assignBtn.style.background = currentId ? "rgba(16, 185, 129, 0.25)" : "rgba(107, 114, 128, 0.25)";
                    assignBtn.style.borderColor = currentId ? "rgba(16, 185, 129, 0.6)" : "rgba(107, 114, 128, 0.6)";
                  };
                  assignBtn.onmouseout = () => {
                    updateAssignButtonStyle();
                    assignBtn.style.borderColor = "rgba(16, 185, 129, 0.4)";
                  };
                  assignBtn.onclick = async () => {
                    assignBtn.disabled = true;
                    assignBtn.textContent = "‚è≥";
                    
                    // Check if counterparty exists in DB - use card's dataset (updated after creation)
                    let counterpartyId = getCurrentCpId();
                    if (!counterpartyId) {
                      log("‚ö†Ô∏è Counterparty not in DB - add counterparty first", "warn");
                      assignBtn.textContent = "‚ùå Add CP first";
                      setTimeout(() => {
                        assignBtn.disabled = false;
                        assignBtn.textContent = "üîó Assign";
                      }, 2000);
                      return;
                    }
                    
                    // Build updates - prefer LinkedIn URL if available, otherwise use name
                    const updates = {};
                    if (personLinkedIn) {
                      updates.add_individual_by_linkedin = personLinkedIn;
                    } else if (personName && personName !== "Unknown") {
                      updates.add_individual_by_name = personName;
                    } else {
                      log("‚ùå No name or LinkedIn URL to assign individual", "err");
                      assignBtn.textContent = "‚ùå";
                      setTimeout(() => {
                        assignBtn.disabled = false;
                        assignBtn.textContent = "üîó Assign";
                      }, 2000);
                      return;
                    }
                    
                    await editCounterpartyInDb(counterpartyId, updates, assignBtn);
                    assignBtn.textContent = "üîó Assign";
                  };
                  btnGroup.appendChild(assignBtn);
                  
                  personRow.appendChild(btnGroup);
                  
                  pplSection.appendChild(personRow);
                });
                
                cpCard.appendChild(pplSection);
              }

              cpSection.appendChild(cpCard);
            });

            container.appendChild(cpSection);
          }

          // Advisors section for AI events - editable cards
          const advisors = ev.advisors || [];
          if (advisors.length) {
            const advisorSection = document.createElement("div");
            advisorSection.style.marginTop = "16px";

            const advisorHeader = document.createElement("div");
            advisorHeader.style.display = "flex";
            advisorHeader.style.alignItems = "center";
            advisorHeader.style.justifyContent = "space-between";
            advisorHeader.style.marginBottom = "12px";
            
            const advisorTitle = document.createElement("div");
            advisorTitle.style.fontSize = "13px";
            advisorTitle.style.fontWeight = "600";
            advisorTitle.style.color = "#e5e7eb";
            advisorTitle.textContent = `üéØ Advisors (${advisors.length})`;
            advisorHeader.appendChild(advisorTitle);
            advisorSection.appendChild(advisorHeader);

            advisors.forEach((adv, advIdx) => {
              const advId = adv.id || adv.advisor_id || null;
              const advName = adv.advisor_name || "Unknown Advisor";
              const advType = adv.advisor_type || "";
              const advisedParty = adv.advised_party || "";
              const advUrl = adv.announcement_url || "";

              const advCard = document.createElement("div");
              advCard.className = "counterparty-card";
              advCard.style.background = "rgba(251, 191, 36, 0.08)";
              advCard.style.borderColor = "rgba(251, 191, 36, 0.2)";
              // Store advisor ID on the card for dynamic updates
              advCard.dataset.advisorId = advId || "";

              // Header row with name and expand button
              const header = document.createElement("div");
              header.className = "counterparty-header";
              
              const nameSpan = document.createElement("span");
              nameSpan.className = "counterparty-name";
              nameSpan.textContent = advName;
              
              const typeSpan = document.createElement("span");
              typeSpan.className = "counterparty-role";
              typeSpan.textContent = advType || "Advisor";
              
              const headerLeft = document.createElement("div");
              headerLeft.style.display = "flex";
              headerLeft.style.alignItems = "center";
              headerLeft.style.gap = "10px";
              headerLeft.appendChild(nameSpan);
              headerLeft.appendChild(typeSpan);
              
              const expandBtn = document.createElement("button");
              expandBtn.className = "counterparty-expand-btn";
              expandBtn.textContent = "‚úèÔ∏è Edit";
              
              header.appendChild(headerLeft);
              header.appendChild(expandBtn);
              advCard.appendChild(header);

              // Quick links row
              if (advUrl) {
                const quickLinks = document.createElement("div");
                quickLinks.style.fontSize = "11px";
                quickLinks.style.marginBottom = "8px";
                const urlLink = document.createElement("a");
                urlLink.href = advUrl;
                urlLink.target = "_blank";
                urlLink.className = "source-link";
                urlLink.textContent = "üìÑ Announcement";
                quickLinks.appendChild(urlLink);
                advCard.appendChild(quickLinks);
              }

              // Expandable edit section
              const details = document.createElement("div");
              details.className = "counterparty-details";
              details.id = `adv_${idx}_${advIdx}_details`;

              // Advisor Name field
              const nameGroup = document.createElement("div");
              nameGroup.className = "form-group";
              const nameLabel = document.createElement("label");
              nameLabel.className = "form-label";
              nameLabel.textContent = "Advisor Name";
              const nameInput = document.createElement("input");
              nameInput.type = "text";
              nameInput.className = "form-input";
              nameInput.id = `adv_${idx}_${advIdx}_name`;
              nameInput.value = advName;
              nameGroup.appendChild(nameLabel);
              nameGroup.appendChild(nameInput);
              details.appendChild(nameGroup);

              // Advisor Type field
              const typeGroup = document.createElement("div");
              typeGroup.className = "form-group";
              const typeLabel = document.createElement("label");
              typeLabel.className = "form-label";
              typeLabel.textContent = "Advisor Type";
              const typeInput = document.createElement("input");
              typeInput.type = "text";
              typeInput.className = "form-input";
              typeInput.id = `adv_${idx}_${advIdx}_type`;
              typeInput.value = advType;
              typeInput.placeholder = "e.g., Financial Advisor, Legal Advisor";
              typeGroup.appendChild(typeLabel);
              typeGroup.appendChild(typeInput);
              details.appendChild(typeGroup);

              // Advised Party field
              const partyGroup = document.createElement("div");
              partyGroup.className = "form-group";
              const partyLabel = document.createElement("label");
              partyLabel.className = "form-label";
              partyLabel.textContent = "Advised Party";
              const partyInput = document.createElement("input");
              partyInput.type = "text";
              partyInput.className = "form-input";
              partyInput.id = `adv_${idx}_${advIdx}_party`;
              partyInput.value = advisedParty;
              partyInput.placeholder = "e.g., Target, Acquirer";
              partyGroup.appendChild(partyLabel);
              partyGroup.appendChild(partyInput);
              details.appendChild(partyGroup);

              // Announcement URL field
              const urlGroup = document.createElement("div");
              urlGroup.className = "form-group";
              const urlLabel = document.createElement("label");
              urlLabel.className = "form-label";
              urlLabel.textContent = "Announcement URL";
              const urlInput = document.createElement("input");
              urlInput.type = "url";
              urlInput.className = "form-input";
              urlInput.id = `adv_${idx}_${advIdx}_url`;
              urlInput.value = advUrl;
              urlInput.placeholder = "https://company.com/press/...";
              urlGroup.appendChild(urlLabel);
              urlGroup.appendChild(urlInput);
              details.appendChild(urlGroup);

              // Save button (if advisor exists in DB)
              if (advId) {
                const saveRow = document.createElement("div");
                saveRow.style.marginTop = "12px";
                saveRow.style.display = "flex";
                saveRow.style.justifyContent = "flex-end";
                
                const saveBtn = document.createElement("button");
                saveBtn.className = "save-btn";
                saveBtn.textContent = "üíæ Save Changes";
                saveBtn.onclick = async () => {
                  // TODO: Implement edit advisor API call when available
                  log("‚ö†Ô∏è Edit advisor API not yet implemented", "warn");
                };
                saveRow.appendChild(saveBtn);
                details.appendChild(saveRow);
              } else {
                const noteEl = document.createElement("div");
                noteEl.style.fontSize = "10px";
                noteEl.style.color = "#9ca3af";
                noteEl.style.marginTop = "12px";
                noteEl.style.fontStyle = "italic";
                noteEl.textContent = "‚ÑπÔ∏è Add event to DB first to enable editing";
                details.appendChild(noteEl);
              }

              advCard.appendChild(details);

              // Toggle expand
              expandBtn.onclick = () => {
                const isExpanded = details.classList.contains("expanded");
                details.classList.toggle("expanded");
                expandBtn.textContent = isExpanded ? "‚úèÔ∏è Edit" : "‚úñÔ∏è Close";
              };

              advisorSection.appendChild(advCard);
            });

            container.appendChild(advisorSection);
          }

          aiEventsEl.appendChild(container);
        });
      }

      function renderDBEvents(events) {
        dbEventsEl.innerHTML = "";
        if (!events || !events.length) {
          dbEventsEl.innerHTML =
            '<div class="empty-state">No events in database.</div>';
          dbMetaEl.textContent = "0 events";
          return;
        }
        dbMetaEl.textContent = `${events.length} event${
          events.length > 1 ? "s" : ""
        }`;

        events.forEach((ev) => {
          const card = document.createElement("div");
          card.className = "event-card";
          const desc = ev.description || "Unknown event";
          const ann = ev.announcement_date || "Unknown";
          const closed = ev.closed_date || "";
          const type = ev.deal_type || "Unknown";
          const status = ev.deal_status || "";
          const evDisplay = ev.ev_display || "";

          const metaPieces = [`üì¢ ${ann}`];
          if (closed) metaPieces.push(`‚úÖ ${closed}`);
          metaPieces.push(type);
          if (status) metaPieces.push(status);
          if (evDisplay) metaPieces.push(`üí∞ ${evDisplay}`);

          card.innerHTML = `
            <div class="event-title">${desc}</div>
            <div class="event-meta">
              ${metaPieces.map((m) => `<span>${m}</span>`).join("")}
            </div>
          `;

          // Long Description from DB (if available)
          const longDesc = ev.long_description || ev.description_long || "";
          if (longDesc) {
            const descBlock = document.createElement("div");
            descBlock.style.marginTop = "8px";
            descBlock.style.padding = "10px";
            descBlock.style.background = "rgba(16, 185, 129, 0.08)";
            descBlock.style.borderRadius = "8px";
            descBlock.style.border = "1px solid rgba(16, 185, 129, 0.2)";
            
            const descLabel = document.createElement("div");
            descLabel.style.fontSize = "10px";
            descLabel.style.color = "#6ee7b7";
            descLabel.style.marginBottom = "4px";
            descLabel.style.fontWeight = "600";
            descLabel.textContent = "üìù Long Description";
            descBlock.appendChild(descLabel);
            
            const descText = document.createElement("div");
            descText.style.fontSize = "12px";
            descText.style.color = "#e5e7eb";
            descText.style.lineHeight = "1.5";
            descText.textContent = longDesc;
            descBlock.appendChild(descText);
            
            card.appendChild(descBlock);
          }

          // Counterparties from DB: target + other buckets if present
          const cpContainer = document.createElement("div");
          cpContainer.style.marginTop = "6px";
          cpContainer.style.fontSize = "11px";

          const target = ev.target_company;

          const buckets = [
            "other_counterparties",
            "investors",
            "sellers",
            "buyers",
          ];
          
          // Build counterparty data with individuals
          const cpData = [];
          
          // Add target first if exists
          if (target && target.name) {
            cpData.push({
              name: target.name,
              role: "Target",
              url: target.counterparty_announcement_url || "",
              linkedin: target.linkedin_url || "",
              individuals: target.individuals || target._individuals || []
            });
          }
          
          buckets.forEach((key) => {
            const arr = ev[key] || [];
            arr.forEach((cp) => {
              cpData.push({
                name: cp.name || "Unknown",
                role: cp.counterparty_status || cp.role || key.replace("_", " "),
                url: cp.counterparty_announcement_url || "",
                linkedin: cp.linkedin_url || "",
                individuals: cp.individuals || cp._individuals || []
              });
            });
          });

          if (cpData.length) {
            const heading = document.createElement("div");
            heading.style.color = "#9ca3af";
            heading.style.marginBottom = "4px";
            heading.style.fontWeight = "600";
            heading.textContent = `Counterparties (${cpData.length})`;
            cpContainer.appendChild(heading);

            cpData.forEach((cp) => {
              const cpBlock = document.createElement("div");
              cpBlock.style.marginBottom = "6px";
              cpBlock.style.paddingLeft = "8px";
              cpBlock.style.borderLeft = "2px solid rgba(99, 102, 241, 0.3)";
              
              // Company line
              let cpHtml = `<strong>${cp.name}</strong>`;
              if (cp.role) {
                cpHtml += ` <span style="opacity:0.75;">(${cp.role})</span>`;
              }
              if (cp.url) {
                cpHtml += ` <a href="${cp.url}" target="_blank" class="source-link">[Announcement]</a>`;
              }
              if (cp.linkedin) {
                cpHtml += ` <a href="${cp.linkedin}" target="_blank" class="source-link">[LinkedIn]</a>`;
              }
              
              const cpLine = document.createElement("div");
              cpLine.innerHTML = cpHtml;
              cpBlock.appendChild(cpLine);
              
              // Individuals under this counterparty
              const individuals = cp.individuals || [];
              if (individuals.length) {
                const indContainer = document.createElement("div");
                indContainer.style.marginTop = "4px";
                indContainer.style.marginLeft = "12px";
                indContainer.style.padding = "4px 8px";
                indContainer.style.background = "rgba(16, 185, 129, 0.08)";
                indContainer.style.borderRadius = "4px";
                indContainer.style.border = "1px solid rgba(16, 185, 129, 0.2)";
                
                const indHeading = document.createElement("div");
                indHeading.style.fontSize = "10px";
                indHeading.style.color = "#10b981";
                indHeading.style.marginBottom = "2px";
                indHeading.textContent = `üë§ Individuals (${individuals.length})`;
                indContainer.appendChild(indHeading);
                
                individuals.forEach((ind) => {
                  const indName = ind.name || ind.individual_name || "Unknown";
                  const indTitle = ind.job_title || ind.title || ind.bio || "";
                  const indLinkedIn = ind.linkedin_url || ind.linkedin || "";
                  
                  const indRow = document.createElement("div");
                  indRow.style.fontSize = "10px";
                  indRow.style.color = "#6ee7b7";
                  indRow.style.marginLeft = "4px";
                  
                  let indHtml = `‚Ä¢ <strong>${indName}</strong>`;
                  if (indTitle) {
                    indHtml += ` <span style="opacity:0.7;">‚Äî ${indTitle}</span>`;
                  }
                  if (indLinkedIn) {
                    indHtml += ` <a href="${indLinkedIn}" target="_blank" class="source-link">[LinkedIn]</a>`;
                  }
                  
                  indRow.innerHTML = indHtml;
                  indContainer.appendChild(indRow);
                });
                
                cpBlock.appendChild(indContainer);
              }
              
              cpContainer.appendChild(cpBlock);
            });

            card.appendChild(cpContainer);
          }

          // Advisors section for DB events - editable cards
          const advisors = ev.advisors || [];
          if (advisors.length) {
            const advisorSection = document.createElement("div");
            advisorSection.style.marginTop = "16px";

            const advisorHeader = document.createElement("div");
            advisorHeader.style.display = "flex";
            advisorHeader.style.alignItems = "center";
            advisorHeader.style.justifyContent = "space-between";
            advisorHeader.style.marginBottom = "12px";
            
            const advisorTitle = document.createElement("div");
            advisorTitle.style.fontSize = "13px";
            advisorTitle.style.fontWeight = "600";
            advisorTitle.style.color = "#e5e7eb";
            advisorTitle.textContent = `üéØ Advisors (${advisors.length})`;
            advisorHeader.appendChild(advisorTitle);
            advisorSection.appendChild(advisorHeader);

            advisors.forEach((adv, advIdx) => {
              const advId = adv.id || adv.advisor_id || null;
              const advCompany = adv.advisor_company || {};
              const advName = advCompany.name || "Unknown Advisor";
              const advUrl = adv.announcement_url || "";

              const advCard = document.createElement("div");
              advCard.className = "counterparty-card";
              advCard.style.background = "rgba(251, 191, 36, 0.08)";
              advCard.style.borderColor = "rgba(251, 191, 36, 0.2)";
              // Store advisor ID on the card
              advCard.dataset.advisorId = advId || "";

              // Header row with name and expand button
              const header = document.createElement("div");
              header.className = "counterparty-header";
              
              const nameSpan = document.createElement("span");
              nameSpan.className = "counterparty-name";
              nameSpan.textContent = advName;
              
              const expandBtn = document.createElement("button");
              expandBtn.className = "counterparty-expand-btn";
              expandBtn.textContent = "‚úèÔ∏è Edit";
              
              header.appendChild(nameSpan);
              header.appendChild(expandBtn);
              advCard.appendChild(header);

              // Quick links row
              if (advUrl) {
                const quickLinks = document.createElement("div");
                quickLinks.style.fontSize = "11px";
                quickLinks.style.marginBottom = "8px";
                const urlLink = document.createElement("a");
                urlLink.href = advUrl;
                urlLink.target = "_blank";
                urlLink.className = "source-link";
                urlLink.textContent = "üìÑ Announcement";
                quickLinks.appendChild(urlLink);
                advCard.appendChild(quickLinks);
              }

              // Expandable edit section
              const details = document.createElement("div");
              details.className = "counterparty-details";
              details.id = `db_adv_${advIdx}_details`;

              // Advisor Name field
              const nameGroup = document.createElement("div");
              nameGroup.className = "form-group";
              const nameLabel = document.createElement("label");
              nameLabel.className = "form-label";
              nameLabel.textContent = "Advisor Name";
              const nameInput = document.createElement("input");
              nameInput.type = "text";
              nameInput.className = "form-input";
              nameInput.id = `db_adv_${advIdx}_name`;
              nameInput.value = advName;
              nameGroup.appendChild(nameLabel);
              nameGroup.appendChild(nameInput);
              details.appendChild(nameGroup);

              // Announcement URL field
              const urlGroup = document.createElement("div");
              urlGroup.className = "form-group";
              const urlLabel = document.createElement("label");
              urlLabel.className = "form-label";
              urlLabel.textContent = "Announcement URL";
              const urlInput = document.createElement("input");
              urlInput.type = "url";
              urlInput.className = "form-input";
              urlInput.id = `db_adv_${advIdx}_url`;
              urlInput.value = advUrl;
              urlInput.placeholder = "https://company.com/press/...";
              urlGroup.appendChild(urlLabel);
              urlGroup.appendChild(urlInput);
              details.appendChild(urlGroup);

              // Save button (if advisor exists in DB)
              if (advId) {
                const saveRow = document.createElement("div");
                saveRow.style.marginTop = "12px";
                saveRow.style.display = "flex";
                saveRow.style.justifyContent = "flex-end";
                
                const saveBtn = document.createElement("button");
                saveBtn.className = "save-btn";
                saveBtn.textContent = "üíæ Save Changes";
                saveBtn.onclick = async () => {
                  // TODO: Implement edit advisor API call when available
                  log("‚ö†Ô∏è Edit advisor API not yet implemented", "warn");
                };
                saveRow.appendChild(saveBtn);
                details.appendChild(saveRow);
              }

              advCard.appendChild(details);

              // Toggle expand
              expandBtn.onclick = () => {
                const isExpanded = details.classList.contains("expanded");
                details.classList.toggle("expanded");
                expandBtn.textContent = isExpanded ? "‚úèÔ∏è Edit" : "‚úñÔ∏è Close";
              };

              advisorSection.appendChild(advCard);
            });

            card.appendChild(advisorSection);
          }

          dbEventsEl.appendChild(card);
        });
      }

      // Create company in database (when company doesn't exist)
      async function createCompanyInDb(button) {
        button.disabled = true;
        button.innerHTML = "‚è≥ Creating‚Ä¶";
        log("Creating company in database...", "warn");

        try {
          // Get values from AI overview form
          const nameInput = document.getElementById("ai_name");
          const cityInput = document.getElementById("ai_city");
          const countryInput = document.getElementById("ai_country");
          const ownershipSelect = document.getElementById("ai_ownership");
          const websiteInput = document.getElementById("ai_website");
          const linkedinInput = document.getElementById("ai_linkedin");
          const descInput = document.getElementById("ai_description");

          const name = nameInput?.value?.trim() || "";
          const city = cityInput?.value?.trim() || "";
          const country = countryInput?.value?.trim() || "";
          const ownership = ownershipSelect?.value || "";
          const yearFoundedInput = document.getElementById("ai_year_founded");
          const webpageMonitoredInput = document.getElementById("ai_webpage_monitored");
          const businessFocusInput = document.getElementById("ai_primary_business_focus");
          const yearFounded = yearFoundedInput?.value?.trim() || "";
          const webpageMonitored = webpageMonitoredInput?.value?.trim() || "";
          const website = websiteInput?.value?.trim() || "";
          const linkedin = linkedinInput?.value?.trim() || "";
          const description = descInput?.value?.trim() || "";
          const businessFocusName = businessFocusInput?.value?.trim() || "";

          if (!name) {
            log("Error: Company name is required", "err");
            button.disabled = false;
            button.innerHTML = "‚ûï Create Company in Database";
            return;
          }

          // Step 1: Get location_id from city/country
          // Normalize country names before lookup
          const normalizedCountry = normalizeCountry(country);
          if (normalizedCountry !== country) {
            log(`üìç Normalized country: "${country}" ‚Üí "${normalizedCountry}"`, "info");
          }
          
          log(`Step 1: Getting location ID for ${city}, ${normalizedCountry}...`, "info");
          let locationId = 0;
          
          if (city || normalizedCountry) {
            try {
              const locUrl = `${XANO_BASE}/api:8Bv5PK4I/get_location?city=${encodeURIComponent(city)}&country=${encodeURIComponent(normalizedCountry)}`;
              log(`GET ${locUrl}`, "info");
              
              const locRes = await fetch(locUrl, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
              });
              
              const locData = await locRes.json();
              log(`Location response: ${JSON.stringify(locData)}`, "info");
              
              // Validate location ID is reasonable (max 292 as per user)
              const MAX_LOCATION_ID = 292;
              
              if (locData) {
                // Try all possible fields and use the first valid one (<= 292)
                let foundId = null;
                
                // Check direct id field
                if (locData.id && typeof locData.id === 'number' && locData.id <= MAX_LOCATION_ID) {
                  foundId = locData.id;
                  log(`‚úÖ Found valid location ID in 'id' field: ${foundId}`, "ok");
                }
                // Try locations_id field
                else if (locData.locations_id && typeof locData.locations_id === 'number' && locData.locations_id <= MAX_LOCATION_ID) {
                  foundId = locData.locations_id;
                  log(`‚úÖ Found valid location ID in 'locations_id' field: ${foundId}`, "ok");
                }
                // Try nested location.id
                else if (locData.location && locData.location.id && typeof locData.location.id === 'number' && locData.location.id <= MAX_LOCATION_ID) {
                  foundId = locData.location.id;
                  log(`‚úÖ Found valid location ID in 'location.id' field: ${foundId}`, "ok");
                }
                // Try _locations.id
                else if (locData._locations && locData._locations.id && typeof locData._locations.id === 'number' && locData._locations.id <= MAX_LOCATION_ID) {
                  foundId = locData._locations.id;
                  log(`‚úÖ Found valid location ID in '_locations.id' field: ${foundId}`, "ok");
                }
                
                if (foundId !== null) {
                  locationId = foundId;
                  log(`‚úÖ Using location ID: ${locationId}`, "ok");
                } else {
                  // Log all ID values found (even if invalid) for debugging
                  const allIds = [];
                  if (locData.id) allIds.push(`id: ${locData.id}`);
                  if (locData.locations_id) allIds.push(`locations_id: ${locData.locations_id}`);
                  if (locData.location?.id) allIds.push(`location.id: ${locData.location.id}`);
                  if (locData._locations?.id) allIds.push(`_locations.id: ${locData._locations.id}`);
                  
                  log(`‚ö†Ô∏è No valid location ID found (max: ${MAX_LOCATION_ID}). Found: ${allIds.join(", ")}`, "warn");
                  log(`‚ö†Ô∏è Full response: ${JSON.stringify(locData)}`, "warn");
                  log("‚ö†Ô∏è Using 0 for locations_id", "warn");
                }
              } else {
                log("‚ö†Ô∏è No location data in response, using 0", "warn");
              }
            } catch (locErr) {
              log(`‚ö†Ô∏è Location lookup failed: ${locErr.message}`, "warn");
            }
          }

          // Step 2: Lookup primary business focus ID
          log(`Step 2: Looking up primary business focus...`, "info");
          let businessFocusId = 0;
          if (businessFocusName) {
            try {
              const focusUrl = `${XANO_BASE}/api:8Bv5PK4I/business_focus_lookup?business_focus_title=${encodeURIComponent(businessFocusName)}`;
              log(`GET ${focusUrl}`, "info");
              
              const focusRes = await fetch(focusUrl, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
              });
              
              const focusData = await focusRes.json();
              if (focusData && focusData.id) {
                businessFocusId = focusData.id;
                log(`‚úÖ Found business focus ID: ${businessFocusId}`, "ok");
              } else {
                log(`‚ö†Ô∏è No ID found for business focus: ${businessFocusName}`, "warn");
              }
            } catch (focusErr) {
              log(`‚ö†Ô∏è Business focus lookup failed: ${focusErr.message}`, "warn");
            }
          }

          // Step 3: Lookup sector IDs
          log(`Step 3: Looking up sector IDs...`, "info");
          const sectorIds = [];
          // Get sectors from AI overview data (stored in window or from current data)
          const aiSectors = window._aiOverviewData?.sectors || [];
          if (aiSectors && aiSectors.length > 0) {
            for (const sector of aiSectors) {
              const sectorName = sector.sector || sector.name || "";
              if (!sectorName) continue;
              
              try {
                const sectorUrl = `${XANO_BASE}/api:8Bv5PK4I/sectors_lookup?sector_name=${encodeURIComponent(sectorName)}`;
                log(`Looking up sector: ${sectorName}...`, "info");
                
                const sectorRes = await fetch(sectorUrl, {
                  method: "GET",
                  headers: { "Content-Type": "application/json" },
                });
                
                if (sectorRes.ok) {
                  const sectorData = await sectorRes.json();
                  if (sectorData && sectorData.id) {
                    sectorIds.push(sectorData.id);
                    log(`‚úÖ Found sector ID ${sectorData.id} for "${sectorName}"`, "ok");
                  } else {
                    log(`‚ö†Ô∏è No ID found for sector: ${sectorName}`, "warn");
                  }
                } else {
                  log(`‚ö†Ô∏è Lookup failed for sector: ${sectorName}`, "warn");
                }
              } catch (sectorErr) {
                log(`‚ö†Ô∏è Error looking up sector "${sectorName}": ${sectorErr.message}`, "warn");
              }
            }
          }

          // Step 3.5: Lookup year ID
          log(`Step 3.5: Looking up year ID...`, "info");
          let yearId = 0;
          if (yearFounded) {
            try {
              const yearUrl = `${XANO_BASE}/api:8Bv5PK4I/years_lookup?year=${encodeURIComponent(yearFounded)}`;
              log(`GET ${yearUrl}`, "info");

              const yearRes = await fetch(yearUrl, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
              });

              if (yearRes.ok) {
                const yearData = await yearRes.json();
                if (yearData && yearData.id) {
                  yearId = yearData.id;
                  log(`‚úÖ Found year ID: ${yearId} for "${yearFounded}"`, "ok");
                } else {
                  log(`‚ö†Ô∏è Year not found in lookup: ${yearFounded}`, "warn");
                }
              } else {
                log(`‚ö†Ô∏è Year lookup failed for: ${yearFounded}`, "warn");
              }
            } catch (yearErr) {
              log(`‚ö†Ô∏è Year lookup error: ${yearErr.message}`, "warn");
            }
          }

          // Step 4: Create company with POST
          log(`Step 4: Creating company "${name}"...`, "info");
          
          // Map ownership text to ownership_type_id
          const ownershipTypeId = getOwnershipTypeId(ownership);
          if (ownership && !ownershipTypeId) {
            log(`‚ö†Ô∏è Warning: Unknown ownership type "${ownership}", using 0`, "warn");
          } else if (ownership) {
            log(`‚úÖ Mapped ownership "${ownership}" to ownership_type_id: ${ownershipTypeId}`, "ok");
          }
          
          // Final validation: ensure locationId is the value we got from lookup
          const finalLocationId = locationId > 0 ? parseInt(locationId, 10) : 0;
          log(`üìã Final locations_id value for payload: ${finalLocationId} (from lookup: ${locationId})`, "info");
          
          const payload = {
            name: name,
            website: website,
            linkedin: linkedin,
            description: description,
            new_company_id: 0,  // Will be assigned by Xano
            locations_id: finalLocationId,  // Use the validated value
            ownership_type_id: parseInt(ownershipTypeId, 10) || 0,
          };
          
          // Log locations_id to help debug
          if (finalLocationId > 0) {
            log(`‚úÖ Including locations_id: ${finalLocationId}`, "ok");
          } else {
            log(`‚ö†Ô∏è locations_id is 0 (lookup returned: ${locationId})`, "warn");
          }
          
          // Add optional fields
          if (ownership) {
            payload.ownership = ownership;  // Text field (also accepted by API)
          }
          // Send year_founded as ID (like locations_id)
          if (yearId > 0) {
            payload.year_founded = yearId;
            log(`‚úÖ Including year_founded: ${yearId}`, "ok");
          } else if (yearFounded) {
            log(`‚ö†Ô∏è Year lookup failed, skipping year_founded`, "warn");
          }
          if (webpageMonitored) {
            payload.webpage_monitored = webpageMonitored;
          }
          
          // Add primary_business_focus_id as array if found
          if (businessFocusId > 0) {
            payload.primary_business_focus_id = [businessFocusId];
            log(`‚úÖ Including primary_business_focus_id: [${businessFocusId}]`, "ok");
          }
          
          // Add sectors_id as array if found
          if (sectorIds.length > 0) {
            payload.sectors_id = sectorIds;
            log(`‚úÖ Including sectors_id: [${sectorIds.join(", ")}]`, "ok");
          }
          
          log(`POST ${XANO_BASE}/api:8Bv5PK4I/post_company_overview`, "info");
          log(`Payload: ${JSON.stringify(payload)}`, "info");

          const res = await fetch(`${XANO_BASE}/api:8Bv5PK4I/post_company_overview`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const responseText = await res.text();
          log(`Response status: ${res.status}`, res.ok ? "ok" : "err");
          log(`Response: ${responseText}`, res.ok ? "ok" : "err");

          if (res.ok) {
            button.innerHTML = "‚úÖ Created!";
            button.style.background = "rgba(16, 185, 129, 0.3)";
            button.style.borderColor = "rgba(16, 185, 129, 0.6)";
            log(`‚úÖ Company "${name}" created successfully!`, "ok");
            
            // Parse response to get new company ID if available
            try {
              const resData = JSON.parse(responseText);
              if (resData.id || resData.new_company_id) {
                const newId = resData.id || resData.new_company_id;
                log(`New company ID: ${newId}`, "ok");
                
                // CRITICAL: Save the company ID for use in other API calls
                window._companyId = newId;
                window._dbCompanyId = newId;
                log(`‚úÖ Saved company_id: ${newId} to window._companyId and window._dbCompanyId`, "ok");
                
                // Update the Xano status badge
                updateXanoStatus({ id: newId }, { name: name });
                
                // Update the DB meta to show the new company ID
                dbMetaEl.textContent = `Company ID ${newId}`;
                
                // Refresh Xano data ONLY after we have the company_id
                // This ensures we use the correct ID in the refresh call
                await refreshXanoData();
              } else {
                log("‚ö†Ô∏è Warning: Response did not include company ID - skipping refresh", "warn");
              }
            } catch (e) {
              log(`‚ö†Ô∏è Warning: Could not parse response JSON: ${e.message}`, "warn");
            }
            
            // Hide the create button after success
            setTimeout(() => {
              const container = document.getElementById("createInDbContainer");
              if (container) container.style.display = "none";
            }, 2000);
          } else {
            button.innerHTML = "‚ùå Failed";
            button.style.background = "rgba(239, 68, 68, 0.2)";
            button.style.borderColor = "rgba(239, 68, 68, 0.5)";
            button.style.color = "#fca5a5";
            log(`‚ùå Failed to create company: ${responseText}`, "err");
            
            // Re-enable button after delay
            setTimeout(() => {
              button.disabled = false;
              button.innerHTML = "‚ûï Create Company in Database";
              button.style.background = "rgba(16, 185, 129, 0.15)";
              button.style.borderColor = "rgba(16, 185, 129, 0.4)";
              button.style.color = "#6ee7b7";
            }, 3000);
          }
        } catch (err) {
          log(`‚ùå Error creating company: ${err.message}`, "err");
          button.disabled = false;
          button.innerHTML = "‚ûï Create Company in Database";
          button.style.background = "rgba(16, 185, 129, 0.15)";
          button.style.borderColor = "rgba(16, 185, 129, 0.4)";
          button.style.color = "#6ee7b7";
        }
      }

      // Add individual to database
      async function addIndividualToDb(name, jobTitleOrBio, linkedinUrl, button, options = {}) {
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = "‚è≥";
        log(`Adding individual "${name}" to database...`, "warn");

        try {
          // Step 1: Get location_id - prioritize individual's location, fallback to company location
          let locationId = 0;
          let locationText = options.location_text || "";
          
          // Try individual's location first (if provided in options.location_text)
          if (locationText) {
            // Parse location_text (format: "City, Country" or "City, State, Country")
            const parts = locationText.split(",").map(p => p.trim()).filter(Boolean);
            if (parts.length >= 2) {
              // Assume last part is country, rest is city/state
              const rawCountry = parts[parts.length - 1];
              const country = normalizeCountry(rawCountry);
              const city = parts.slice(0, -1).join(", ");
              if (country !== rawCountry) {
                log(`üìç Normalized individual country: "${rawCountry}" ‚Üí "${country}"`, "info");
              }
              locationId = await window.lookupLocation(city, country);
            } else if (parts.length === 1) {
              // Single value - try as city, then as country (normalize if used as country)
              locationId = await window.lookupLocation(parts[0], "");
              if (!locationId) {
                const normalizedSingleValue = normalizeCountry(parts[0]);
                if (normalizedSingleValue !== parts[0]) {
                  log(`üìç Normalized individual location: "${parts[0]}" ‚Üí "${normalizedSingleValue}"`, "info");
                }
                locationId = await window.lookupLocation("", normalizedSingleValue);
              }
            }
          }
          
          // Fallback to company location if individual location didn't work
          if (!locationId) {
            const cityInput = document.getElementById("ai_city");
            const countryInput = document.getElementById("ai_country");
            const city = cityInput?.value?.trim() || "";
            const country = countryInput?.value?.trim() || "";
            
            if (city || country) {
              if (!locationText) {
                locationText = [city, country].filter(Boolean).join(", ");
              }
              locationId = await window.lookupLocation(city, country);
            }
          }

          // Step 2: Lookup job title IDs (can be multiple for compound titles)
          log(`Step 2: Looking up job titles...`, "info");
          let jobTitleIds = [];
          const jobTitleText = options.job_title || jobTitleOrBio || "";

          if (jobTitleText) {
            jobTitleIds = await window.lookupJobTitles(jobTitleText);
          }

          // Step 3: POST individual using create_individual endpoint
          const companyId = options.company_id || window._companyId || 0;
          
          if (!companyId) {
            log("‚ö†Ô∏è Warning: No company_id available. Individual will not be linked to company. Make sure company exists in DB first.", "warn");
          }
          
          // Ensure all ID fields are integers
          const payload = {
            name: name || "",
            status: options.status || "Current",
            location_text: options.location_text || locationText || "",
            bio: options.bio || "",
            linkedin_url: linkedinUrl || "",
            current_employee_url: options.current_employee_url || "",
            company_id: parseInt(companyId, 10) || 0,
            counterparty_id: parseInt(options.counterparty_id, 10) || 0,
            advisor_id: parseInt(options.advisor_id, 10) || 0,
            linkedin_URL: linkedinUrl || "",  // API accepts both formats
            location_id: parseInt(locationId, 10) || 0,
          };

          // Add job_title_ids if found (array, can be multiple)
          if (jobTitleIds.length > 0) {
            payload.job_title_ids = jobTitleIds;
            log(`‚úÖ Including job_title_ids: [${jobTitleIds.join(", ")}]`, "ok");
          } else if (jobTitleText) {
            log(`‚ö†Ô∏è Job titles "${jobTitleText}" not found in database - will save without IDs`, "warn");
          }

          log(`Using company_id: ${companyId} (window._companyId: ${window._companyId})`, "info");
          log(`POST ${XANO_BASE}/api:8Bv5PK4I/create_individual`, "info");
          log(`Payload: ${JSON.stringify(payload)}`, "info");

          const res = await fetch(`${XANO_BASE}/api:8Bv5PK4I/create_individual`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const responseText = await res.text();
          log(`Response status: ${res.status}`, res.ok ? "ok" : "err");
          log(`Response: ${responseText}`, res.ok ? "ok" : "err");

          if (res.ok) {
            button.textContent = "‚úÖ";
            button.style.background = "rgba(16, 185, 129, 0.3)";
            button.style.borderColor = "rgba(16, 185, 129, 0.6)";
            button.style.color = "#6ee7b7";
            log(`‚úÖ Individual "${name}" added successfully!`, "ok");
            
            // Refresh Xano data to show the newly created individual
            await refreshXanoData();
            
            // Keep button disabled after success
          } else {
            button.textContent = "‚ùå";
            button.style.background = "rgba(239, 68, 68, 0.2)";
            button.style.borderColor = "rgba(239, 68, 68, 0.5)";
            button.style.color = "#fca5a5";
            log(`‚ùå Failed to add individual: ${responseText}`, "err");
            
            // Re-enable button after delay
            setTimeout(() => {
              button.disabled = false;
              button.textContent = originalText;
              button.style.background = "rgba(99, 102, 241, 0.15)";
              button.style.borderColor = "rgba(99, 102, 241, 0.4)";
              button.style.color = "#a5b4fc";
            }, 3000);
          }
        } catch (err) {
          log(`‚ùå Error adding individual: ${err.message}`, "err");
          button.disabled = false;
          button.textContent = originalText;
          button.style.background = "rgba(99, 102, 241, 0.15)";
          button.style.borderColor = "rgba(99, 102, 241, 0.4)";
          button.style.color = "#a5b4fc";
        }
      }

      async function addEventToDb(eventObj, idx, button) {
        button.disabled = true;
        button.textContent = "‚è≥ Sending‚Ä¶";
        log(
          `Sending AI event #${idx + 1} to Xano /create_corporate_event‚Ä¶`,
          "warn"
        );

        // Prefer edited values from inputs; fall back to original AI object
        const titleInput = document.getElementById(`ev_${idx}_title`);
        const annInput = document.getElementById(`ev_${idx}_ann`);
        const closedInput = document.getElementById(`ev_${idx}_closed`);
        const typeSelect = document.getElementById(`ev_${idx}_type`);
        const statusSelect = document.getElementById(`ev_${idx}_status`);
        const sourceInput = document.getElementById(`ev_${idx}_source`);
        const longDescInput = document.getElementById(`ev_${idx}_longdesc`);

        const description =
          (titleInput && titleInput.value.trim()) ||
          eventObj["Event (short)"] ||
          eventObj.event_short ||
          "";
        const longDescription =
          (longDescInput && longDescInput.value.trim()) ||
          eventObj.Description ||
          eventObj.description ||
          eventObj.long_description ||
          "";
        const annDate =
          (annInput && annInput.value.trim()) ||
          eventObj["Announcement Date"] ||
          eventObj.announcement_date ||
          "";
        const closedDate =
          (closedInput && closedInput.value.trim()) ||
          eventObj["Closed Date"] ||
          eventObj.closed_date ||
          "";
        const dealType =
          (typeSelect && typeSelect.value) ||
          eventObj["Deal Type"] ||
          eventObj.deal_type ||
          eventObj["Event type"] ||
          eventObj.event_type ||
          "Acquisition";
        const dealStatus =
          (statusSelect && statusSelect.value) ||
          eventObj["Deal Status"] ||
          eventObj.deal_status ||
          "Completed";
        const sourceUrl =
          (sourceInput && sourceInput.value.trim()) ||
          eventObj["Source URL"] ||
          eventObj.source_url ||
          "";

        // New simplified payload for create_corporate_event
        const companyId = window._companyId || 0;
        
        if (!companyId) {
          log("‚ö†Ô∏è Warning: No company_id available. Event will not be linked to company. Make sure company exists in DB first.", "warn");
        }
        
        const payload = {
          description: description || "Untitled Event",
          long_description: longDescription || "",
          announcement_date: annDate || "",
          closed_date: closedDate || "",
          deal_type: dealType,
          deal_status: dealStatus,
          source_url: sourceUrl || "",
          company_id: companyId,  // Link event to the company
        };

        const endpoint = `${XANO_BASE}/api:8Bv5PK4I/create_corporate_event`;
        log(`Using company_id: ${companyId} (window._companyId: ${window._companyId})`, "info");
        log(`POST ${endpoint}`, "info");
        log(`Payload: ${JSON.stringify(payload)}`, "info");

        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const text = await res.text();
          log(`HTTP ${res.status}: ${text.slice(0, 300)}`, "info");
          let parsed;
          try {
            parsed = JSON.parse(text);
          } catch (e) {}

          if (res.ok || (parsed && (parsed.success || parsed.id || parsed.event_id))) {
            button.textContent = "‚úÖ Added";
            button.style.background = "linear-gradient(135deg,#22c55e,#16a34a)";
            const eventId = parsed?.id || parsed?.event_id || "unknown";
            log(`‚úÖ Success: event created (ID: ${eventId})`, "ok");
            
            // Store event ID for future operations
            if (parsed?.id || parsed?.event_id) {
              button.dataset.eventId = parsed.id || parsed.event_id;
            }
            
            // Refresh Xano data to show the newly created event
            await refreshXanoData();
          } else {
            button.textContent = "‚ùå Failed";
            button.style.background =
              "linear-gradient(135deg,#ef4444,#b91c1c)";
            log(
              `‚ùå Xano error: ${
                parsed ? JSON.stringify(parsed) : text || "Unknown error"
              }`,
              "err"
            );
            setTimeout(() => {
              button.disabled = false;
              button.textContent = "üöÄ Retry";
              button.style.background =
                "linear-gradient(135deg,#6366f1,#8b5cf6)";
            }, 3500);
          }
        } catch (err) {
          log(`‚ùå Fetch error: ${err.message}`, "err");
          button.textContent = "‚ùå Error";
          button.style.background =
            "linear-gradient(135deg,#ef4444,#b91c1c)";
          setTimeout(() => {
            button.disabled = false;
            button.textContent = "üöÄ Retry";
            button.style.background =
              "linear-gradient(135deg,#6366f1,#8b5cf6)";
          }, 3500);
        }
      }

      // Refresh Xano data after POST/PATCH operations (only DB data, no AI re-analysis)
      async function refreshXanoData() {
        const companyId = window._dbCompanyId;
        if (!companyId) {
          log("‚ö†Ô∏è No company ID available for refresh", "warn");
          return;
        }

        log(`üîÑ Refreshing Xano data for company ID ${companyId}...`, "info");

        try {
          let json;

          if (companyId) {
            // Use the specific Xano API endpoint for fresh company data
            const xanoUrl = `https://xdil-abvj-o7rq.e2.xano.io/api:8Bv5PK4I/Get_new_company/${companyId}`;
            log(`üì° Calling Xano API: ${xanoUrl}`, "info");

            const res = await fetch(xanoUrl);

            if (!res.ok) {
              const errorText = await res.text();
              log(`‚ö†Ô∏è Xano API error: ${errorText}`, "warn");
              // Fall back to the /refresh_db endpoint
              const query = queryInput.value.trim();
              if (!query) {
                log("‚ö†Ô∏è No query available for fallback refresh", "warn");
                return;
              }

              const fallbackRes = await fetch("/refresh_db", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query }),
              });

              if (!fallbackRes.ok) {
                const errorText = await fallbackRes.text();
                log(`‚ö†Ô∏è Fallback refresh error: ${errorText}`, "warn");
                return;
              }

              json = await fallbackRes.json();
            } else {
              // Parse the direct Xano response
              const xanoData = await res.json();
              log(`üìÑ Xano API returned ${JSON.stringify(xanoData).length} chars`, "info");

              // Transform the Xano response to match our expected format
              const companyInfo = xanoData.Company || xanoData;

              // Extract db_overview from the company data
              const db_overview = extractDBOverviewFromCompany(companyInfo);

              // Extract management roles
              const db_management = extractDBManagementFromCompany(companyInfo);

              // Extract events (counterparties)
              const db_events = extractDBEventsFromCompany(companyInfo);

              // Create the expected response structure
              json = {
                existing_company: {
                  id: companyId,
                  name: companyInfo.name || "",
                  url: companyInfo.url || "",
                  // Add other fields as needed
                },
                db_company: xanoData,
                db_overview,
                db_events,
                db_management,
              };
            }
          } else {
            // Fallback to /refresh_db if no company ID
            const query = queryInput.value.trim();
            if (!query) {
              log("‚ö†Ô∏è No query available for refresh", "warn");
              return;
            }

            const res = await fetch("/refresh_db", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ query }),
            });

            if (!res.ok) {
              const errorText = await res.text();
              log(`‚ö†Ô∏è Refresh error: ${errorText}`, "warn");
              return;
            }

            json = await res.json();
          }

          const {
            existing_company,
            db_company,
            db_overview,
            db_events,
            db_management,
          } = json;

          // Update the prominent Xano status badge
          if (existing_company) {
            updateXanoStatus(existing_company, db_company);
          }

          if (existing_company && existing_company.id) {
            window._dbCompanyId = existing_company.id;
            window._companyId = existing_company.id;
            dbMetaEl.textContent = `Company ID ${existing_company.id}`;
          }

          // Re-render ONLY DB sections with fresh data (don't touch AI sections)
          if (db_overview) {
            renderDBOverview(db_overview);
          }
          if (db_management) {
            renderDBManagement(db_management);
          }
          if (db_events) {
            renderDBEvents(db_events);
          }

          log("‚úÖ Xano data refreshed", "ok");
        } catch (err) {
          log(`‚ö†Ô∏è Refresh error: ${err.message}`, "warn");
        }
      }

      // Helper function to extract db_overview from company data
      function extractDBOverviewFromCompany(companyInfo) {
        try {
          const name = companyInfo.name || "";
          const loc = companyInfo._locations || {};
          const city = loc.City || "";
          const country = loc.Country || "";
          const ownership_block = companyInfo._ownership_type || {};
          const ownership = ownership_block.ownership || "";
          const linkedin_block = companyInfo.linkedin_data || {};
          const linkedin = linkedin_block.LinkedIn_URL || "";
          const website = companyInfo.url || "";
          const desc = companyInfo.description || "";

          // Year founded - check _years.Year first (proper structure), fallback to year_founded
          const years_block = companyInfo._years || {};
          let year_founded = "";
          if (years_block && years_block.Year) {
            year_founded = String(years_block.Year);
          } else {
            // Fallback to direct year_founded field (but ignore if it's just a reference ID like 10)
            const year_founded_raw = companyInfo.year_founded;
            if (year_founded_raw && typeof year_founded_raw === 'number' && year_founded_raw > 1000) {
              year_founded = String(year_founded_raw);
            }
          }

          // Primary business focus
          const business_focus_block = companyInfo.primary_business_focus_id || companyInfo._primary_business_focus || {};
          let primary_business_focus = "";
          let primary_business_focus_id = 0;
          if (typeof business_focus_block === 'object' && business_focus_block !== null) {
            primary_business_focus = business_focus_block.business_focus || business_focus_block.primary_business_focus || business_focus_block.name || "";
            primary_business_focus_id = business_focus_block.id || 0;
          }

          // Sectors
          const sectors = [];
          const new_sectors_data = companyInfo.new_sectors_data || [];
          if (Array.isArray(new_sectors_data) && new_sectors_data.length > 0) {
            try {
              const sectors_payload = new_sectors_data[0].sectors_payload;
              if (sectors_payload) {
                const parsed_sectors = JSON.parse(sectors_payload);
                // Add primary sectors
                (parsed_sectors.primary_sectors || []).forEach(s => {
                  if (s.sector_name) {
                    sectors.push({
                      sector: s.sector_name,
                      id: s.id || 0,
                      importance: "Primary"
                    });
                  }
                });
                // Add secondary sectors
                (parsed_sectors.secondary_sectors || []).forEach(s => {
                  if (s.sector_name) {
                    sectors.push({
                      sector: s.sector_name,
                      id: s.id || 0,
                      importance: "Secondary"
                    });
                  }
                });
              }
            } catch (e) {
              console.log("Error parsing sectors:", e);
            }
          }

          // Webpage monitored (press/news page URL)
          const webpage_monitored = companyInfo.webpage_monitored || companyInfo.press_page_url || "";

          return {
            name,
            city,
            country,
            ownership,
            website,
            linkedin,
            description: desc,
            year_founded,
            primary_business_focus,
            primary_business_focus_id,
            sectors,
            webpage_monitored,
          };
        } catch (e) {
          console.log("Error extracting db_overview:", e);
          return null;
        }
      }

      // Helper function to extract db_management from company data
      function extractDBManagementFromCompany(companyInfo) {
        const db_management = [];

        try {
          // Current management roles
          const mgmt_current = companyInfo.Management_Roles_current || [];
          mgmt_current.forEach(role => {
            const job_titles = [];
            const job_titles_id = role.job_titles_id || [];
            if (Array.isArray(job_titles_id)) {
              job_titles_id.forEach(jt => {
                if (typeof jt === 'object' && jt.job_title) {
                  job_titles.push(jt.job_title);
                }
              });
            }

            db_management.push({
              Individual_text: role.Individual_text || "",
              name: role.Individual_text || role.advisor_individuals || "",
              position: job_titles.join(", "),
              job_titles_id,
              Status: role.Status || "Current",
              linkedin_url: "",
              current_employee_url: role.current_employer_url || "",
              individuals_id: role.individuals_id || 0,
              role_id: role.id || 0,
            });
          });

          // Past management roles
          const mgmt_past = companyInfo.Management_Roles_past || [];
          mgmt_past.forEach(role => {
            const job_titles = [];
            const job_titles_id = role.job_titles_id || [];
            if (Array.isArray(job_titles_id)) {
              job_titles_id.forEach(jt => {
                if (typeof jt === 'object' && jt.job_title) {
                  job_titles.push(jt.job_title);
                }
              });
            }

            db_management.push({
              Individual_text: role.Individual_text || "",
              name: role.Individual_text || role.advisor_individuals || "",
              position: job_titles.join(", "),
              job_titles_id,
              Status: role.Status || "Past",
              linkedin_url: "",
              current_employee_url: role.current_employer_url || "",
              individuals_id: role.individuals_id || 0,
              role_id: role.id || 0,
            });
          });
        } catch (e) {
          console.log("Error extracting db_management:", e);
        }

        return db_management;
      }

      // Helper function to extract db_events from company data
      function extractDBEventsFromCompany(companyInfo) {
        const db_events = [];

        try {
          const new_counterparties = companyInfo.new_counterparties || [];
          new_counterparties.forEach(cp => {
            db_events.push({
              id: cp.id,
              announcement_date: cp.announcement_date || "",
              deal_type: cp.deal_type || "",
              description: cp.description || "",
              investment_display: cp.investment_display || "",
              ev_display: cp.ev_display || "",
              this_company_status: cp.this_company_status || "",
              counterparties: [], // We can populate this if needed
            });
          });
        } catch (e) {
          console.log("Error extracting db_events:", e);
        }

        return db_events;
      }

      async function runAnalyze() {
        const query = queryInput.value.trim();
        if (!query) {
          alert("Please enter a company URL or name.");
          return;
        }

        clearEvents();
        resetXanoStatus();  // Hide the status badge while loading
        aiMetaEl.textContent = "Loading‚Ä¶";
        dbMetaEl.textContent = "Loading‚Ä¶";
        logEl.innerHTML = "";
        setStatus("Analyzing‚Ä¶", "info");
        log(`Starting analysis for: "${query}"`, "info");

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = "‚è≥ Analyzing‚Ä¶";

        try {
          const res = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
          });

          const json = await res.json();
          if (!res.ok) {
            log(`Backend error: ${JSON.stringify(json)}`, "err");
            setStatus("Error", "err");
            aiEventsEl.innerHTML =
              '<div class="empty-state">Backend error ‚Äì check logs.</div>';
            dbEventsEl.innerHTML =
              '<div class="empty-state">No DB data.</div>';
            return;
          }

          const {
            existing_company,
            db_company,
            db_overview,
            ai_overview,
            db_events,
            ai_events,
            missing_events,
            matched_events,
          } = json;

          // Update the prominent Xano status badge
          updateXanoStatus(existing_company, db_company);

          if (existing_company && existing_company.id) {
            window._dbCompanyId = existing_company.id;  // Store for save operations
            window._companyId = existing_company.id;    // Store for individual creation
            dbMetaEl.textContent = `Company ID ${existing_company.id}`;
            log(
              `Company exists in DB (id=${existing_company.id}). Events: ${
                (db_events || []).length
              }`,
              "ok"
            );
          } else {
            window._dbCompanyId = null;  // Clear company ID
            window._companyId = null;    // Clear for individual creation
            dbMetaEl.textContent = "Company not found in DB";
            log("Company not found in DB ‚Äì AI-only mode.", "warn");
          }

          renderAIOverview(ai_overview || null);
          renderDBOverview(db_overview || null);
          renderTopManagement(json.top_management || []);
          renderDBManagement(json.db_management || []);
          renderAIEvents(ai_events || [], missing_events || []);
          renderDBEvents(db_events || []);

          const aiCount = (ai_events || []).length;
          const dbCount = (db_events || []).length;
          const mgmtCount = (json.top_management || []).length;
          const dbMgmtCount = (json.db_management || []).length;
          log(
            `AI events: ${aiCount}, DB events: ${dbCount}, matched: ${
              (matched_events || []).length
            }, missing: ${(missing_events || []).length}, AI people: ${mgmtCount}, DB people: ${dbMgmtCount}`,
            "ok"
          );
          setStatus("Done", "ok");
        } catch (err) {
          log(`Fetch /analyze error: ${err.message}`, "err");
          setStatus("Error", "err");
        } finally {
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = "üöÄ Analyze";
        }
      }

      analyzeBtn.addEventListener("click", runAnalyze);
      queryInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          runAnalyze();
        }
      });
    </script>
  </body>
</html>


